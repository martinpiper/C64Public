;main test code

; GameSpriteWorldInit - The second part of the demo with player control and sprites flying towards the player

kAPUNumFloorRows = 240 - 128

kBus24Bit_VideoLayer_HasOverscan=1
; Define this to display the static logo
;kJustForLogo = 1
;kJustForLogoMonchrome = 1

;kSkipToFrameThenWaitForFire = 752

; Includes music data
MusicData = 1
; Minimal music demo test with joystick directions to play samples in each voice, with optional fire to loop.
;MinimalMusicDemoTest = 1
;MinimalSprites2Test = 1
; Includes sample data decompression in parts
;IncludeMusicDataDecomp = 1
;IncludeMusicDataDecomp1 = 1
;IncludeMusicDataDecomp2 = 1
; Enable this to send graphics data from code and remove the demo code
;IncludeGraphicsData = 1
;; Include various graphics data in the build
;IncludeGraphicsData_L1 = 1
;IncludeGraphicsData_L2a = 1
;IncludeGraphicsData_L2b = 1
;IncludeGraphicsData_L3 = 1
;IncludeGraphicsData_L4 = 1

!source "stdlib/stdlib.a"
!source "stdlib/PETSCII.a"
!source "BombJack/stdlib/Bus24Bit_Macros.a"
!source "BombJack/stdlib/Video_Macros.a"
!source "BombJack/stdlib/APU_Macros.a"

CartSelectBank_ProcessorPort	= ProcessorPortDefault
CartKillBank_ProcessorPort		= ProcessorPortAllRAMWithIO
!source "../MakeCart/asm/EasyFlash_Macros.a"

!to "bin/main.prg", cbm
!sal
!sl "tmp/main.map"
!svl "tmp/main.lbl"
!pdb "tmp/main.pdb"
!cpu 6510
!ct pet

; Music.a uses the start of zeropage, yes shoot me
zeroPage_Temp0	= $10
zeroPage_Temp1	= $11
zeroPage_Temp2	= $12
zeroPage_Temp3	= $13
zeroPage_Temp4	= $14
zeroPage_Temp5	= $15
zeroPage_Temp6	= $16
zeroPage_Temp7	= $17

!zn
*=$200
start
	sei
	jmp mainLoop

!source "tmp/FingerPrint.a"
!source "stdlib/LongBranches.a"
!source "stdlib/Comparisons.a"
!source "../MakeCart/asm/BankSelect8K.a"

Initialise_NoPreserveStack = 1
Initialise_NoIRQServiceRoutine = 1
Initialise_NoMACROWaitForTheLastScan = 1
!source "stdlib/Initialise.a"

RNXPCompressionDecompress_WriteBytesmAddr = zeroPage_Temp0
!source "asm/DecompressRLECommon.a"

!source "BombJack/stdlib/Bus24Bit.a"
!source "BombJack/stdlib/Video.a"

!zn
mainLoop
	lda #ProcessorPortAllRAMWithIO
	jsr InitialiseMachine
	jsr Bus24Bit_Init
	jsr APU_ResetDisable
	jsr Audio_Init

;	+WaitForFire_A

!ifdef MinimalSprites2Test {
	jsr HardwareTest_VideoPattern0

.dbl1
	jsr Video_WaitVBlank
	jsr Video_StartRasterTimers

	jsr Video_SetAddressVideoLayersEnable
	+MBus24Bit_Send8BitValue kBus24Bit_VideoLayer_LayersEnable_None

	jsr Video_SetAddressSprites2

!if 0 {
	; How much of the data being sent is bad? Repeatedly send a known pattern 00 - ff
	lda #0
.sl1
	+MBus24Bit_Send8BitValueFromA
	clc
	adc #1
	jmp .sl1
}

!macro MSendScaledSprite .x , .y , .sizeY {
	+MBus24Bit_Send8BitValue 6 | ((>.x) << 4) | ((>.y) << 5)
	+MBus24Bit_Send8BitValue <.y
	+MBus24Bit_Send8BitValue .sizeY
	+MBus24Bit_Send8BitValue <.x
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 0
}

	+MBus24Bit_Send8BitValue $0A
	+MBus24Bit_Send8BitValue $C4
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $A0
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $11

	; Player legs
	+MBus24Bit_Send8BitValue $0A
	+MBus24Bit_Send8BitValue $E4
;.smv1	lda #$e4
;	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValue $20
;.smv1	lda #$20
;	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValue $A0
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $15

	; Orange rock
	+MBus24Bit_Send8BitValue $08
;	+MBus24Bit_Send8BitValue $6B
	; Using a different Y pos (with the problem size Y of $10) fixed the issue?!!
	; So try different Y pos values...
.smv1	lda #$6b
	+MBus24Bit_Send8BitValueFromA

	; Note: Try a software fudge to reset the address?
!if 0 {
	jsr Bus24Bit_Reset
	lda #kBus24Bit_Sprites2_EBBS
	sta CIA2PortBRS232
	lda #<kBus24Bit_Sprites2 + $12
	sta CIA2PortBRS232
	lda #>kBus24Bit_Sprites2
	sta CIA2PortBRS232
}
	; Note: Try delay
;	+MACRODelay_X 5

	; Problem size Y?
	+MBus24Bit_Send8BitValue $10	; << Problematic size Y
	; So try different size Y
;.smv1	lda #$10
;	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValue $B4
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $40
	+MBus24Bit_Send8BitValue $40
;.smv1	lda #$40
;	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValue $09

	+MBus24Bit_Send8BitValue $08
	+MBus24Bit_Send8BitValue $82
	+MBus24Bit_Send8BitValue $0F
	+MBus24Bit_Send8BitValue $92
	+MBus24Bit_Send8BitValue $20
	+MBus24Bit_Send8BitValue $44
	+MBus24Bit_Send8BitValue $44
	+MBus24Bit_Send8BitValue $08

	+MSendScaledSprite 64 , 128 , 13
	+MSendScaledSprite 96 , 128 , 14
	+MSendScaledSprite 128 , 128 , 15
	+MSendScaledSprite 160 , 128 , 16
	+MSendScaledSprite 192 , 128 , 17
	+MSendScaledSprite 224 , 128 , 18

	; End of list
	lda #0
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA

	jsr Video_SetAddressVideoLayersEnable
	+MBus24Bit_Send8BitValue kBus24Bit_VideoLayer_LayersEnable_Default

	; Debug draw the hex value on the char screen
	+MBus24Bit_SetAddress_AXY kBus24Bit_CharScreenMap_EBBS , kBus24Bit_CharScreenMap + (2 * kBus24Bit_CharScreenWidth) + 6
	; Space
	+MBus24Bit_Send8BitValue $10
	; Hex
	lda .smv1+1
	lsr
	lsr
	lsr
	lsr
	+MBus24Bit_Send8BitValueFromA
	lda .smv1+1
	and #$0f
	+MBus24Bit_Send8BitValueFromA
	; Space
	+MBus24Bit_Send8BitValue $10


	+WaitForFire_A
	inc .smv1+1
	jmp .dbl1
}
!ifdef MinimalMusicDemoTest {
!ifdef IncludeMusicDataDecomp {
	jsr HardwareTest_VideoPattern0
}
!ifndef IncludeMusicDataDecomp {
	jsr HardwareTest_VideoInit
	jsr HardwareTest_VideoInitDisplay
}
}

!ifdef MusicData {
	jsr MusicInit
}

!ifdef MinimalMusicDemoTest {

!ifdef IncludeMusicDataDecomp1 {
	jsr MusicSampleData1
}
!ifdef IncludeMusicDataDecomp2 {
	jsr MusicSampleData2
}
	; For debug, fill audio with the same byte pattern
!if 0 {
	+MBus24Bit_SetAddress_AXY $04 , $0000

	ldy #0
	lda #$80
	lda #0
	ldx #$40
	jsr Bus24Bit_WriteAForYThenX
	lda #$40
	ldx #$40
	jsr Bus24Bit_WriteAForYThenX
	lda #$80
	ldx #$40
	jsr Bus24Bit_WriteAForYThenX
	lda #$c0
	ldx #$40
	jsr Bus24Bit_WriteAForYThenX
}

!ifdef MusicData {
.l1

	jsr Video_WaitVBlank
	jsr Video_StartRasterTimers

	inc VIC2BorderColour
	jsr MusicPoll
	dec VIC2BorderColour

	+WaitForFireLoop_A .l1

	jsr Audio_SetAddr_ActiveControl
	+MBus24Bit_Send8BitValue 0

.l2
	+WaitForPortBitsLoop_A CIA1KeyboardColumnJoystickA , JoystickBits_Left , .notLeft

	lda #%0001
	ldx #0
	ldy #$ff
	jsr .commonSetVoice

.notLeft

	+WaitForPortBitsLoop_A CIA1KeyboardColumnJoystickA , JoystickBits_Right , .notRight

	lda #%0010
	ldx #1
	ldy #$c0
	jsr .commonSetVoice

.notRight

	+WaitForPortBitsLoop_A CIA1KeyboardColumnJoystickA , JoystickBits_Up , .notUp

	lda #%0100
	ldx #2
	ldy #$80
	jsr .commonSetVoice

.notUp

	+WaitForPortBitsLoop_A CIA1KeyboardColumnJoystickA , JoystickBits_Down , .notDown

	lda #%1000
	ldx #3
	ldy #$40
	jsr .commonSetVoice

.notDown

	jmp .l2

.commonSetVoice
	sta .smVA1+1

	jsr Audio_SetAddr_ActiveControl
	+MBus24Bit_Send8BitValue 0

	jsr Audio_SetAddr_Channel_X

;	+MBus24Bit_Send8BitValue $ff
	sty CIA2PortBRS232
	+MBus24Bit_SendLE16BitValue 0
	+MBus24Bit_SendLE16BitValue 30000
	+MBus24Bit_SendLE16BitValue 1650

	; Check for loop or not on fire
	+TestForPortBitsLoop_A CIA1KeyboardColumnJoystickA , JoystickBits_Fire , .notFire

	+MBus24Bit_SendLE16BitValue 8192
	+MBus24Bit_SendLE16BitValue 8192
	jmp .overFire

.notFire
	+MBus24Bit_SendLE16BitValue 0
	+MBus24Bit_SendLE16BitValue 0

.overFire

	jsr Audio_SetAddr_ActiveControl

.smVA1 lda #0
	+MBus24Bit_Send8BitValueFromA

	rts

}
}

	jsr Video_DisableDisplay
	jsr Video_InitDisplaySpritesScrollsBackground

	jsr Video_SetAddressVideoOverscanExtentRegisters
	lda #kBus24Bit_VideoLayer_OverscanExtent_Wide
	sta CIA2PortBRS232

;	lda #kVideo_EnableDisplay_Enable | kVideo_EnableDisplay_Use_BackgroundColour
	lda #kVideo_EnableDisplay_Enable
	jsr Video_EnableDisplay
	jsr Video_SetAddressVideoPriorityRegister
	+MBus24Bit_VideoLayer_EmitPriority_NearToFar_A kBus24Bit_VideoLayer_Priority_Pixel0 , kBus24Bit_VideoLayer_Priority_Pixel1 , kBus24Bit_VideoLayer_Priority_Pixel2 , kBus24Bit_VideoLayer_Priority_Pixel3
	jsr Video_SetAddressTileBackgroundRegister
	lda #255
	sta CIA2PortBRS232

	; Setup both merge layers...
	jsr Video_SetAddressMergeLayer
	+MBus24Bit_Send8BitValue kBus24Bit_MergeLayer_Register_Control_Visible_0 | kBus24Bit_MergeLayer_Register_Control_Visible_1
	+MBus24Bit_Send8BitValue 0
	; Because the second input is probably not going to be connected, or connected to the vectors layer...
	+MBus24Bit_Send8BitValue kBus24Bit_MergeLayer_Register_Control_Visible_0 | kBus24Bit_MergeLayer_Register_Control_Visible_1 | kBus24Bit_MergeLayer_Register_Control_ForceOut_0
	; Toggling between 0/1 this will swap the floor colours...
	+MBus24Bit_Send8BitValue 0

	jsr DisplayData

!ifdef IncludeGraphicsData {
.l1
	jsr Video_SetAddressCharScrollRegisters
	+MBus24Bit_SendLE16BitValue 0
	jsr Video_SetAddressSprites2
	+MBus24Bit_Send8BitValue 6
	+MBus24Bit_Send8BitValue 128
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 255
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 0

	lda #0
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValueFromA

	+WaitForFire_A

	jsr Video_SetAddressCharScrollRegisters
	+MBus24Bit_SendLE16BitValue 256
	jsr Video_SetAddressSprites2
	+MBus24Bit_Send8BitValue 5
	+MBus24Bit_Send8BitValue 128
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 128
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 32
	+MBus24Bit_Send8BitValue 0

	+WaitForFire_A

	jmp .l1
}

!ifndef MinimalMusicDemoTest {
!ifndef IncludeGraphicsData {
	; Debug: Straight to the main demo
;	jsr GameSpriteWorldInit

	jsr Video_WaitVBlank
	jsr SetScreenScrolls
	jsr UpdateSprites2
;	jsr CopySprites2
	jsr UpdateSprites2B
;	jsr CopySprites2B

;	+WaitForFire_A
;	jmp .gotFire2	; Debug to go to the second part

.l1

	jsr Video_WaitVBlank
	jsr Video_StartRasterTimers
	inc VIC2BorderColour

	jsr SetScreenScrolls

	; Stage
	lda doCopySprites2B
	beq .o0
	jsr CopySprites2B
	jsr UpdateSprites2B
	jmp .o3
.o0
	; Next stage
	lda doCopySprites2
	beq .o1
	jsr CopySprites2
	jsr UpdateSprites2
	jmp .o3
.o1
	; Next stage
	jsr CopySprites1
	jsr UpdateSprites1
.o3

	; Swing the logo
	lda LogoVelTabDelay
	beq .o4
	dec LogoVelTabDelay
.o4
	lda LogoVelTabDelay
	bne .o2
	ldy LogoVelTabCnt
	lda LogoVelTab,y
	beq .o2
	+MAddAToAddr16 LogoPosX , LogoPosX+1
	inc LogoVelTabCnt
.o2
!ifdef MusicData {
	jsr MusicPoll
}

	; Debug: Single step the animation
;	+WaitForFire_A

	lda CIA1KeyboardColumnJoystickA
	and #JoystickBits_Fire
	beq .gotFire2


	jmp .l1

.gotFire2
	jmp GameSpriteWorldInit
}
}

!ifndef MinimalMusicDemoTest {
!zn
SetScreenScrolls
	inc BackgroundBounce
	ldx BackgroundBounce
	cpx #128
	bne .notSwitch

	jsr Video_SetAddressVideoPriorityRegister
	; Alternate the tiles priority to move the logo infront/behind the scaled sprites
	inc .sm1+1
	+MBus24Bit_VideoLayer_EmitPriority_NearToFar_A kBus24Bit_VideoLayer_Priority_Pixel0 , kBus24Bit_VideoLayer_Priority_Pixel1 , kBus24Bit_VideoLayer_Priority_Pixel2 , kBus24Bit_VideoLayer_Priority_Pixel3
.sm1	lda #0
	and #1
	bne .notSwitch
	jsr Video_SetAddressVideoPriorityRegister
	+MBus24Bit_VideoLayer_EmitPriority_NearToFar_A kBus24Bit_VideoLayer_Priority_Pixel0 , kBus24Bit_VideoLayer_Priority_Pixel2 , kBus24Bit_VideoLayer_Priority_Pixel1 , kBus24Bit_VideoLayer_Priority_Pixel3

.notSwitch

!ifdef kJustForLogo {
	jsr Video_SetAddressVideoPriorityRegister
	+MBus24Bit_VideoLayer_EmitPriority_NearToFar_A kBus24Bit_VideoLayer_Priority_Pixel2 , kBus24Bit_VideoLayer_Priority_Pixel0 , kBus24Bit_VideoLayer_Priority_Pixel1 , kBus24Bit_VideoLayer_Priority_Pixel3
!ifdef kJustForLogoMonchrome {
	jsr Video_SetAddressVideoLayersEnable
	+MBus24Bit_Send8BitValue kBus24Bit_VideoLayer_LayersEnable_123
}
}

	jsr Video_SetAddressCharScrollRegisters
;	+MBus24Bit_SendLE16BitValue -48
	lda BackgroundBounceTabX,x
	sec
	sbc #112
	sta CIA2PortBRS232
	lda #0
	sbc #0
	sta CIA2PortBRS232
	lda BackgroundBounceTabY,x
	sta CIA2PortBRS232
	lda #0
	sta CIA2PortBRS232

	jsr Video_SetAddressTileScrollRegisters
	+MBus24Bit_FastSpeedCopy LogoPosX , 2
!ifdef kJustForLogoMonchrome {
	+MBus24Bit_SendLE16BitValue -160
} else {
!ifdef kJustForLogo {
	+MBus24Bit_SendLE16BitValue -144
}
}
	lda BackgroundBounceTabYSmall,x
	sec
	sbc #130+16
	sta CIA2PortBRS232
	lda #0
	sbc #0
	sta CIA2PortBRS232

	; Chars2
	+MBus24Bit_SetAddress_AXY 1 , $a801
	+MBus24Bit_FastSpeedCopy .chars2X , 2
	+MBus24Bit_FastSpeedCopy .chars2Y , 2
	+MIncAddr16 .chars2X , .chars2X+1
	+MIncAddr16 .chars2X , .chars2X+1
	+MIncAddr16 .chars2Y , .chars2Y+1

	rts
.chars2X !word 0
.chars2Y !word 0


LogoVelTabDelay !by 150
LogoVelTabCnt !by 0
LogoVelTab
!for .i , 128 {
	!by (128-.i) / 20
}
	!by 0

LogoPosX +MLittleEndian16Bit -398

!zn
doCopySprites2 !by 2
CopySprites2
	jsr Video_SetAddressSprites2
	+MBus24Bit_FastSpeedCopy Sprite2_data , (8 * 8) + 3	; Include "End of list"
;	+MBus24Bit_FastSpeedCopy Sprite2B_data , (30 * 8) + 3	; Include "End of list"

	lda Sprite2_count + 7
	cmp #$ff
	bne .o1
	dec doCopySprites2
.o1
	rts

doCopySprites2B !by 200
CopySprites2B
	jsr Video_SetAddressSprites2
	+MBus24Bit_FastSpeedCopy Sprite2B_data , (30 * 8) + 3	; Include "End of list"

	dec doCopySprites2B

	rts

UpdateSprites2
!macro MHandleSprite .i {
	ldx Sprite2_count + .i
	lda SpriteYTab,x
	sta Sprite2_data + 1 + (.i * 8)
	lda SpriteScaleTab,x
	sta Sprite2_data + 5 + (.i * 8)
	sta Sprite2_data + 6 + (.i * 8)
	tay
	lda SpriteYExtentLookup,y
	sta Sprite2_data + 2 + (.i * 8)

	lda Sprite2_delay + .i
	beq .do1
	dec Sprite2_delay + .i
	jmp .do2
.do1
	cpx #$ff
	beq .do2
	inc Sprite2_count + .i
.do2
}

	+MHandleSprite 0
	+MHandleSprite 1
	+MHandleSprite 2
	+MHandleSprite 3
	+MHandleSprite 4
	+MHandleSprite 5
	+MHandleSprite 6
	+MHandleSprite 7

	rts


UpdateSprites2B
!macro MHandleSpriteB .i , .y {
	ldx Sprite2B_count + .i

	lda Sprite2B_data + 0 + (.i * 8)
	and #!kBus24Bit_Sprites2_MSBX
	ora SpriteXTabBHi,x
	sta Sprite2B_data + 0 + (.i * 8)

	lda SpriteYTabB,x
	clc
	adc #.y
	sta Sprite2B_data + 1 + (.i * 8)
	lda SpriteXTabB,x
	sta Sprite2B_data + 3 + (.i * 8)
	lda SpriteScaleTabB,x
	sta Sprite2B_data + 5 + (.i * 8)
	sta Sprite2B_data + 6 + (.i * 8)
	tay
	lda SpriteYExtentLookup,y
	sta Sprite2B_data + 2 + (.i * 8)

	inc Sprite2B_count + .i
}

	+MHandleSpriteB 0 , 0
	+MHandleSpriteB 1 , 0
	+MHandleSpriteB 2 , 0
	+MHandleSpriteB 3 , 0
	+MHandleSpriteB 4 , 0
	+MHandleSpriteB 5 , 0
	+MHandleSpriteB 6 , 0
	+MHandleSpriteB 7 , 0

	+MHandleSpriteB 8 , 30
	+MHandleSpriteB 9 , 30
	+MHandleSpriteB 10 , 30
	+MHandleSpriteB 11 , 30
	+MHandleSpriteB 12 , 30
	+MHandleSpriteB 13 , 30
	+MHandleSpriteB 14 , 30
	+MHandleSpriteB 15 , 30

	+MHandleSpriteB 16 , 60
	+MHandleSpriteB 17 , 60
	+MHandleSpriteB 18 , 60
	+MHandleSpriteB 19 , 60
	+MHandleSpriteB 20 , 60
	+MHandleSpriteB 21 , 60
	+MHandleSpriteB 22 , 60
	+MHandleSpriteB 23 , 60

	+MHandleSpriteB 24 , 90
	+MHandleSpriteB 25 , 90
	+MHandleSpriteB 26 , 90
	+MHandleSpriteB 27 , 90
	+MHandleSpriteB 28 , 90
	+MHandleSpriteB 29 , 90
;	+MHandleSpriteB 30 , 90
;	+MHandleSpriteB 31 , 90

	rts

!macro SpriteOutput2x2 .xPos , .yPos , .s0 , .s1 , .s2 , .s3 {
	ldx .xPos
	ldy .yPos
	jsr .s0
	lda .xPos
	clc
	adc #16
	tax
	jsr .s1

	ldx .xPos
	lda .yPos
	sec
	sbc #16
	tay
	jsr .s2
	lda .xPos
	clc
	adc #16
	tax
	jsr .s3
}

!macro SpriteOutput2x2Immediate .xPos , .yPos , .s0 , .s1 , .s2 , .s3 {
	ldx #.xPos
	ldy #.yPos
	jsr .s0
	ldx #.xPos+16
	jsr .s1

	ldx #.xPos
	ldy #.yPos-16
	jsr .s2
	ldx #.xPos+16
	jsr .s3
}

!zn
sprites1PosXTarget
!ifdef kJustForLogoMonchrome {
	!by 158 , 182 , 206 , 230
}
	!by 178 , 198 , 218 , 238
sprites1PosYCount
	!by 0 , 50 , 100 , 150
sprites1PosX
	!by 0 , 0 , 0 , 0
sprites1PosY
	!by 0 , 0 , 0 , 0

singleSprite2UpdateLo !by 0
singleSprite2UpdateAnimCount !by 0
CopySprites1
	jsr Video_SetAddressSprites
	+SpriteOutput2x2 sprites1PosX + 0 , sprites1PosY + 0 , EmitSpriteFrame0_0 , EmitSpriteFrame16_0 , EmitSpriteFrame0_16 , EmitSpriteFrame16_16
	+SpriteOutput2x2 sprites1PosX + 1 , sprites1PosY + 1 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	+SpriteOutput2x2 sprites1PosX + 2 , sprites1PosY + 2 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	+SpriteOutput2x2 sprites1PosX + 3 , sprites1PosY + 3 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16

	; Single update a particular Sprite2
	lda #kBus24Bit_Sprites2_EBBS
	ldx singleSprite2UpdateLo
	ldy #>kBus24Bit_Sprites2
	jsr Bus24Bit_SetAddressBus
!for .ii , 8 {
	lda Sprite2_data + .ii -1 ,x
	sta CIA2PortBRS232
}
	rts

Sprites1BounceTabY
	!for .i , 256 {
		!by 100 + (12.0 * cos( (float(-.i) / 32.0) * 3.14159265 ))
	}

UpdateSprites1
	ldx #3
.l1
	lda sprites1PosXTarget,x
	cmp sprites1PosX,x
	beq .o1
	sec
	sbc sprites1PosX,x
	tay
	lda divBy16TabMin1,y
	clc
	adc sprites1PosX,x
	sta sprites1PosX,x
.o1

	inc sprites1PosYCount,x
	ldy sprites1PosYCount,x
	lda Sprites1BounceTabY,y
!ifdef kJustForLogo {
	lda #117
}
!ifdef kJustForLogoMonchrome {
	lda #108
}
	sta sprites1PosY,x

	dex
	bpl .l1

	ldx singleSprite2UpdateLo
	ldy singleSprite2UpdateAnimCount
	lda SpriteScalePulseTab,y
!ifdef kJustForLogo {
	lda #32
}
	sta Sprite2_data + 5,x
	sta Sprite2_data + 6,x
	tay
	lda SpriteYExtentLookup,y
	sta Sprite2_data + 2,x

	inc singleSprite2UpdateAnimCount
	lda singleSprite2UpdateAnimCount
	and #$3f
	bne .o2
	lda #0
	sta singleSprite2UpdateAnimCount
	lda singleSprite2UpdateLo
	clc
	adc #8
	and #$3f
	sta singleSprite2UpdateLo
.o2
	rts

divBy16TabMin1
!for .ii , 256 {
!set .i = (.ii-1) / 16
!if .i <= 1 {
!set .i = 1
}
	!by .i
}

} ;< !ifndef MinimalMusicDemoTest {

!ifndef MinimalMusicDemoTest {

Sprite2_delay
	!by 0
	!by 25
	!by 50
	!by 75
	!by 100
	!by 125
	!by 150
	!by 175
Sprite2_count
	!by 0
	!by 0
	!by 0
	!by 0
	!by 0
	!by 0
	!by 0
	!by 0
Sprite2_data
!for .ii , 8 {
!set .i = .ii-1
!set .xpos = $37 + (.i * 32.5)
	!by ((.i/4)+kVarsEmitSpriteFrame_scaled_0_0_0_colour) | ((>.xpos)<<4)  , 0 , 0x20 , <.xpos , 0x20 , 0x20 , 0x20 , kVarsEmitSpriteFrame_scaled_0_0_0_tileIndex + .i
}
	; End of list
	!fill 3 , 0

SpriteYTab
	!for .i , 256 {
		!by 64 - (64 * cos( (float(.i) / 192) * 3.14159265 )) + (58 * sin( (float(.i) / 64) * 3.14159265 ))
	}

; With VIDCLK as input
;kBaseScale = 34
;kBaseScaleMax = 18
;kPulseScaleMax = 12

; With 14.31818 MHz as input
kBaseScale = 32
kBaseScaleMax = 26
kPulseScaleMax = 20

SpriteScaleTab
	!for .i , 255 {
		!by kBaseScale + (float(kBaseScaleMax) * sin( (float(.i) / 128.0) * 3.14159265 ))
	}
	!by kBaseScale

SpriteScalePulseTab
	!for .i , 62 {
		!by kBaseScale - (float(kPulseScaleMax) * sin( (float(.i) / 32.0) * 3.14159265 ))
	}
	!by kBaseScale
	!by kBaseScale



Sprite2B_count
	!by 0
	!by 5
	!by 10
	!by 15
	!by 20
	!by 25
	!by 30
	!by 35

	!by 0	+1
	!by 5	+1
	!by 10	+1
	!by 15	+1
	!by 20	+1
	!by 25	+1
	!by 30	+1
	!by 35	+1

	!by 0	+2
	!by 5	+2
	!by 10	+2
	!by 15	+2
	!by 20	+2
	!by 25	+2
	!by 30	+2
	!by 35	+2

;	!by 0	+2
	!by 5	+2
	!by 10	+2
	!by 15	+2
	!by 20	+2
	!by 25	+2
	!by 30	+2
	!by 35	+2
	
Sprite2B_data
!for .ii , 30 {
!set .i = .ii-1
!set .xpos = $37 + (.i * 32.5)
	!by (((.i&7)/4)+kVarsEmitSpriteFrame_scaled_0_0_0_colour)  , 0 , 0x20 , <.xpos , 0x20 , 0x20 , 0x20 , kVarsEmitSpriteFrame_scaled_0_0_0_tileIndex + (.i & 7)
}
	; End of list
	!fill 3 , 0

SpriteXTabB
	!for .i , 256 {
!set .xpos = 170 + (150 * sin( (float(.i) / 64) * 3.14159265 ))
		!by <.xpos
	}

SpriteXTabBHi
	!for .i , 256 {
!set .xpos = 170 + (150 * sin( (float(.i) / 64) * 3.14159265 ))
!if (>.xpos) = 0 {
		!by 0
} else {
		!by kBus24Bit_Sprites2_MSBX
}
	}

SpriteYTabB
	!for .i , 256 {
		!by 50 + (20 * cos( (float(.i) / 64) * 3.14159265 ))
	}

SpriteScaleTabB
	!for .i , 256 {
		!by 48 + (float(8) * cos( (float(.i + 64) / 64.0) * 3.14159265 ))
	}
} ;< !ifndef MinimalMusicDemoTest {


; Using the sprite scale, assume it is 32x32 pixels, and produce the Y extent from this lookup table
SpriteYExtentLookup
	!by 1
	!for .i , 255 {
!set .realSize = ((32*32) / int(.i))
!if .realSize < 1 {
!set .realSize = 1
}
!if .realSize > 240 {
!set .realSize = 240
}
		!by .realSize
	}

!ifndef MinimalMusicDemoTest {

BackgroundBounce !by 0

BackgroundBounceTabX
	!for .i , 256 {
		!by 64 + (40.0 * cos( (float(-.i) / 128.0) * 3.14159265 )) + (24.0 * sin( (float(.i - 123) / 64.0) * 3.14159265 ))
	}

BackgroundBounceTabY
	!for .i , 256 {
;		!by 30 + (12.0 * cos( (float(-.i) / 32.0) * 3.14159265 )) + (8.0 * sin( (float(.i - 123) / 64.0) * 3.14159265 ))
		!by 30 + (12.0 * cos( (float(-.i) / 128.0) * 3.14159265 ))
	}

BackgroundBounceTabYSmall
	!for .i , 256 {
		!by 16 + (12.5 * cos( (float(-.i) / 128.0) * 3.14159265 ))
	}

}

!macro MEmitSpriteFrame_Preserve {
}
!macro MEmitSpriteFrame .frame , .colour {
	lda #.frame
	sta CIA2PortBRS232
	lda #.colour
	sta CIA2PortBRS232

	sty CIA2PortBRS232
	stx CIA2PortBRS232
}
!macro MEmitSpriteFrame_RestoreExit {
	rts
}
!source "tmp\Demo9Sprites1Sheet.txt.a"
!source "tmp\Demo9Sprites2Sheet.txtVars.a"

!ifndef MinimalMusicDemoTest {
!ifndef IncludeGraphicsData {

; Constants for the 3D world
kEntries = 128
kFarPoint = -8
;kFarPoint = 0
kNearPoint = 128
kMaxSwing = 128
kMultiplier = 8
;kMultiplier = 1
kScaledSpriteSeparationValue = 45	; TODO: Figure out the proper maths for this based on when the sprite is normal size (no scale, just $20 x $20)
kMaxGameSprites = 24
MaxGameSprites !by kMaxGameSprites

GameSpriteData
!if 0 {
	; See: kSkipToFrameThenWaitForFire
	!by $0A ,$C4 ,$20 ,$A0 ,$20 ,$20 ,$20 ,$11   ,$0A ,$E4 ,$20 ,$A0 ,$20 ,$20 ,$20 ,$15
	!by $08 ,$6B ,$10 ,$B4 ,$20 ,$40 ,$40 ,$09   ,$08 ,$82 ,$0F ,$92 ,$20 ,$44 ,$44 ,$08
	!by $08 ,$68 ,$0F ,$B3 ,$20 ,$44 ,$44 ,$08   ,$09 ,$8F ,$0D ,$C1 ,$20 ,$4E ,$4E ,$0E
	!by $09 ,$8F ,$0D ,$CD ,$20 ,$4E ,$4E ,$0F   ,$08 ,$52 ,$0C ,$9D ,$20 ,$55 ,$55 ,$08
	!by $08 ,$6F ,$0A ,$C1 ,$20 ,$66 ,$66 ,$0A   ,$08 ,$7D ,$0A ,$9D ,$20 ,$66 ,$66 ,$08
	!by $0B ,$8B ,$09 ,$A6 ,$20 ,$71 ,$71 ,$16   ,$09 ,$82 ,$09 ,$A6 ,$20 ,$71 ,$71 ,$14
	!by $09 ,$7A ,$09 ,$A6 ,$20 ,$71 ,$71 ,$10   ,$08 ,$7F ,$09 ,$C9 ,$20 ,$71 ,$71 ,$09
	!by $08 ,$82 ,$07 ,$C3 ,$20 ,$92 ,$92 ,$0B   ,$08 ,$82 ,$07 ,$CB ,$20 ,$92 ,$92 ,$0C
	!by $08 ,$8A ,$07 ,$C3 ,$20 ,$92 ,$92 ,$12   ,$08 ,$8A ,$07 ,$CB ,$20 ,$92 ,$92 ,$13
	!by $0B ,$87 ,$06 ,$A8 ,$20 ,$AA ,$AA ,$16   ,$09 ,$81 ,$06 ,$A8 ,$20 ,$AA ,$AA ,$14
	!by $09 ,$7B ,$06 ,$A8 ,$20 ,$AA ,$AA ,$10   ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00
	!by $00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00   ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00
	!by $00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00   ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00
	!by $00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00   ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00 ,$00
}

	; Setup the player character
	!by kVarsEmitSpriteFrame_scaled_32_64_0_colour , 128 , 32 , 128 , 32 , 32 , 32 , kVarsEmitSpriteFrame_scaled_32_64_0_tileIndex
	!by kVarsEmitSpriteFrame_scaled_32_96_0_colour , 128 + 32 , 32 , 128, 32 , 32 , 32 , kVarsEmitSpriteFrame_scaled_32_96_0_tileIndex
	!fill (kMaxGameSprites+1) * 8 , 0
	; Extra buffer for safety
	!fill 8 , 0

GameSpriteWorld_X
;	!by 0 , 0 , 0
;	!by 9 , 48, 96 , 112
;	!by -6 , -28, -46 , -112
;	!by -1 , -38, -66 , -42
	!fill kMaxGameSprites , 0
GameSpriteWorld_Y
;	!by 0 , 0 , 0
;	!by 0 , 1 , 2
	!fill kMaxGameSprites , 0
GameSpriteWorld_Z
;	!by 0 , 0 , 0
;	!by 1 , 1 , 1
;	!by 2 , 2 , 2
;	!by 0 , 5, 10
;	!by 0 , 10, 50 , 40	; Near large(ish) bunch to test edge of screen rejection
;	!by 100 , 250, 110 , 50
;	!by 130 ,  45, 210 , 10
;	!by 170 ,  35,  90 , 20
	!fill kMaxGameSprites , 255
GameSpriteWorld_IsBullet
	!fill kMaxGameSprites , 0
GameSpriteWorld_Frame
;	!by 0 , 1 , 2 , 3
;	!by 4 , 5 , 6 , 7
;	!by 0 , 1 , 2 , 3
;	!by 4 , 5 , 6 , 7
	!fill kMaxGameSprites , 0
GameSpriteWorld_Palette
;	!by 0 , 1 , 2 , 3
;	!by 0 , 1 , 2 , 3
;	!by 0 , 1 , 2 , 3
;	!by 0 , 1 , 2 , 3
	!fill kMaxGameSprites , 0

GameSpriteWorld_SortIndex
	!fill kMaxGameSprites , 0

SortTemp0 = zeroPage_Temp0
SortTemp1 = zeroPage_Temp1
SortTemp2 = zeroPage_Temp2
SortTemp3 = zeroPage_Temp3
SortTemp4 = zeroPage_Temp4
SortTemp5 = zeroPage_Temp5
SortTemp6 = zeroPage_Temp6
SortTemp7 = zeroPage_Temp7

!source "stdlib/QuickSort.a"

QuickSort_Sortlo !fill kMaxGameSprites , 0
QuickSort_Sorthi !fill kMaxGameSprites , 0

GameSpriteWorld_Sort
	+QuickSort_SortRTS 1 , kMaxGameSprites , MaxGameSprites , GameSpriteWorld_SortIndex , GameSpriteWorld_Z , SortTemp0 , SortTemp1 , QuickSort_Sortlo , QuickSort_Sorthi , ~SortBlockByteLength , ~QuickSort_sortstart


!zn
!ifdef kSkipToFrameThenWaitForFire {
.frameCount	!word 0
.frameDebugTrigger !by 0
}
.viewPosX !by 0
.viewPosY !by -100
World_ViewPosZ !by 0
.playerViewScale !by 24
.playerNumBullets !by 0
.playerBulletCooldown !by 0
GameSpriteWorldInit
	jsr SetupAPU
	lda #0
	ldy .viewPosY
	jsr SendAPUAPULineScrolls
	jsr APU_Enable
	jsr Video_SetAddressCharScrollRegisters
	+MBus24Bit_SendLE16BitValue -48

	jsr Video_SetAddressVideoPriorityRegister
	+MBus24Bit_VideoLayer_EmitPriority_NearToFar_A kBus24Bit_VideoLayer_Priority_Pixel0 , kBus24Bit_VideoLayer_Priority_Pixel1 , kBus24Bit_VideoLayer_Priority_Pixel2 , kBus24Bit_VideoLayer_Priority_Pixel3

	+QuickSort_TableInit kMaxGameSprites , SortTemp0 , SortTemp1 , SortBlockByteLength , QuickSort_Sortlo , QuickSort_Sorthi , QuickSort_sortstart
	+QuickSort_Init MaxGameSprites , GameSpriteWorld_SortIndex

!if 0 {
	; See: kSkipToFrameThenWaitForFire
	jsr Video_SetAddressSprites2
	+MBus24Bit_FastSpeedCopy GameSpriteData , ((kMaxGameSprites+3) * 8) + 3	; Include "End of list"
	+WaitForFire_A
	+WaitForFire_A
}

	jsr DrawScoresSprites

.gameLoop1

	; setup the player position
	; Remove any X/Y MSB
	lda GameSpriteData + 0
	and #$f
	sta GameSpriteData + 0
	lda GameSpriteData + 8 + 0
	and #$f
	sta GameSpriteData + 8 + 0

	lda #128
	sec
	sbc .viewPosX
	clc
	; The player sprite is not quite centered on the screen. The 3D bullet is spawned at X=0 when .viewPosX=0
	; So the player sprite, which is not 3D, which carries the gun on the right, needs to adjust for the apparent bullet firing position.
	; The middle on the gun should be on the middle line of the floor, at x=182
	adc #26
	sta GameSpriteData + 3
	sta GameSpriteData + 8 + 3
	bcc .noPlayerMSBX
	lda GameSpriteData + 0
	ora #$10
	sta GameSpriteData + 0
	lda GameSpriteData + 8 + 0
	ora #$10
	sta GameSpriteData + 8 + 0
.noPlayerMSBX

	; And some optimised/hacky Y pos maths
	ldy .playerViewScale
	cpy #$40
	bcs .playerScaleOK
	iny
	sty .playerViewScale
.playerScaleOK
	tya
	lsr
	tay
	sty GameSpriteData + 5
	sty GameSpriteData + 6
	sty GameSpriteData + 8 + 5
	sty GameSpriteData + 8 + 6
	lda Sprite2Tab_ScaleToYSize,y
	sta GameSpriteData + 2
	sta GameSpriteData + 8 + 2
	lda #128
	sec
	sbc .viewPosY
	sec
	sbc #32
	sta GameSpriteData + 1
	bcs .noPlayerMSBY
	lda GameSpriteData + 0
	ora #$20
	sta GameSpriteData + 0
.noPlayerMSBY
	lda #128
	sec
	sbc .viewPosY
	sec
	sbc #32
	sta SortTemp0
	; Carry for hi
	lda #0
	sbc #0
	sta SortTemp1
	lda SortTemp0
	clc
	adc GameSpriteData + 2
	sta GameSpriteData + 8 + 1
	; Carry for hi
	lda SortTemp1
	adc #0
	sta SortTemp1
	beq .noPlayerMSBY2
	lda GameSpriteData + 8 + 0
	ora #$20
	sta GameSpriteData + 8 + 0
.noPlayerMSBY2

	jsr GameSpriteWorld_Sort

	; Update the world to the sprites
	+MWordValueToAddress_A GameSpriteData + (2*8) , SortTemp0	; Leaving space for the player character, who isn't part of the world
	lda #0
	sta SortTemp2
.ul1
	ldy SortTemp2
	ldx GameSpriteWorld_SortIndex,y
	; Since the world is sorted, then once we get too far away all the entries following it are also going to be too far away, so output the end of the sprite list
	lda GameSpriteWorld_Z,x
	cmp #kEntries
	+lbcs .eul1

	stx .smx1+1

	asl
	tax
	; Scale X and Y
	lda Sprite2Tab_ScaleYSize,x
	ldy #5
	sta (SortTemp0),y
	ldy #6
	sta (SortTemp0),y

	; Y pixel size
	lda Sprite2Tab_ScaleYSize+1,x
	ldy #2
	sta (SortTemp0),y
	; Full size
	sta SortTemp6
	; Half size
	lsr
	sta SortTemp7

	; X Scale extent
	lda #$20
	ldy #4
	sta (SortTemp0),y

.smx1	ldx #0
	; Frame
	lda GameSpriteWorld_Frame,x
	ldy #7
	sta (SortTemp0),y

	; Palette
	lda GameSpriteWorld_Palette,x
	ldy #0
	sta (SortTemp0),y

	; Setup X pos
	+MWordValueToAddress_A 128+50 , SortTemp3
	; Adjust for half size
	+MSubU8AddrToAddr16 SortTemp7 , SortTemp3 , SortTemp4

	lda GameSpriteWorld_X,x
	beq .nox
	bpl .isPosX2
	; Inverted, no need iny/+1
	eor #$ff
	tay
	lda Sprite2Tab_PerspectiveTabLo,y
	sta .smxp3i+1
	lda Sprite2Tab_PerspectiveTabHi,y
	sta .smxp3i+2
	ldy GameSpriteWorld_Z,x
.smxp3i lda $1234,y
	sta SortTemp5
	+MSubU8AddrToAddr16 SortTemp5 , SortTemp3 , SortTemp4
	jmp .nox
.isPosX2
	tay
	lda Sprite2Tab_PerspectiveTabLo-1,y
	sta .smxp+1
	lda Sprite2Tab_PerspectiveTabHi-1,y
	sta .smxp+2
	ldy GameSpriteWorld_Z,x
.smxp lda $1234,y
	+MAddAToAddr16 SortTemp3 , SortTemp4
.nox

	; Double accumulate the view position
	; TODO: This is slightly less accurate, with a larger table the index could be accumulated instead
	lda .viewPosX
	+M_ASR
	beq .nox2
	bpl .isPosX1
	; Inverted, no need iny/+1
	eor #$ff
	tay
	lda Sprite2Tab_PerspectiveTabLo,y
	sta .smxp2i+1
	lda Sprite2Tab_PerspectiveTabHi,y
	sta .smxp2i+2
	ldy GameSpriteWorld_Z,x
.smxp2i lda $1234,y
	sta SortTemp5
	+MSubU8AddrToAddr16 SortTemp5 , SortTemp3 , SortTemp4
	jmp .nox2

.isPosX1
	tay
	lda Sprite2Tab_PerspectiveTabLo-1,y
	sta .smxp2+1
	lda Sprite2Tab_PerspectiveTabHi-1,y
	sta .smxp2+2
	ldy GameSpriteWorld_Z,x
.smxp2 lda $1234,y
	+MAddAToAddr16 SortTemp3 , SortTemp4

.nox2
	ldy #3
	lda SortTemp3
	sta (SortTemp0),y
	lda SortTemp4
	beq .isX00xx
	cmp #$ff
	beq .isXffxx
	cmp #1
	beq .isX01xx
	jmp .reallyOffScreen
.isX01xx
	lda SortTemp3
	cmp #<(kBus24Bit_VideoLayer_XPos_OverscanExtent_Wide_right-6)	; TODO: Will need tweaking depending on screen borders
	+lbcs .reallyOffScreen
	jmp .addXMSB
.isXffxx
	lda SortTemp3
	clc
	adc SortTemp6
	; No carry indicates the sprite is still far inside the left edge
	+lbcc .reallyOffScreen
	; Just inside the left edge, still remove
	cmp #$18	; TODO: Will need tweaking depending on screen borders
	+lbcc .reallyOffScreen
.addXMSB
	ldy #0
	lda (SortTemp0),y
	ora #$10
	sta (SortTemp0),y
.isX00xx
.notMSB1

	; Setup Y pos
	+MWordValueToAddress_A 128 , SortTemp3
	; Adjust for half size
	+MSubU8AddrToAddr16 SortTemp7 , SortTemp3 , SortTemp4

	lda GameSpriteWorld_Y,x
	beq .noy
	bpl .isPosY2
	; Inverted, no need iny/+1
	eor #$ff
	tay
	lda Sprite2Tab_PerspectiveTabLo,y
	sta .smyp3i+1
	lda Sprite2Tab_PerspectiveTabHi,y
	sta .smyp3i+2
	ldy GameSpriteWorld_Z,x
.smyp3i lda $1234,y
	sta SortTemp5
	+MSubU8AddrToAddr16 SortTemp5 , SortTemp3 , SortTemp4
	jmp .noy
.isPosY2
	tay
	lda Sprite2Tab_PerspectiveTabLo-1,y
	sta .smyp+1
	lda Sprite2Tab_PerspectiveTabHi-1,y
	sta .smyp+2
	ldy GameSpriteWorld_Z,x
.smyp lda $1234,y
	+MAddAToAddr16 SortTemp3 , SortTemp4
.noy

	; Double accumulate the view position
	; TODO: This is slightly less accurate, with a larger table the index could be accumulated instead
	lda .viewPosY
	+M_ASR
	beq .noy2
	bpl .isPosY1
	; Inverted, no need iny/+1
	eor #$ff
	tay
	lda Sprite2Tab_PerspectiveTabLo,y
	sta .smypi+1
	lda Sprite2Tab_PerspectiveTabHi,y
	sta .smypi+2
	ldy GameSpriteWorld_Z,x
.smypi lda $1234,y
	sta SortTemp5
	+MSubU8AddrToAddr16 SortTemp5 , SortTemp3 , SortTemp4
	jmp .noy2

.isPosY1
	tay
	lda Sprite2Tab_PerspectiveTabLo-1,y
	sta .smyp2+1
	lda Sprite2Tab_PerspectiveTabHi-1,y
	sta .smyp2+2
	ldy GameSpriteWorld_Z,x
.smyp2 lda $1234,y
	+MAddAToAddr16 SortTemp3 , SortTemp4

.noy2
	ldy #1
	lda SortTemp3
	sta (SortTemp0),y
	lda SortTemp4
	beq .isY00xx
	cmp #$ff
	beq .isYffxx
	jmp .reallyOffScreen
.isY00xx
	lda SortTemp3
	cmp #224	; TODO: Will need tweaking depending on screen borders
	bcs .reallyOffScreen
	jmp .notMSBY1
.isYffxx
	lda SortTemp3
	clc
	adc SortTemp6
	; No carry indicates the sprite is still far inside the top edge
	bcc .reallyOffScreen
	; Just inside the left edge, still remove
	cmp #$18	; TODO: Will need tweaking depending on screen borders
	bcc .reallyOffScreen
.addYMSB
	ldy #0
	lda (SortTemp0),y
	ora #$20
	sta (SortTemp0),y
.notMSBY1

	+MAddU8ToAddr16 8 , SortTemp0 , SortTemp0+1

.reallyOffScreen
	inc SortTemp2
	lda SortTemp2
	cmp #kMaxGameSprites
	+lbne .ul1


.eul1
	; End of list
	lda #0
	ldy #2
	sta (SortTemp0),y

	; Draw frame starts here
	jsr Video_WaitVBlank
	jsr Video_SetAddressSprites2
	+MBus24Bit_FastSpeedCopy GameSpriteData , ((kMaxGameSprites+3) * 8) + 3	; Include "End of list"

	jsr Video_SetAddressCharScrollRegisters
	lda .viewPosX
	eor #$ff
	+M_ASR
	+M_ASR
	clc
	adc #64
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValue 0
	lda .viewPosY
	eor #$ff
	+M_ASR
	+M_ASR
	clc
	adc #64
	+MBus24Bit_Send8BitValueFromA
	+MBus24Bit_Send8BitValue 0

!ifdef MusicData {
	jsr MusicPoll
}

	lda .viewPosX
	ldy .viewPosY
	jsr SendAPUAPULineScrolls

	; Rest of the frame is dedicated to calculation of the next frame
	lda CIA1KeyboardColumnJoystickA
	and #JoystickBits_Left
	bne .notLeft
	lda .viewPosX
	cmp #127
	beq .notLeft
	inc .viewPosX
.notLeft
	lda CIA1KeyboardColumnJoystickA
	and #JoystickBits_Right
	bne .notRight
	lda .viewPosX
	cmp #-127
	beq .notRight
	dec .viewPosX
.notRight

	lda CIA1KeyboardColumnJoystickA
	and #JoystickBits_Up
	bne .notUp
	lda .viewPosY
	cmp #127
	beq .notUp
	inc .viewPosY
.notUp
	lda CIA1KeyboardColumnJoystickA
	and #JoystickBits_Down
	bne .notDown
	lda .viewPosY
	cmp #-127
	beq .notDown
	dec .viewPosY
.notDown

!if 0 {
	; This stops the movement towards the player after a time period, to allow debugging of positions close to the camera
.smt = *+1
	lda #190
	beq .skipMoveTowards
	dec .smt
}
	; Move stuff towards the player, or move the bullets...
	inc World_ViewPosZ

	ldx #kMaxGameSprites-1
.worldUpdate1
	lda GameSpriteWorld_Z,x
	cmp #$ff
	beq .worldUpdate2
	lda GameSpriteWorld_IsBullet,x
	bne .doBullet
	dec GameSpriteWorld_Z,x
	jmp .worldUpdate2
.doBullet
	lda GameSpriteWorld_Z,x
	clc
	adc #4
	sta GameSpriteWorld_Z,x
	cmp #128
	bcc .worldUpdate2

	; Kills the bullet
	lda #$ff
	sta GameSpriteWorld_Z,x
	dec .playerNumBullets

.worldUpdate2
	dex
	bpl .worldUpdate1
.skipMoveTowards


!ifdef kSkipToFrameThenWaitForFire {
	; Debug: Remove bullets
	jmp .notGotFire1
}

	lda .playerBulletCooldown
	beq .cool
	dec .playerBulletCooldown
	jmp .notGotFire1
.cool
	lda CIA1KeyboardColumnJoystickA
	and #JoystickBits_Fire
	bne .notGotFire1
	lda .playerViewScale
	cmp #$30
	bcc .notGotFire1

	; Maximum number of active bullets?
	lda .playerNumBullets
	cmp #4
	bcs .notGotFire1

	; Can we spawn a bullet?
	ldx GameSpriteWorld_SortIndex + kMaxGameSprites - 1
	lda GameSpriteWorld_Z,x
	cmp #$ff
	bne .notGotFire1

	lda .playerViewScale
	sec
	sbc #10
	sta .playerViewScale

	lda #8
	sta .playerBulletCooldown

	inc .playerNumBullets

	lda #4
	sta GameSpriteWorld_IsBullet,x
	sta GameSpriteWorld_Z,x
	lda .viewPosX
	eor #$ff
	sta GameSpriteWorld_X,x
	lda .viewPosY
	eor #$ff
	sta GameSpriteWorld_Y,x
	lda #kVarsEmitSpriteFrame_scaled_160_32_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_160_32_0_colour
	sta GameSpriteWorld_Palette,x

.notGotFire1


	; Check to see if we can spawn a new object right at the far end of the world, leaving space for some bullets
	ldx GameSpriteWorld_SortIndex + kMaxGameSprites - 5
	lda GameSpriteWorld_Z,x
	cmp #$ff
	+lbne .notFree
;	jmp .doThing	; Debug
	; Names list: https://twitter.com/MartinPiper/status/1533084835245223936
.timeWaste	lda #50
	beq .textPos
	dec .timeWaste+1
	jmp .notFree
.doTimeWaste
	lda #100
	sta .timeWaste+1
	jmp .nextChar
.textPos	ldy .displayNames
	beq .noMoreText	; End of the list
	cpy #kCarriageReturn
	beq .carriageReturn
	cpy #kDoTimeWaste
	beq .doTimeWaste
	cpy #kResetTextPos
	beq .resetTextPos

	cpy #' '
	beq .nextCharPosDiv2

	lda .charConvTab,y
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_32_128_0_colour
	sta GameSpriteWorld_Palette,x

	; Letters!
	lda #128
	sta GameSpriteWorld_Z,x
	lda #0
	sta GameSpriteWorld_IsBullet,x
.smcx1	lda #-127
	sta GameSpriteWorld_X,x
.smcy1	lda #-127
	sta GameSpriteWorld_Y,x
	jmp .nextCharPos

.nextCharPosDiv2
	lda .smcx1+1
	clc
	adc #kScaledSpriteSeparationValue-6
	sta .smcx1+1
	jmp .posCheck

	; Next letter...
	; Position
.nextCharPos
	lda .smcx1+1
	clc
	adc #kScaledSpriteSeparationValue-3
	sta .smcx1+1
.posCheck
	bvc .osxp1	; overflow clear, not carry!
.carriageReturn
	lda #-127
	sta .smcx1+1

	lda .smcy1+1
	clc
	adc #kScaledSpriteSeparationValue
	sta .smcy1+1
	bvc .osxp1	; overflow clear, not carry!

.resetTextPos
	lda #-127
	sta .smcx1+1
	lda #-127
	sta .smcy1+1

.osxp1
.nextChar
	; Setup next letter to display
	inc .textPos+1
	bne .otp1
	inc .textPos+2
.otp1

	jmp .notFree
.noMoreText

	; Randomly choose something or nothing
	jsr Rand
	and #3
	bne .os1
	jsr ScaledSetupPosition
	lda #kVarsEmitSpriteFrame_scaled_0_32_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_0_32_0_colour
	sta GameSpriteWorld_Palette,x
	jmp .notFree
.os1

	jsr Rand
	and #3
	bne .os2
	jsr ScaledSetupPosition
	lda #kVarsEmitSpriteFrame_scaled_32_32_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_32_32_0_colour
	sta GameSpriteWorld_Palette,x
	jmp .notFree
.os2

	jsr Rand
	and #3
	bne .os3
	jsr ScaledSetupPosition
	lda #kVarsEmitSpriteFrame_scaled_64_32_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_64_32_0_colour
	sta GameSpriteWorld_Palette,x
	jmp .notFree
.os3

	jsr Rand
	and #3
	bne .os4

	jsr ScaledSetupPositionWithoutY
	lda #127
	sta GameSpriteWorld_Y,x
	lda #kVarsEmitSpriteFrame_scaled_0_128_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_0_128_0_colour
	sta GameSpriteWorld_Palette,x

	; Other sprites in this group
	ldy GameSpriteWorld_SortIndex + kMaxGameSprites - 5 + 1
	lda #0
	sta GameSpriteWorld_IsBullet,y
	lda GameSpriteWorld_Y,x
	sec
	sbc #kScaledSpriteSeparationValue
	sta GameSpriteWorld_Y,y
	lda GameSpriteWorld_X,x
	sta GameSpriteWorld_X,y
	lda GameSpriteWorld_Z,x
	sta GameSpriteWorld_Z,y
	lda #kVarsEmitSpriteFrame_scaled_0_96_0_tileIndex
	sta GameSpriteWorld_Frame,y
	lda #kVarsEmitSpriteFrame_scaled_0_96_0_colour
	sta GameSpriteWorld_Palette,y

	ldy GameSpriteWorld_SortIndex + kMaxGameSprites - 5 + 2
	lda #0
	sta GameSpriteWorld_IsBullet,y
	lda GameSpriteWorld_Y,x
	sec
	sbc #kScaledSpriteSeparationValue*2
	sta GameSpriteWorld_Y,y
	lda GameSpriteWorld_X,x
	sta GameSpriteWorld_X,y
	lda GameSpriteWorld_Z,x
	sta GameSpriteWorld_Z,y
	lda #kVarsEmitSpriteFrame_scaled_0_64_0_tileIndex
	sta GameSpriteWorld_Frame,y
	lda #kVarsEmitSpriteFrame_scaled_0_64_0_colour
	sta GameSpriteWorld_Palette,y

	jmp .notFree
.os4

	jsr Rand
	and #3
	+lbne .os5

	jsr ScaledSetupPosition
	lda GameSpriteWorld_X,x
	cmp #127-kScaledSpriteSeparationValue
	bcc .okPos1
	lda #127-kScaledSpriteSeparationValue
	sta GameSpriteWorld_X,x
.okPos1
	lda GameSpriteWorld_Y,x
	cmp #127-kScaledSpriteSeparationValue
	bcc .okPos2
	lda #127-kScaledSpriteSeparationValue
	sta GameSpriteWorld_Y,x
.okPos2
	lda #kVarsEmitSpriteFrame_scaled_96_32_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_96_32_0_colour
	sta GameSpriteWorld_Palette,x

	; Other sprites in this group
	ldy GameSpriteWorld_SortIndex + kMaxGameSprites - 5 + 1
	lda #0
	sta GameSpriteWorld_IsBullet,y
	lda GameSpriteWorld_X,x
	clc
	adc #kScaledSpriteSeparationValue
	sta GameSpriteWorld_X,y
	lda GameSpriteWorld_Y,x
	sta GameSpriteWorld_Y,y
	lda GameSpriteWorld_Z,x
	sta GameSpriteWorld_Z,y
	lda #kVarsEmitSpriteFrame_scaled_128_32_0_tileIndex
	sta GameSpriteWorld_Frame,y
	lda #kVarsEmitSpriteFrame_scaled_128_32_0_colour
	sta GameSpriteWorld_Palette,y

	ldy GameSpriteWorld_SortIndex + kMaxGameSprites - 5 + 2
	lda #0
	sta GameSpriteWorld_IsBullet,y
	lda GameSpriteWorld_X,x
	sta GameSpriteWorld_X,y
	lda GameSpriteWorld_Y,x
	clc
	adc #kScaledSpriteSeparationValue
	sta GameSpriteWorld_Y,y
	lda GameSpriteWorld_Z,x
	sta GameSpriteWorld_Z,y
	lda #kVarsEmitSpriteFrame_scaled_96_64_0_tileIndex
	sta GameSpriteWorld_Frame,y
	lda #kVarsEmitSpriteFrame_scaled_96_64_0_colour
	sta GameSpriteWorld_Palette,y

	ldy GameSpriteWorld_SortIndex + kMaxGameSprites - 5 + 3
	lda #0
	sta GameSpriteWorld_IsBullet,y
	lda GameSpriteWorld_X,x
	clc
	adc #kScaledSpriteSeparationValue
	sta GameSpriteWorld_X,y
	lda GameSpriteWorld_Y,x
	clc
	adc #kScaledSpriteSeparationValue
	sta GameSpriteWorld_Y,y
	lda GameSpriteWorld_Z,x
	sta GameSpriteWorld_Z,y
	lda #kVarsEmitSpriteFrame_scaled_128_64_0_tileIndex
	sta GameSpriteWorld_Frame,y
	lda #kVarsEmitSpriteFrame_scaled_128_64_0_colour
	sta GameSpriteWorld_Palette,y

	jmp .notFree
.os5

	jsr Rand
	and #3
	bne .os6

	jsr ScaledSetupPositionWithoutY
	lda GameSpriteWorld_X,x
	cmp #127-kScaledSpriteSeparationValue
	bcc .okPos3
	lda #127-kScaledSpriteSeparationValue
	sta GameSpriteWorld_X,x
.okPos3
	lda #127
	sta GameSpriteWorld_Y,x
	lda #kVarsEmitSpriteFrame_scaled_192_32_0_tileIndex
	sta GameSpriteWorld_Frame,x
	lda #kVarsEmitSpriteFrame_scaled_192_32_0_colour
	sta GameSpriteWorld_Palette,x

	; Other sprites in this group
	ldy GameSpriteWorld_SortIndex + kMaxGameSprites - 5 + 1
	lda #0
	sta GameSpriteWorld_IsBullet,y
	lda GameSpriteWorld_X,x
	clc
	adc #kScaledSpriteSeparationValue
	sta GameSpriteWorld_X,y
	lda GameSpriteWorld_Y,x
	sta GameSpriteWorld_Y,y
	lda GameSpriteWorld_Z,x
	sta GameSpriteWorld_Z,y
	lda #kVarsEmitSpriteFrame_scaled_224_32_0_tileIndex
	sta GameSpriteWorld_Frame,y
	lda #kVarsEmitSpriteFrame_scaled_224_32_0_colour
	sta GameSpriteWorld_Palette,y

	jmp .notFree
.os6

.notFree

	; Seeds the random number generator
	dec .seedCount
	bne .o2
.smc1	lda #0
.smc2	ldy #0
	inc .smc1+1
	bne .o1
	inc .smc2+1
.o1
	jsr Seed
.o2


	jmp .gameLoop1

.charConvTab
	!fill 'a' , 0
!for .i , 26 {
	!by kVarsEmitSpriteFrame_scaled_32_128_0_tileIndex + .i -1
}
kCarriageReturn = 1
kDoTimeWaste = 2
kResetTextPos = 3

.displayNames
	!by kCarriageReturn
	!by kCarriageReturn
	!tx " this" , kCarriageReturn
	!tx "  is" , kCarriageReturn
	!tx " mega" , kCarriageReturn
	!tx " wang" , kCarriageReturn
	!by kDoTimeWaste
!if 1 {
	!by kResetTextPos
	!tx "thank" , kCarriageReturn
	!tx "you" , kCarriageReturn
	!tx "to my" , kCarriageReturn
	!by kDoTimeWaste
	!tx "twitter" , kCarriageReturn
	!tx "fam" , kCarriageReturn
	!by kDoTimeWaste
	!by kResetTextPos
	!tx "pcbway" , kCarriageReturn
	!tx "elaine" , kCarriageReturn
	!by kDoTimeWaste
	!by kResetTextPos
	!tx "for" , kCarriageReturn
	!tx "working" , kCarriageReturn
	!tx "pcbs" , kCarriageReturn
	!by kDoTimeWaste
	!by kResetTextPos
}
	!by 0	; End of text...

.seedCount !by 0

ScaledSetupPosition
	jsr Rand
	sta GameSpriteWorld_Y,x
ScaledSetupPositionWithoutY
	jsr Rand
	and #63
	clc
	adc #128
	sta GameSpriteWorld_Z,x
	jsr Rand
	sta GameSpriteWorld_X,x
	lda #0
	sta GameSpriteWorld_IsBullet,x
	rts


Sprite2Tab_ScaleToYSize
!for .zz , 256 {
!set .z = .zz-1
!if .z <= 1 {
!set .z = 1
}
!set .realSize = (32*32) / .z
!set .realSize = <.realSize
!if .realSize < 1 {
!set .realSize = 1
}
	!by .realSize
}

Sprite2Tab_ScaleYSize
!for .zz , kEntries {
!set .z = kNearPoint - ((kEntries-.zz) + kFarPoint)
!set .size = (kMultiplier * 96) / .z
!if .size <= 0 {
!set .size = 1
}
!set .invscale = (32 * 32) / .size
!if .invscale <= 1 {
!set .invscale = 1
}
; Need to calculate the height based on the scale
!set .realSize = (32*32) / int(.invscale)
; Using *32 (<<5) means it's not possible for the sprite to go below 4 pixels wide if the X end point is set to be 0x20.
; This is because (32*32) / 255 ~= 4
; Mitigations are to set the end point to be 0x10 and draw half the sprite, which should suffice in most cases.
; This particular numeric range was chosen to give the sprite "scale up", where it gets larger, a little more accuracy.
; However the Y height can be reduced to be smaller than 4 pixels
!if .invscale >= 255 {
!set .invscale = 255
}
!if .realSize < 1 {
!set .realSize = 1
}
	!by .invscale
	!by .realSize
}

+MCheckNotInMemoryRange_C64Cartridge_Lo_8K
Sprite2Tab_PerspectiveTabStart
Sprite2Tab_PerspectiveTabLo
!for .i , kMaxSwing {
	!by < (Sprite2Tab_Perspective + ((.i-1)*kEntries))
}
Sprite2Tab_PerspectiveTabHi
!for .i , kMaxSwing {
	!by > (Sprite2Tab_Perspective + ((.i-1)*kEntries))
}
!align 255 , 0
Sprite2Tab_Perspective
!for .i , kMaxSwing {
+MCheckNotInMemoryRange_C64Cartridge_Lo_8K
!for .zz , kEntries {
!set .z = kNearPoint - ((kEntries-.zz) + kFarPoint)
	!by ((kMultiplier * 255 * .i) / kMaxSwing) / .z
}
}
Sprite2Tab_PerspectiveTabEnd
+MCheckNotInMemoryRange_C64Cartridge_Lo_8K

} ;< !ifndef IncludeGraphicsData {
} ;< !ifndef MinimalMusicDemoTest {

!zn
DisplayData
	jsr Video_SetAddressPalette
	+MWordValueTo_AX GamePalette
	ldy #0
	jsr Bus24Bit_CopySmallData
	jsr Bus24Bit_CopySmallDataAgain
;	; Clear the last transparent background colour to black
;	jsr Video_SetAddressPalette
;	+MBus24Bit_SendLE16BitValue 0
	inc VIC2BorderColour
!ifdef kJustForLogoMonchrome {
	jsr Video_SetAddressPalette
	ldy #16
.p1
	ldx #15
	+MBus24Bit_SendPaletteRGB 255 , 255 , 255
.p2
	+MBus24Bit_SendPaletteRGB 0 , 0 , 0
	dex
	bne .p2
	dey
	bne .p1
}

!ifdef IncludeGraphicsData_L1 {
	+MDecompressRLEToEBBSAddr .Sprites2Data0 , $08 , $2000
	+MDecompressRLEToEBBSAddr .Sprites2Data1 , $08 , $4000
	+MDecompressRLEToEBBSAddr .Sprites2Data2 , $08 , $8000
	+MDecompressRLEToEBBSAddr .Sprites2Data3 , $08 , $0000
}

!ifdef IncludeGraphicsData_L2a {
	+MRLEScreenDataToDefaultCharScreen .Chars_map , .Chars_map2
}
!ifdef IncludeGraphicsData_L2b {
	+MRLEPlanesDataToDefaultCharScreen .Chars_plane0 , .Chars_plane1 , .Chars_plane2 , .Chars_plane3
}

!ifdef IncludeGraphicsData_L3 {
	+MRLEScreenDataToDefaultTileScreen .Tiles_map
	+MRLEPlanesDataToDefaultTileScreen .Tiles_plane0 , .Tiles_plane1 , .Tiles_plane2 , .Tiles_plane3
}

!ifdef IncludeGraphicsData_L4 {
	+MRLEPlanesDataToDefaultSprite .Sprites_plane0 , .Sprites_plane1 , .Sprites_plane2 , .Sprites_plane3
}

	rts

!ifdef IncludeMusicDataDecomp1 {
MusicSampleData1
	+MDecompressRLEToEBBSAddr .MusicSampleData1 , $04 , $0000
	rts
.MusicSampleData1 !bin "tmp/target/MusicMW2000Samples.cmp1"
}
!ifdef IncludeMusicDataDecomp2 {
MusicSampleData2
	+MDecompressRLEToEBBSAddr .MusicSampleData2 , $04 , $8000
	rts
.MusicSampleData2 !bin "tmp/target/MusicMW2000Samples.cmp2"
}

GamePalette
	!bin "tmp/Demo9PaletteData.bin"
	!fill 256,0

!ifdef IncludeGraphicsData_L1 {
.Sprites2Data0 !bin "tmp/Demo9Sprites20.cmp"
.Sprites2Data1 !bin "tmp/Demo9Sprites21.cmp"
.Sprites2Data2 !bin "tmp/Demo9Sprites22.cmp"
.Sprites2Data3 !bin "tmp/Demo9Sprites23.cmp"
}

!ifdef IncludeGraphicsData_L2a {
.Chars_map
	!bin "tmp/Demo9Chars_map.cmp"
.Chars_map2
	!bin "tmp/Demo9Chars_map.cmp2"
}

!ifdef IncludeGraphicsData_L2b {
.Chars_plane0
	!bin "tmp/Demo9Chars_plane0.cmp"
.Chars_plane1
	!bin "tmp/Demo9Chars_plane1.cmp"
.Chars_plane2
	!bin "tmp/Demo9Chars_plane2.cmp"
.Chars_plane3
	!bin "tmp/Demo9Chars_plane3.cmp"
}

!ifdef IncludeGraphicsData_L3 {
.Tiles_map
	!bin "tmp/Demo9Tiles_map.cmp"
.Tiles_plane0
	!bin "tmp/Demo9Tiles_plane0.cmp"
.Tiles_plane1
	!bin "tmp/Demo9Tiles_plane1.cmp"
.Tiles_plane2
	!bin "tmp/Demo9Tiles_plane2.cmp"
.Tiles_plane3
	!bin "tmp/Demo9Tiles_plane3.cmp"
}

!ifdef IncludeGraphicsData_L4 {
.Sprites_plane0
	!bin "tmp/Demo9Sprites10.cmp"
.Sprites_plane1
	!bin "tmp/Demo9Sprites11.cmp"
.Sprites_plane2
	!bin "tmp/Demo9Sprites12.cmp"
.Sprites_plane3
	!bin "tmp/Demo9Sprites13.cmp"
}




TotalAPU_Start

APUCode_Start
!pseudopc 0 {
frameStart0
	+MAPU
	+MAPU kAPU_Reset_ADDRB1

	; Get EBSEADDR values
	+MAPU kAPU_Load_EBS | kAPU_Load_EBS2
	+MAPU kAPU_Incr_ADDRB1

	; Load APULineScrolls
	+MAPU kAPU_IDataRegLoad0
	+MAPU kAPU_Incr_ADDRB1
	+MAPU kAPU_IDataRegLoad1
	+MAPU kAPU_Incr_ADDRB1
	+MAPU kAPU_ADDRB2Load16

	; Top of screen
	+MAPU_LoadDoWait
	; Reset the merge layer dither
	+MAPU_ProcessRasterByte
	+MAPU_ProcessRasterWord
	+MAPU_ProcessRasterWord

	; During the floor update
	; ADDRB1 = APULineWaits
	; ADDRB2 = APULineScrolls

	; Floor
	; For <kBus24Bit_TileScreen_ScrollX16
	+MAPU kAPU_IDataRegLoad2
	+MAPU kAPU_Incr_ADDRB1
	; For kBus24Bit_MergeLayer_Register_XORMask1
	+MAPU_LoadEADDR2FromB1
	; APUFloorLoop
	+MAPU kAPU_IDataRegLoad0
	+MAPU kAPU_Incr_ADDRB1
	+MAPU kAPU_IDataRegLoad1
	+MAPU kAPU_Incr_ADDRB1
	; kAPUNumFloorRows and 1
	+MAPU kAPU_IDataRegLoad3
	+MAPU kAPU_Incr_ADDRB1
	+MAPU kAPU_IDataRegLoad4
	+MAPU kAPU_Incr_ADDRB1

	; APULineScrolls
	; Remaining lines
APUFloorLoop
	+MAPU_LoadDoWait

	; Restore EADDRLo
	+MAPU kAPU_Load_EADDRLo | kAPU_IDataSelectReg2
	+MAPU_ProcessWordB2
	+MAPU_ProcessWordB2

	; Update kBus24Bit_MergeLayer_Register_XORMask1
	+MAPU kAPU_ExternalMEWR | kAPU_SelectEBS2EADDR2 | kAPU_ADDRB2Select
	+MAPU kAPU_Incr_ADDRB2

	+MAPU kAPU_IDataSelectReg3SubReg4 | kAPU_IDataRegLoad3
	+MAPU kAPU_IDataSelectReg3
	+MAPU kAPU_PCLoad16 | kAPU_SkipIfEQ | kAPU_IDataSelectReg3

	+MAPU kAPU_Reset_PC
	+MAPU
}

APUCode_Size = *-APUCode_Start

!if APUCode_Size > 8192 {
	!error "APUCode_Size too large"
}

APUData_Start
	!by $01
	+MLittleEndian16Bit APULineScrolls - APUData_Start

	; Top of screen
	+MAPU_EmitWait kBus24Bit_VideoLayer_XPos_HSYNC_start - kMAPUEmitChangePaletteIndexHSyncAdjust , 12
	; Reset the merge layer dither
	+MLittleEndian16Bit kBus24Bit_MergeLayer_Register_XORMask1
	!by 0
	+MAPUEmitChangeXScrollValue ~APU_TopScreenScrollX , -20
	+MAPUEmitChangeYScrollValue ~APU_TopScreenScrollY , -16


	; Floor
	!by <kBus24Bit_TileScreen_ScrollX16
	!word kBus24Bit_MergeLayer_Register_XORMask1
	!word APUFloorLoop / kAPU_InstructionSize
	!by kAPUNumFloorRows
	!by 1

	; Remaining lines
APULineWaits
!for .i , kAPUNumFloorRows {
	+MAPU_EmitWait kBus24Bit_VideoLayer_XPos_HSYNC_start , 128 + .i -1
}

APULineScrolls
;	!fill kAPUNumFloorRows , 0
;	!fill kAPUNumFloorRows , 0
;	!fill kAPUNumFloorRows , 0
;	!fill kAPUNumFloorRows , 0

APUData_Size = * -APUData_Start

!if APUData_Size > 8192 {
	!error "APUData_Size too large"
}

TotalAPU_Size = * - TotalAPU_Start

SetupAPU
	jsr APU_SetAddressAPUInstructions
	+MWordValueTo_AX APUCode_Start
	ldy #<APUCode_Size
	jsr Bus24Bit_CopySmallData
!if >APUCode_Size > 0 {
	ldx #>APUCode_Size
	jsr Bus24Bit_CopySmallDataRepeatForX
}
	jsr APU_SetAddressAPUData
	+MWordValueTo_AX APUData_Start
	ldy #<APUData_Size
	jsr Bus24Bit_CopySmallData
!if >APUData_Size > 0 {
	ldx #>APUData_Size
	jsr Bus24Bit_CopySmallDataRepeatForX
}
	rts

!ifdef MusicData {
MusicDataStart
MusicDataStart_afterHeader = MusicDataStart + 4
	!bin "tmp/target/MusicMW2000Events.cmp"
MusicDataEnd
}

* = VIC2_Bank3
!macro MCommonWorld_ViewPosZ {
	clc
	tya
	beq .o1
	adc World_ViewPosZ
	lsr
	lsr
	lsr
	lsr
	and #1
.o1
	+MBus24Bit_Send8BitValueFromA
}

+MCheckNotInIOKernal
!zn
; Entry:
; A = View X (signed)
; Y = View Y (signed)
SendAPUAPULineScrolls
	pha

	; Setup the correct ROM bank for the height lookup
	tya
	clc
	adc #128
	+M_ASR
	and #$7f	; Safety
	tay
	; Setup the data start address
	lda HeightToRowsAddress,y
	sta zeroPage_Temp0
	lda HeightToRowsAddress + 128,y
	sta zeroPage_Temp1
	lda HeightToRowsBank,y
	jsr CartSelectBank_8K_NoSEI

	pla
	eor #$ff
	clc
	adc #1
	+M_ASR

	cmp #0
	beq .noX
	bpl .isPosX
	jmp .isNegX
.noX

	; Debug: Choose pointer arithmatic of a specific table
!if 1 {
	+MAddr16toAddr_A zeroPage_Temp0 , .smnxph1 + 1
	+MAddU8From16ToAddr16 kAPUNumFloorRows , .smnxph1 + 1 , .smnxph1 + 2 , .smnxph2 + 1 , .smnxph2 + 2
	+MAddU8From16ToAddr16 kAPUNumFloorRows , .smnxph2 + 1 , .smnxph2 + 2 , .smnxph3 + 1 , .smnxph3 + 2
} else {
	lda #CartFile1_Bank_HeightToRows1_hor
	jsr CartSelectBank_8K_NoSEI
}
	+MAPU_SetDataUpdateBus APULineScrolls
	ldx #0
.l1
	+MBus24Bit_SendLE16BitValue 68

.smnxph3	ldy CartFile1_Start_HeightToRows1_hor + kAPUNumFloorRows + kAPUNumFloorRows,x
.smnxph1	lda CartFile1_Start_HeightToRows1_hor,x
	+MBus24Bit_Send8BitValueFromA
.smnxph2	lda CartFile1_Start_HeightToRows1_hor + kAPUNumFloorRows,x
	+MBus24Bit_Send8BitValueFromA

	+MCommonWorld_ViewPosZ

	inx
	cpx #kAPUNumFloorRows
	bne .l1

	jsr CartKillBank

	rts

.isPosX
	tay
	lda Sprite2Tab_PerspectiveTabLo-1,y
	sta .smxp3p+1
	lda Sprite2Tab_PerspectiveTabHi-1,y
	sta .smxp3p+2

	+MAddr16toAddr_A zeroPage_Temp0 , .smnxph1p + 1
	+MAddU8From16ToAddr16 kAPUNumFloorRows , .smnxph1p + 1 , .smnxph1p + 2 , .smnxph2p + 1 , .smnxph2p + 2
	+MAddU8From16ToAddr16 kAPUNumFloorRows , .smnxph2p + 1 , .smnxph2p + 2 , .smnxph3p + 1 , .smnxph3p + 2

	+MAPU_SetDataUpdateBus APULineScrolls
	ldx #0
.l1p
	+MWordValueToAddress_A 68 , zeroPage_Temp0


.smnxph3p	ldy $1234,x
.smxp3p lda $1234,y
	+MAddAToAddr16 zeroPage_Temp0 , zeroPage_Temp1

	lda zeroPage_Temp0
	+MBus24Bit_Send8BitValueFromA
	lda zeroPage_Temp1
	+MBus24Bit_Send8BitValueFromA

.smnxph1p	lda $1234,x
	+MBus24Bit_Send8BitValueFromA
.smnxph2p	lda $1234 + kAPUNumFloorRows,x
	+MBus24Bit_Send8BitValueFromA

	+MCommonWorld_ViewPosZ

	inx
	cpx #kAPUNumFloorRows
	bne .l1p

	jsr CartKillBank

	rts

.isNegX
	eor #$ff
	tay
	lda Sprite2Tab_PerspectiveTabLo,y
	sta .smxp3n+1
	lda Sprite2Tab_PerspectiveTabHi,y
	sta .smxp3n+2

	+MAddr16toAddr_A zeroPage_Temp0 , .smnxph1n + 1
	+MAddU8From16ToAddr16 kAPUNumFloorRows , .smnxph1n + 1 , .smnxph1n + 2 , .smnxph2n + 1 , .smnxph2n + 2
	+MAddU8From16ToAddr16 kAPUNumFloorRows , .smnxph2n + 1 , .smnxph2n + 2 , .smnxph3n + 1 , .smnxph3n + 2

	+MAPU_SetDataUpdateBus APULineScrolls
	ldx #0
.l1n
	+MWordValueToAddress_A 68 , zeroPage_Temp0

.smnxph3n	ldy $1234,x
.smxp3n lda $1234,y
	sta zeroPage_Temp2
	+MSubU8AddrToAddr16 zeroPage_Temp2 , zeroPage_Temp0 , zeroPage_Temp1

	lda zeroPage_Temp0
	+MBus24Bit_Send8BitValueFromA
	lda zeroPage_Temp1
	+MBus24Bit_Send8BitValueFromA

.smnxph1n	lda $1234,x
	+MBus24Bit_Send8BitValueFromA
.smnxph2n	lda $1234 + kAPUNumFloorRows,x
	+MBus24Bit_Send8BitValueFromA

	+MCommonWorld_ViewPosZ

	inx
	cpx #kAPUNumFloorRows
	bne .l1n

	jsr CartKillBank

	rts
+MCheckNotInIOKernal

!source "tmp/_f_index1.a"
HeightToRowsBank
	!by CartFile1_Bank_HeightToRows0_hor
	!by CartFile1_Bank_HeightToRows1_hor
	!by CartFile1_Bank_HeightToRows2_hor
	!by CartFile1_Bank_HeightToRows3_hor
	!by CartFile1_Bank_HeightToRows4_hor
	!by CartFile1_Bank_HeightToRows5_hor
	!by CartFile1_Bank_HeightToRows6_hor
	!by CartFile1_Bank_HeightToRows7_hor
	!by CartFile1_Bank_HeightToRows8_hor
	!by CartFile1_Bank_HeightToRows9_hor

	!by CartFile1_Bank_HeightToRows10_hor
	!by CartFile1_Bank_HeightToRows11_hor
	!by CartFile1_Bank_HeightToRows12_hor
	!by CartFile1_Bank_HeightToRows13_hor
	!by CartFile1_Bank_HeightToRows14_hor
	!by CartFile1_Bank_HeightToRows15_hor
	!by CartFile1_Bank_HeightToRows16_hor
	!by CartFile1_Bank_HeightToRows17_hor
	!by CartFile1_Bank_HeightToRows18_hor
	!by CartFile1_Bank_HeightToRows19_hor

	!by CartFile1_Bank_HeightToRows20_hor
	!by CartFile1_Bank_HeightToRows21_hor
	!by CartFile1_Bank_HeightToRows22_hor
	!by CartFile1_Bank_HeightToRows23_hor
	!by CartFile1_Bank_HeightToRows24_hor
	!by CartFile1_Bank_HeightToRows25_hor
	!by CartFile1_Bank_HeightToRows26_hor
	!by CartFile1_Bank_HeightToRows27_hor
	!by CartFile1_Bank_HeightToRows28_hor
	!by CartFile1_Bank_HeightToRows29_hor

	!by CartFile1_Bank_HeightToRows30_hor
	!by CartFile1_Bank_HeightToRows31_hor
	!by CartFile1_Bank_HeightToRows32_hor
	!by CartFile1_Bank_HeightToRows33_hor
	!by CartFile1_Bank_HeightToRows34_hor
	!by CartFile1_Bank_HeightToRows35_hor
	!by CartFile1_Bank_HeightToRows36_hor
	!by CartFile1_Bank_HeightToRows37_hor
	!by CartFile1_Bank_HeightToRows38_hor
	!by CartFile1_Bank_HeightToRows39_hor

	!by CartFile1_Bank_HeightToRows40_hor
	!by CartFile1_Bank_HeightToRows41_hor
	!by CartFile1_Bank_HeightToRows42_hor
	!by CartFile1_Bank_HeightToRows43_hor
	!by CartFile1_Bank_HeightToRows44_hor
	!by CartFile1_Bank_HeightToRows45_hor
	!by CartFile1_Bank_HeightToRows46_hor
	!by CartFile1_Bank_HeightToRows47_hor
	!by CartFile1_Bank_HeightToRows48_hor
	!by CartFile1_Bank_HeightToRows49_hor

	!by CartFile1_Bank_HeightToRows50_hor
	!by CartFile1_Bank_HeightToRows51_hor
	!by CartFile1_Bank_HeightToRows52_hor
	!by CartFile1_Bank_HeightToRows53_hor
	!by CartFile1_Bank_HeightToRows54_hor
	!by CartFile1_Bank_HeightToRows55_hor
	!by CartFile1_Bank_HeightToRows56_hor
	!by CartFile1_Bank_HeightToRows57_hor
	!by CartFile1_Bank_HeightToRows58_hor
	!by CartFile1_Bank_HeightToRows59_hor

	!by CartFile1_Bank_HeightToRows60_hor
	!by CartFile1_Bank_HeightToRows61_hor
	!by CartFile1_Bank_HeightToRows62_hor
	!by CartFile1_Bank_HeightToRows63_hor
	!by CartFile1_Bank_HeightToRows64_hor
	!by CartFile1_Bank_HeightToRows65_hor
	!by CartFile1_Bank_HeightToRows66_hor
	!by CartFile1_Bank_HeightToRows67_hor
	!by CartFile1_Bank_HeightToRows68_hor
	!by CartFile1_Bank_HeightToRows69_hor

	!by CartFile1_Bank_HeightToRows70_hor
	!by CartFile1_Bank_HeightToRows71_hor
	!by CartFile1_Bank_HeightToRows72_hor
	!by CartFile1_Bank_HeightToRows73_hor
	!by CartFile1_Bank_HeightToRows74_hor
	!by CartFile1_Bank_HeightToRows75_hor
	!by CartFile1_Bank_HeightToRows76_hor
	!by CartFile1_Bank_HeightToRows77_hor
	!by CartFile1_Bank_HeightToRows78_hor
	!by CartFile1_Bank_HeightToRows79_hor

	!by CartFile1_Bank_HeightToRows80_hor
	!by CartFile1_Bank_HeightToRows81_hor
	!by CartFile1_Bank_HeightToRows82_hor
	!by CartFile1_Bank_HeightToRows83_hor
	!by CartFile1_Bank_HeightToRows84_hor
	!by CartFile1_Bank_HeightToRows85_hor
	!by CartFile1_Bank_HeightToRows86_hor
	!by CartFile1_Bank_HeightToRows87_hor
	!by CartFile1_Bank_HeightToRows88_hor
	!by CartFile1_Bank_HeightToRows89_hor

	!by CartFile1_Bank_HeightToRows90_hor
	!by CartFile1_Bank_HeightToRows91_hor
	!by CartFile1_Bank_HeightToRows92_hor
	!by CartFile1_Bank_HeightToRows93_hor
	!by CartFile1_Bank_HeightToRows94_hor
	!by CartFile1_Bank_HeightToRows95_hor
	!by CartFile1_Bank_HeightToRows96_hor
	!by CartFile1_Bank_HeightToRows97_hor
	!by CartFile1_Bank_HeightToRows98_hor
	!by CartFile1_Bank_HeightToRows99_hor

	!by CartFile1_Bank_HeightToRows100_hor
	!by CartFile1_Bank_HeightToRows101_hor
	!by CartFile1_Bank_HeightToRows102_hor
	!by CartFile1_Bank_HeightToRows103_hor
	!by CartFile1_Bank_HeightToRows104_hor
	!by CartFile1_Bank_HeightToRows105_hor
	!by CartFile1_Bank_HeightToRows106_hor
	!by CartFile1_Bank_HeightToRows107_hor
	!by CartFile1_Bank_HeightToRows108_hor
	!by CartFile1_Bank_HeightToRows109_hor

	!by CartFile1_Bank_HeightToRows110_hor
	!by CartFile1_Bank_HeightToRows111_hor
	!by CartFile1_Bank_HeightToRows112_hor
	!by CartFile1_Bank_HeightToRows113_hor
	!by CartFile1_Bank_HeightToRows114_hor
	!by CartFile1_Bank_HeightToRows115_hor
	!by CartFile1_Bank_HeightToRows116_hor
	!by CartFile1_Bank_HeightToRows117_hor
	!by CartFile1_Bank_HeightToRows118_hor
	!by CartFile1_Bank_HeightToRows119_hor

	!by CartFile1_Bank_HeightToRows120_hor
	!by CartFile1_Bank_HeightToRows121_hor
	!by CartFile1_Bank_HeightToRows122_hor
	!by CartFile1_Bank_HeightToRows123_hor
	!by CartFile1_Bank_HeightToRows124_hor
	!by CartFile1_Bank_HeightToRows125_hor
	!by CartFile1_Bank_HeightToRows126_hor
	!by CartFile1_Bank_HeightToRows127_hor

; Using " 3 + " because of the linklist block information saved using "-m" in MakeCart
HeightToRowsAddress
	!word 3 + CartFile1_Start_HeightToRows0_hor
	!word 3 + CartFile1_Start_HeightToRows1_hor
	!word 3 + CartFile1_Start_HeightToRows2_hor
	!word 3 + CartFile1_Start_HeightToRows3_hor
	!word 3 + CartFile1_Start_HeightToRows4_hor
	!word 3 + CartFile1_Start_HeightToRows5_hor
	!word 3 + CartFile1_Start_HeightToRows6_hor
	!word 3 + CartFile1_Start_HeightToRows7_hor
	!word 3 + CartFile1_Start_HeightToRows8_hor
	!word 3 + CartFile1_Start_HeightToRows9_hor

	!word 3 + CartFile1_Start_HeightToRows10_hor
	!word 3 + CartFile1_Start_HeightToRows11_hor
	!word 3 + CartFile1_Start_HeightToRows12_hor
	!word 3 + CartFile1_Start_HeightToRows13_hor
	!word 3 + CartFile1_Start_HeightToRows14_hor
	!word 3 + CartFile1_Start_HeightToRows15_hor
	!word 3 + CartFile1_Start_HeightToRows16_hor
	!word 3 + CartFile1_Start_HeightToRows17_hor
	!word 3 + CartFile1_Start_HeightToRows18_hor
	!word 3 + CartFile1_Start_HeightToRows19_hor

	!word 3 + CartFile1_Start_HeightToRows20_hor
	!word 3 + CartFile1_Start_HeightToRows21_hor
	!word 3 + CartFile1_Start_HeightToRows22_hor
	!word 3 + CartFile1_Start_HeightToRows23_hor
	!word 3 + CartFile1_Start_HeightToRows24_hor
	!word 3 + CartFile1_Start_HeightToRows25_hor
	!word 3 + CartFile1_Start_HeightToRows26_hor
	!word 3 + CartFile1_Start_HeightToRows27_hor
	!word 3 + CartFile1_Start_HeightToRows28_hor
	!word 3 + CartFile1_Start_HeightToRows29_hor

	!word 3 + CartFile1_Start_HeightToRows30_hor
	!word 3 + CartFile1_Start_HeightToRows31_hor
	!word 3 + CartFile1_Start_HeightToRows32_hor
	!word 3 + CartFile1_Start_HeightToRows33_hor
	!word 3 + CartFile1_Start_HeightToRows34_hor
	!word 3 + CartFile1_Start_HeightToRows35_hor
	!word 3 + CartFile1_Start_HeightToRows36_hor
	!word 3 + CartFile1_Start_HeightToRows37_hor
	!word 3 + CartFile1_Start_HeightToRows38_hor
	!word 3 + CartFile1_Start_HeightToRows39_hor

	!word 3 + CartFile1_Start_HeightToRows40_hor
	!word 3 + CartFile1_Start_HeightToRows41_hor
	!word 3 + CartFile1_Start_HeightToRows42_hor
	!word 3 + CartFile1_Start_HeightToRows43_hor
	!word 3 + CartFile1_Start_HeightToRows44_hor
	!word 3 + CartFile1_Start_HeightToRows45_hor
	!word 3 + CartFile1_Start_HeightToRows46_hor
	!word 3 + CartFile1_Start_HeightToRows47_hor
	!word 3 + CartFile1_Start_HeightToRows48_hor
	!word 3 + CartFile1_Start_HeightToRows49_hor

	!word 3 + CartFile1_Start_HeightToRows50_hor
	!word 3 + CartFile1_Start_HeightToRows51_hor
	!word 3 + CartFile1_Start_HeightToRows52_hor
	!word 3 + CartFile1_Start_HeightToRows53_hor
	!word 3 + CartFile1_Start_HeightToRows54_hor
	!word 3 + CartFile1_Start_HeightToRows55_hor
	!word 3 + CartFile1_Start_HeightToRows56_hor
	!word 3 + CartFile1_Start_HeightToRows57_hor
	!word 3 + CartFile1_Start_HeightToRows58_hor
	!word 3 + CartFile1_Start_HeightToRows59_hor

	!word 3 + CartFile1_Start_HeightToRows60_hor
	!word 3 + CartFile1_Start_HeightToRows61_hor
	!word 3 + CartFile1_Start_HeightToRows62_hor
	!word 3 + CartFile1_Start_HeightToRows63_hor
	!word 3 + CartFile1_Start_HeightToRows64_hor
	!word 3 + CartFile1_Start_HeightToRows65_hor
	!word 3 + CartFile1_Start_HeightToRows66_hor
	!word 3 + CartFile1_Start_HeightToRows67_hor
	!word 3 + CartFile1_Start_HeightToRows68_hor
	!word 3 + CartFile1_Start_HeightToRows69_hor

	!word 3 + CartFile1_Start_HeightToRows70_hor
	!word 3 + CartFile1_Start_HeightToRows71_hor
	!word 3 + CartFile1_Start_HeightToRows72_hor
	!word 3 + CartFile1_Start_HeightToRows73_hor
	!word 3 + CartFile1_Start_HeightToRows74_hor
	!word 3 + CartFile1_Start_HeightToRows75_hor
	!word 3 + CartFile1_Start_HeightToRows76_hor
	!word 3 + CartFile1_Start_HeightToRows77_hor
	!word 3 + CartFile1_Start_HeightToRows78_hor
	!word 3 + CartFile1_Start_HeightToRows79_hor

	!word 3 + CartFile1_Start_HeightToRows80_hor
	!word 3 + CartFile1_Start_HeightToRows81_hor
	!word 3 + CartFile1_Start_HeightToRows82_hor
	!word 3 + CartFile1_Start_HeightToRows83_hor
	!word 3 + CartFile1_Start_HeightToRows84_hor
	!word 3 + CartFile1_Start_HeightToRows85_hor
	!word 3 + CartFile1_Start_HeightToRows86_hor
	!word 3 + CartFile1_Start_HeightToRows87_hor
	!word 3 + CartFile1_Start_HeightToRows88_hor
	!word 3 + CartFile1_Start_HeightToRows89_hor

	!word 3 + CartFile1_Start_HeightToRows90_hor
	!word 3 + CartFile1_Start_HeightToRows91_hor
	!word 3 + CartFile1_Start_HeightToRows92_hor
	!word 3 + CartFile1_Start_HeightToRows93_hor
	!word 3 + CartFile1_Start_HeightToRows94_hor
	!word 3 + CartFile1_Start_HeightToRows95_hor
	!word 3 + CartFile1_Start_HeightToRows96_hor
	!word 3 + CartFile1_Start_HeightToRows97_hor
	!word 3 + CartFile1_Start_HeightToRows98_hor
	!word 3 + CartFile1_Start_HeightToRows99_hor

	!word 3 + CartFile1_Start_HeightToRows100_hor
	!word 3 + CartFile1_Start_HeightToRows101_hor
	!word 3 + CartFile1_Start_HeightToRows102_hor
	!word 3 + CartFile1_Start_HeightToRows103_hor
	!word 3 + CartFile1_Start_HeightToRows104_hor
	!word 3 + CartFile1_Start_HeightToRows105_hor
	!word 3 + CartFile1_Start_HeightToRows106_hor
	!word 3 + CartFile1_Start_HeightToRows107_hor
	!word 3 + CartFile1_Start_HeightToRows108_hor
	!word 3 + CartFile1_Start_HeightToRows109_hor

	!word 3 + CartFile1_Start_HeightToRows110_hor
	!word 3 + CartFile1_Start_HeightToRows111_hor
	!word 3 + CartFile1_Start_HeightToRows112_hor
	!word 3 + CartFile1_Start_HeightToRows113_hor
	!word 3 + CartFile1_Start_HeightToRows114_hor
	!word 3 + CartFile1_Start_HeightToRows115_hor
	!word 3 + CartFile1_Start_HeightToRows116_hor
	!word 3 + CartFile1_Start_HeightToRows117_hor
	!word 3 + CartFile1_Start_HeightToRows118_hor
	!word 3 + CartFile1_Start_HeightToRows119_hor

	!word 3 + CartFile1_Start_HeightToRows120_hor
	!word 3 + CartFile1_Start_HeightToRows121_hor
	!word 3 + CartFile1_Start_HeightToRows122_hor
	!word 3 + CartFile1_Start_HeightToRows123_hor
	!word 3 + CartFile1_Start_HeightToRows124_hor
	!word 3 + CartFile1_Start_HeightToRows125_hor
	!word 3 + CartFile1_Start_HeightToRows126_hor
	!word 3 + CartFile1_Start_HeightToRows127_hor
!swizzle HeightToRowsAddress , 128 , 2

+MCheckNotInIOKernal

* = C64Cartridge_Hi_8K
!source "BombJack/stdlib/HardwareTest.a"
!source "..\BerzerkRedux\Rand.a"
!ifdef MusicData {
!source "BombJack/stdlib/Music.a"
}
!source "BombJack/stdlib/Audio.a"
!source "BombJack/stdlib/APU.a"

DrawScoresSprites
	jsr Video_SetAddressSprites
	+SpriteOutput2x2Immediate 20 , 25 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	+SpriteOutput2x2Immediate 42 , 25 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	+SpriteOutput2x2Immediate 64 , 25 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	+SpriteOutput2x2Immediate 86 , 25 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	+SpriteOutput2x2Immediate 108 , 25 , EmitSpriteFrame32_0 , EmitSpriteFrame48_0 , EmitSpriteFrame32_16 , EmitSpriteFrame48_16
	rts
