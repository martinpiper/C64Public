* Art resource notes, moved from BombJack\TODO.txt and enhanced
* https://www.romhacking.net/utilities/641/
	https://opengameart.org/content/rpg-town-pixel-art-assets
	C:\Users\Martin Piper\Downloads\town_rpg_pack\town_rpg_pack
	* Unfortunately the above uses more than 8 colours per 16x16 tile, look for others?
	https://opengameart.org/content/colored-16x16-fantasy-tileset
	Tests worked quite well: https://twitter.com/MartinPiper/status/1218539634847711232
	Other open game art assets:
		https://opengameart.org/content/gradius-clone-sprites
		https://opengameart.org/content/mediumtanks
		https://opengameart.org/users/chabull
		https://opengameart.org/content/16x16-overworld-tiles
		https://opengameart.org/content/forest-tiles

	Map editors: https://www.mapeditor.org/2020/04/14/tiled-1-3-4-released.html
		C:\Downloads\tiled-windows-64bit-snapshot\tiled.exe
		Supports flips, allows export as large image
	https://ogmoeditor.itch.io/editor
	
	A thought, why not use the RPG assets? Those demonstrated by TestData2.txt
		The conversion is already setup, they do not use that many palettes
		Could include all the other graphics, especially for the chars and score panel
			Char screen can overlay shops
		The mode7 layer could be used to draw clouds, or other effects like wipe transitions (zooming circle?), over the sprites and tiles
			https://opengameart.org/content/cloud-set

	Using the ImageToBitplane tool Run/Debug Configuration: Main all conv
		--rgbshift 5 6 5 --newpalettes --forcergb 0 0 0 --paletteoffset 0 --palettesize 8 --startxy 0 0 --image "src/test/resources/map_9 - Copy.png" --tilewh 16 16 --imagequantize 8 --nowritepass --resetforcergb --forcergb 255 0 255 --spritexy 0 0xd0 --startxy 0 0 --image src/test/resources/TestImage1.png --tilewh 16 16 --imagequantize 32 --usestacking --nowritepass --resetforcergb --forcergb 0 0 0 --startxy 0 0 --image "src/test/resources/map_9 - Copy.png" --tilewh 16 16 --imagequantize 8 --outputplanes target/background_plane --outputscrcol target/background_tiles.bin --nostacking --numbitplanes 3 --convertwritepass --nowrite --resetforcergb --forcergb 255 0 255 --spritexy 0 0xd0 --startxy 0 0 --image src/test/resources/TestImage1.png --tilewh 16 16 --imagequantize 32 --outputplanes target/sprite_plane --outputsprites target/spriteSheet.txt --outputpalettes target/PaletteData.bin --usestacking --numbitplanes 3 --convertwritepass
	Using GenerateData configuration: Debug2

	This demonstrates stacked multiplexed sprites over a 16x16 tiled background.

	Using the ImageToBitplane tool Run/Debug Configuration: Main old bridge RGB 0 0 0 palette opt rgbfactor 32
		--rgbshift 5 6 5 --rgbfactor 255 196 112 10 --rgbfactor 255 255 214 50 --rgbfactor 236 98 96 50 --newpalettes --forcergb 0 0 0 --paletteoffset 0 --palettesize 8 --startxy 0 0 --image "src/test/resources/oldbridge cropped.bmp" --tilewh 16 16 --imagequantize 8 --nowritepass --palettequantize 32 --image "src/test/resources/oldbridge cropped.bmp" --tilewh 16 16 --fitpalettes --outputplanes target/background_plane --outputscrcol target/background_tiles.bin --outputpalettes target/PaletteData.bin --nostacking --numbitplanes 3 --convertwritepass

	This demonstrates a detailed background picture with 32 palettes of 8 entries each.
	
	Using the ImageToBitplane tool Run/Debug Configuration: Main mode7 "map_9 - mode7 test.png"
		--rgbshift 5 6 5 --palettesize 256 --loadpalette target/PaletteData.bin --image "src/test/resources/map_9 - mode7 test.png" --tilewh 16 16 --fitpalettes --outputtilebytes target/mode7_tiles.bin --outputscrcol target/mode7_screen.bin --nostacking --convertwritepass
		And enabling the data load at: ; Write Mode7 registers
		This will demonstrate how the mode7 export with flipped tile detection works

		
		
* Need to setup graphics conversion pipeline
	https://opengameart.org/content/rpg-town-pixel-art-assets
		C:\Users\Martin Piper\Downloads\town_rpg_pack
		town_rpg_pack\graphics\hero.png
		town_rpg_pack\graphics\npc.png
			Combined into: assets\sprites.png
	https://opengameart.org/content/colored-16x16-fantasy-tileset
		C:\Users\Martin Piper\Downloads\color_tileset_16x16_Jerom&amp;Eiyeron_CC-BY-SA-3.0_8.png
			Renamed: assets\map tiles.png
	
	* map/tiles created for use with Tiled map editor: assets\map.tmx and assets\RPG.tsx
		Menu->File->Export as image: assets\map.png


	https://opengameart.org/content/cloud-set
		assets\cloud tiles.png
	* map/tiles created for use with Tiled map editor: assets\clouds.tmx and assets\clouds.tsx
		Menu->File->Export as image: assets\clouds.png

	What should be transparent has been changed to be RGB 255,0,255 in all of the above

		
	* Conversion command line for assets
		assets\convert.bat



* Need a good fast way to output stacked sprite sheets for 6502 code
	Optional macro to increment something to count real sprites
		See macros: MEmitSpriteFrame MEmitSpriteFrame_Preserve MEmitSpriteFrame_RestoreExit



* AnimationEngine_Update can be optimised for display/goto/stop/delete by removing the by making MAnimationType* all the same size and removing kAnimationType_size*
	frame routine lo/hi
	stop = hi 0
	delete = hi 1
	otherwise goto = hi/lo address (then no need for any addition code, just store)


* Make SDK bat



* When the screen scrolls the other animations are moved
	Include an off screen check



* Add subtle cloud scaling/sheer/rotate



* When EmitSpriteFrame_count < (24-3) (3 being the most complex stacked sprite in spriteSheet.a)
	Then consider spawning a new sprite on one of the screen edges
	Can use the random number generator in Citadel
		Which would need adding to the SDK build



* Characters move around



* Some clouds horizontally flipped to give more variation



* Added mode7 top down test, yes it looks like Thunder Blade (main.a: Mode7LayersEnable): https://twitter.com/MartinPiper/status/1273987207863267328



* Improved the Mode7LayersEnable documentation. The perpsective effect now has its own scenario.




* When Mode7LayersEnable is enabled, figure out the mathematical relationship with Mode7LayerX/YPos, Mode7Layer0Scale, Mode7Layer1Scale and Mode7Layer2Scale and Mode7Regs0/1/2_x/ypos
	To get the vanishing point in the middle of the screen, the different scales seem to need some extra tweaks?
		e.g. "((Mode7LayerXPos*5)/4) * Mode7Layer2Scale" compared to "(Mode7LayerXPos/2) * Mode7Layer1Scale" compared to "Mode7LayerXPos * Mode7Layer0Scale"
		Trying to simplify, the calculation now uses consistent: Mode7LayerAccuracy = $100
			Far		$200:	(Mode7LayerXPos * Mode7LayerAccuracy * 5)/2				((Mode7LayerXPos*5)/4) * Mode7Layer2Scale
			Middle	$100:	Mode7LayerXPos * Mode7LayerAccuracy						Mode7LayerXPos * Mode7Layer0Scale
			Near	$80:	(Mode7LayerXPos * Mode7LayerAccuracy)/4					(Mode7LayerXPos/2) * Mode7Layer1Scale
		* Now changed to use:
			Mode7Layer1Scale = $80
			Mode7Layer1Multiplier = 1
			Mode7Layer1Divider = 2
			Mode7Layer0Scale = $100
			Mode7Layer0Multiplier = 1
			Mode7Layer0Divider = 1
			Mode7Layer2Scale = $200
			Mode7Layer2Multiplier = 5
			Mode7Layer2Divider = 4
		* After making Mode7Layer*Divider = 256 then the ratios for Mode7Layer*Multiplier become clearer
			Graphing it: https://docs.google.com/spreadsheets/d/1QBX7a31QZNNJsE-wVR33rMleGYEHlFAiU6XOTCAHLBU/edit?usp=sharing
			Obviously some kind of (1+x)/(1/x)
				https://docs.google.com/spreadsheets/d/1QBX7a31QZNNJsE-wVR33rMleGYEHlFAiU6XOTCAHLBU/edit#gid=0
		* Created: !macro TransformPositionTo24Bit .pos , .scale




* Create a table to allow zoom to be updated in realtime. The 24 bit offset position can be added to this base value for the different scales
	Fire + up/down to zoom in or out ("fly" up and down)




* For @Demo3
	https://www.spriters-resource.com/arcade/arkanoid/



* BatBall
	Done - Add shadows	
	Done - Add simple enemy movement
		Can use 16 bits, then just use the high byte for screen pos
	Done - Add first ball sprites
	Done - Add brick characters
	Done - Add example level bricks
		BlockSet
			BlockScreen will be updated to indcate if it is the left or right hand portion of the block
	Done - Add simple ball movement



* Tidy main3.a



* BatBall : Remove collided blocks
	BlockRemoveChecks removes the blocks with 0 chars
	Done - Need to remove with actual chars from the correct position



* Main3Anim (Arkanoid large ship animation)
	https://www.youtube.com/watch?v=QCfnri9hefQ
	Note the intro sequence shows the ship being damaged, but no green teleport effect
	Also note the game win sequence shows the ship being repaired and the green teleport effect
	These two sequences are not more than 16 frames each, even though there are 20 frames in total
	While converting all of the 20 frames to 8x8 chars gives:
		num tiles=277
		num palettes=9
	The 20 (or even 16) screens are too many, even for the banked char screen (at 2x2 = 4 banks) to display
	However when using the tile layer which has 4x4 = 16 screens:
		java -jar ..\..\..\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --forcergb 255 0 255 --paletteoffset 0 --palettesize 8 --imagequantize 8 --startxy 0 0 --image BatBall\ShipAnim.png --tilewh 16 16 --outputplanes ../tmp/BatBallAnim_plane --outputscrcol ../tmp/BatBallAnim_map.bin --outputpalettes ../tmp/BatBallAnim_palette.bin --numbitplanes 3 --convertwritepass
		num tiles=114
		num palettes=10
	The tile layer can easily store the animations for the intro and outro separately
	* Re-arrange the file so that the frames used in the intro/outro are converted into two "banks" of the large virtual tile screen
		4x4 and another 4x4 map underneath, giving 4x8 in total
		Use the assembler to separate out this data
	* This will output one set of tile planes, but provide two tile maps that can be animated using the scroll registers
		This means, the tile board will need to be constructed
	* Alternative: Since the ships are half screen height:
		Black opaque characters, with some optional stars, can be used to blank out the remaining portion
		Or if black opaque 32x32 sprites are used, it would be possible to use one tile map and blank out the required portion of the screen.
		Some sprites will still be available to use for the explosions, flying ship, lasers, player ship etc
	When using 16x16 tiles, the last few frames, the green beaming effect, does not seem to have quite enough colours for the back portion of the effect
		This could be fixed up with sprites if needed
		The 8x8 chars do not have this issue, due to the palette entries for the smaller area being able to cope
		* Perhaps the grey front part of the ship above the green effect is causing the colour palette to be overloaded?
			Moved the entire ship sheet downwards by 8 pixels, this reduced the used tiles from 114 to 106 !!
			This fixed the green effect, but causes problems with the right top small engine yellow highlight
			* So, for now, don't move the sheet



* 1.0.0.4



* Add char layer to the RPG demo
	Score, inventory, health etc



* Ball collision with bat
	Depending on how far from the middle (or to the edges) the ball return X velocity (hence direction) changes
		Cummulative X velocity change
	For MHandleVelocity, if .SpriteFrameData=SpriteFrameDataY then do the bat test and invert the velocity
	* Logo intro?



* Sprite multiplexing test
	https://twitter.com/MartinPiper/status/1348996589352747010
	MSetSpritesBand is used to quickly update sprites while blanking the sprite output
	* The real hardware shows some flicking left/right pixels during the sprite blanked write period, but where registers are written
		This may indicate even during the blanking, the sprites are picking up a fullscreen height sprite definition due to the floating logic
			Which may be fixed with weak pullups (could test this again)
				*** Weak pullups did not solve the issue, so it's a different problem
		Or it may indicate the sprite blanking logic needs to follow what is seen in the chars/tiles layers instead of using the shifter MR
		** After using logic zero for the sprites, the left/right border issue still happens
			This indicates an issue somewhere outside of the sprites plane
			Bus noise perhaps?
		** It is because I am using the low address for the border blanking signal, and the address bus is active during the sprite writes
			I should really be using a proper logic 0 for the border toggle signals :) Which the tiles board supplies
		** Forcing logic 0 from the power header for the horizontal border fixes the issue



* Add Video_StartRasterTimers
	Start two timers, which should count raster position
	Used by the updated "Multiplexor demo"
	Now using syntax: Given video display add CIA1 timers with raster offset 0 , 0



* It should be possible to have the intro logo in the tiles screen at the top of the screen
	With the animating ship in the bottom half of the screen
	With a screen split somewhere in the middle of the screen
	SetMaskingCharScreen would need to have a hole notched into the top of the masking chars
	Using the background colour register it should also be possible to set the background colour
		Use Video_StartRasterTimers and +MWaitValueToMemoryCC 208 , CIA1TimerBLo


* Ship anim was improved (notable the green teleport effect) by moving the "--imagequantize 8" after the --image load :D




* C64\VideoHardware\asm\main3MultiplexAPU.a
	* "Set address to $9a00" can use EADDR2
	* Setting $9820 can use EADDR and registers 0/1
		* EADDR doesn't need to be refreshed for every sprite, since EADDR2 is used for the enable/disable
			It can just count up instead, making the sprite updates a lot quicker
	* $01 can be in reg2
	* Perhaps add one more data dexmux bit which will select an additional one of the EADDR/EADDR2 register lo/hi values giving 8 "registers" in total?
		Use 74151 instead of 74153?
	* Before optimisation: TotalAPU_Size = $10b2
		With partial optimisation: $bbc
		With enable sprites value removed, and setting two sprites per scanline instead of one: $9cd
			APU sprite register enable timing also improved by using: bdd6502.apu.trace




* C64\VideoHardware\asm\main3MultiplexAPU.a
	Using ADDRB2 it should be possible to have all the "Next RHRV to wait for" and "Disable sprites" values separate from the "Sprite data"
		This would make it easier to write the contiguous block of "Sprite data" from the 6502 and update with an animation




* BuildIt6.bat : main6.a : Shadow of the Beast demo with APU
	https://codetapper.com/amiga/sprite-tricks/shadow-of-the-beast/
	https://www.oldgames.sk/docs/sotb/index.html
	APU copper effects work well
	Validated video simulation with: C64\VideoHardware\target\debugData.txt
	* TODO: Done - Blimps, trees (well?), player?, score display, and Done - moon
		Blimps now move in APU data
		TODO Tree! SetupTree - Will need multiplexing




* SotB demo - Using the map editor, tidy the tiles and chars graphics, especially the clouds and mountains so they wrap better. Can also use flipped tiles/chars.




* SotB game chars layer needs to use map generated asset and include more trees and bushes
	Check the number of characters generated



* SotB demo - Player now stands when not running




* Turrican demo on real hardware
	Note: C64\VideoHardware\asm\Turrican\DisplayData.a
		kDoSprites = 1
		;kDoTiles = 1
		;kDoChars = 1
	This needs RLE compression to decompress, so that the RAM and IO spaces are not overlapping in real C64 memory while sending graphics
		Or instead of RLE, make a CRT file that sends data. However this will need emulation support.
		Simpler to use RLE for now
		* Note comment: Note special write byte goes straight to the video hardware and skips C64 memory entirely
			Graphics data finishes at 70d9 .palette



* Test for and remove Bus24Bit_WriteMakeSafeReset is possible. Should be possible, the memory access logic is completly different.




* Update all examples to use the newer hardware
	RPG demo especially will be able to show more sprites as it won't need to stack so many sprites to get the number of colours it needs
		The 8 colour version used 57 stacked sprites, mostly two and sometimes three sprites were stacked
		The 16 colour version uses 35 stacked sprites. mostly one and two sprties, rarely three are stacked
		Conversion to 16 colours done. Things to note: Using "kAnimationEngine_maxSlots = 12" copySprites on a real C64 takes a few scans too long
			Possible to optimise the sprite data calculation by using a pre-calc buffer
			Done: Use StackedSpriteData
			* RPG demo now uses StackedSpriteData which speeds up the sprite data copy
	* Release updated. Minor screen memory updates needed
	* Release3 updated. The logic to restore the video hardware needed updating to accomodate the new resolution and memory address
	* Release4 works



* RPG Demo and Turrican demo needs to use compressed graphics data for the C64 demo
	** For now MusicPoll and !bin "tmp/target/exportedMusicEvents.cmp" has been disabled
	* Also for now, to match the real hardware, the mode7 layer has been disabled and the background colour set to be the tiles layer



* BuildIt7.bat: Super R-Type
	https://www.spriters-resource.com/fullview/73177/?source=genre
	Need to import some sprites
		Sprites done, also added --loadpaletteraw functionality to the conversion image and fixed a palette selection issue when there are forced colour index values set
	* TODO: Try removing: copy /b /y ..\tmp\Demo7PaletteData1.bin + ..\tmp\Demo7PaletteData2.bin + ..\tmp\Demo7PaletteData3.bin ..\tmp\Demo7PaletteData.bin
		Instead use the normal palette selection code and check it produces an overall palette stack of less than 12
		Didn't work :) Background was using wrong palette values




* APU: Verify increment pulse happens at the start of the instruction
	Verify load pulse happens late, like the write pulse
	* Currently the increment and load edge is at the end of the instruction, due to the hi from the signal being made lo for the instruction period, then rising high again with the next instruction
		To introduce a pulse during the instruction would mean an addition of clock logic, very similar to the external memory write.
		This would effectively remove the need to have two instructions (to create the edge at the end of the instruction) for the increment/load.
	* The emulation, apuHandleInstructionSchedule4, needs to switch the increments after the loads...



* Demo 7 transparent back plane colour
	Then introduce raster bars for the background
	Also fade up the various layers independantly



* Added HardwareTest which adds some standard hardware test routines
	HardwareTest_VideoPattern0 will display a known simple pattern for the chars screen



* main6.a updated to handle slower clocked APU, using JP11 rather than JP10
	Multiplexing tree sprites now use EADDR2 to set kBus24Bit_SpritesControlLo, which saved a lot of cycles



* MegaWang 2000 Turbo Edition: https://twitter.com/too_late_nate/status/1446606425925554181
	Logos:
		https://github.com/ianhan/BitmapFonts/blob/main/bb_font.png
		https://github.com/ianhan/BitmapFonts/blob/main/font-pack/Charset-DNS_Kefrens%20The%20Wall%20Font.png
		Wang https://github.com/ianhan/BitmapFonts/blob/main/font-pack/Charset-DNS_Sentinel.png
		https://github.com/ianhan/BitmapFonts/blob/main/font-pack/jet.png
		https://github.com/ianhan/BitmapFonts/blob/main/mvision2.png
		Mega https://github.com/ianhan/BitmapFonts/blob/main/silver_f.png
		2000 https://github.com/ianhan/BitmapFonts/blob/main/tristarf.png
		Turbo edition https://github.com/ianhan/BitmapFonts/blob/main/32X32-F6.png
		https://github.com/ianhan/BitmapFonts/blob/main/32X32-F7.png
		https://github.com/ianhan/BitmapFonts/blob/main/Cool-Cat-Font.png
		Character set: https://github.com/ianhan/BitmapFonts/blob/main/FRESH.png
	Mods:
		* https://modarchive.org/index.php?request=view_player&query=83123
		https://modarchive.org/index.php?request=view_player&query=82719
		* https://modarchive.org/index.php?request=view_player&query=80199
		https://modarchive.org/index.php?request=view_player&query=159691
		https://modarchive.org/index.php?request=view_player&query=122630
		https://modarchive.org/index.php?request=view_player&query=104840
		** https://modarchive.org/index.php?request=view_player&query=42987
		https://modarchive.org/index.php?request=view_player&query=122628
		https://modarchive.org/index.php?request=view_player&query=77048
		https://modarchive.org/index.php?request=view_player&query=84825
		https://modarchive.org/index.php?request=view_player&query=157799
	Background:
		https://www.spriters-resource.com/fullview/73184/?source=genre



* main9.a
	Even when the movement for the main logo finishes, the scale effect can still rippple along the logo
	The pulse will need to use slightly less scale, since all of the sprites are on the same line.
		Perhaps have a narrower pulse that sometimes ripples across...
		This would happen as the regular sprites are updated for the "2000" part of the logo



* main9.a
	* Done: Add overscan mode, for Sprites2 compatibility
	* Done: Sprite registers at 9800 not 9820
	* Done: Fix main logo right pixel edge issue by bringing in the border like before
	* Done: Add 0x9e09 and 0x9e0a init in code
	* Add wider background?
	* Done: Update logo scroll positions




* main6*.a
	SotB demos need updating to overscan hardware
	APU needs a carry bit output after the add, to allow the tree calculations in the title screen APUTitle.a
	Or this calculation goes into the CPU and it stored to the APU data area off-screen
	* For kAPUData_Tree1Num with MAPUCopySpriteWithAddX and APUMultiplexStrip
		Will need to add X first, to allow the bit to be added to the sprite colour register
		Or the X pos can remain the same going down the screen...
		* Using overscan extent $30 does hide the sprites on the left/right border edges in asm\ShadowBeast\DisplayScreen.a
			But the screen is quite narrow
			The hardware simulation does correctly render with the captured data compared to the emulation, which is good
	* Looking at !macro EmitSprite asm\ShadowBeast\CommonBlimpsMoon.a
		It might be possible to store a sprite MSBX and non-MSBX byte value
		This could be conditionally used by having an optional kAPU_Incr_ADDRB1 based on selecting the high result from the add and using kAPU_SkipIfEQ
		Or there could be a new 16-bit add added to the APU, which adds to a 16 bit value in a register pair...
	* Done: I think, on balance of the complexity, this data should be calculated by the CPU and the data uploaded to the APU for fast copying
		Use MAPU_DataUpdateNumBytes to transfer the calculated data at the right time
		Hardware simulation matches software emulation
	* Done: Tidy "Sprites behind chars" so that it uses MBus24Bit_VideoLayer_EmitPriority_NearToFar_A
	* Done: Game APU code




* Using scaled sprites, some kind of "3D" shooter?
	But the "3D" is just using scaling and some adjusted movement using a perspective table
	No rotation, but can have some translation
	Non-scaled sprites in the background providing background effects?
	The perspective table (like the BDD Sprites2 road demo swing table) can use an appropriate zoom level with some accuracy for fractions of a 32x32 pixel sprite without zoom.
	This means it would be quite easy to transform objects in 3D X&Y screen coordinates
	Added GameSpriteWorldInit, the 3D maths is incomplete
		; Setup X pos
		There needs to be an additional of a perspective correct view X/Y translation as well
		Plus edge of screen checks
		* X coordinates done, need Y
		* Done Y coordinates: https://twitter.com/MartinPiper/status/1526553547315089411
	* Tidy code, use macros
	* Add sprites from suitable game, possibles are:
		https://www.spriters-resource.com/fullview/1443/
		https://www.spriters-resource.com/fullview/35153/
		https://www.spriters-resource.com/genesis_32x_scd/superthunderblade/sheet/167431/
	** Needs to use compressed graphics
		e.g. 
			+MRLEScreenDataToDefaultCharScreen .Chars_map , .Chars_map2
			+MRLEPlanesDataToDefaultCharScreen .Chars_plane0 , .Chars_plane1 , .Chars_plane2 , .Chars_plane3




* Demo9: Could use the use txtVars.a output to produce a table of entities to spawn...
	The player sprites already use "kVarsEmitSpriteFrame_scaled_32_**_0_tileIndex" etc
	Done: Why is kVarsEmitSpriteFrame_scaled_0_64_0_tileIndex undefined?!
		indexPick and tileHasData check is wrong as it's not supporting 32x32 sprites
	Added better sprites for the game section




* Demo9: Add extra chars: kVarsEmitSpriteFrame_scaled_32_128_0_tileIndex=23
	kVarsEmitSpriteFrame_scaled_32_128_0_colour=7
	* Bounce sine scale scroll with names of followers.
		See: "; Letters!"
	Also new background: https://opengameart.org/content/seamless-space-backgrounds





* Hook into kernal screen draw and copy over the screen?
	* Copy kernal into RAM
	* Stop $01 access from disabling the ROM in RAM?
		file:///C:/work/C64Docs/unusedino.de/ec64/technical/aay/c64/zp01.htm
		$FDD7
		Probably no need as it's not used after main power on reset
	* Hook screen updates
		file:///C:/work/C64Docs/unusedino.de/ec64/technical/misc/c64/romlisting.htm
		EA1C
		E9FF
		E9C8
	* Then A000   .WD $E394   ; RESET
		jmp ($a000)
	* Switch out kernal to show RAM
	** Easier alternative, code at $c000, point $0314 IRQ vector to code, jmp ($a000)
		The IRQ is still preserved after the "reset"
		Will need something to preserve the IRQ after runstop-restore
	* Can use the original kernal data, compressed, or add a new charset in the remaining space...
	** @Demo11



* Update music conversion code to automatically output non-looping instruments with correct values for the "stop loop" information and update the music player
	* Updated non-looped samples to always use the first exported sample 0x80 byte
	.sampleLoopLengthsFlag removed




* main7.a - Demo7
	While writing to StackedSpriteData with MEmitSpriteFrameOffsetXY
	Calculate the difference to the previous sprite
	** Working backwards from the end to pick the furthest down value?
	If it is > 16 and if the X store index < 24*4 then store that as the last best possible point for a simple multiplex point
		Then possile to pick the next restart point after another 24 sprites
	The index sort from the C64 multiplexor can be used on the Y positions of the animation entries
	Then try waiting for that position using MBus24Bit_WaitUntilRasterY
	Then output the next part of the sprites
	>> EnableMultiplexing
	* Hmm, the sort and data shuffling actually takes quite a lot of frame time...
		Although .bestMultiplexPos it might not be feasible...
		Maybe the APU can calculate as it runs through the sprites instead?
	** Or better sort the single animated source position with the maximum Y size extents factored in, not all the sprites
		Then use some gap analysis on that instead
	* Perhaps there is a better algorithm?
		Split the screen into a table of 8/16 vertical lines, clear the line table
		Loop through all sprites filling in the table by incrementing the entry for the y position
		Find a suitable split point where there is no used space
			Marching middle found point?
			Or start from the bottom totalling up all the table numbers until a threshold?
			Scan from start totalling all the entries until a threshold?
		Then create two (or more?) chunks of sprite data to upload based on that point
		* Scan from top down, summing the slots, to the first gap (after data)
			Scan from the bottom, summing the slots, until the first gap where the sum is >= the top sum
			Keep on going until there are no more gaps, choose that
			>> GameSpriteSplitPosRaster mostly correct, but the rare frame it is far too near the top of the screen to be sensible, why?
				0C 0C 06 02 04 02 02 04   02 02 04 02 00 00 04 04
				Looking at this it is legitimate, there is only one gap near the top!
				And EmitSpriteFrame_count = $88 !!! Which is still 34 sprites!!! WTF. Oh the boss is huge.
			>> No sort APU seems to be working
			>> Optimised by updating data to the APU directly
			* Done: Add sprite layer disable/enable
				Probably use the ADDR+Value macros (MAPU_ProcessRasterByte)
			; MPi: TODO: Add double buffered sprite data
				Like: apuFrameReady0 and MAPU_TestAndJump
				Added: +MAPUTopAndBottomSplitsData ~StackedSpriteDataGEReal2 , ~StackedSpriteDataLTReal2 , ~StackedSpriteDataLTYPos2
					StackedSpriteDataGEReal etc will need to be renamed to StackedSpriteDataGEReal1 etc
				Added: apuOtherFrameData to point to the relevant ADDRB1
				>> Done: MultiplexSwapBanks etc




* Once cart emulation is added to BDD6502, for demo6 create a combined title screen and game demo using a large cartridge for the graphics
	bank 0 : Code at $8007 with $8000 CBM80 startup
		$8010	Send title screen data then load code
		$8013	Send game data then load code
	All entry points first copy the code into $c000 then do the necessary copies
	C:\Work\C64\VideoHardware\tmp>dir shadow*.bin
		Should easily fit without compression: 29 File(s)        135,648 bytes
	C:\Work\C64\VideoHardware\tmp\target>dir sotb*samples.bin
		2 File(s)        106,952 bytes
		In reality 2x8 banks max
	@Demo6C can use the random init syntax to ensure data is loaded
		And the debug init test pattern



* Demo6c : Transition to use APU colour bars...
	Done: Also turn off the layers and the audio leaving just the background colour layer
	Tiles layer could have a "loading..." screen in it... As the tiles do not currently change between the title and game...
		; TODO: Display loading...




* C64 needs CRT code ability to copy or decompress large chunks of 8K data to hardware memory locations via userport24
	A good demo would be to send all Demo6 or Demo9 data and then start the main code.
		Created @Demo6C




* @Demo6*
	Alter the configured layers to be the same as @Demo9 and alter the APU code to update the required palette entries
	Then scaled sprites can be used for extra effects!
		Currently:
			GetBackground
			Tiles
			Chars
			Sprites
		Needs to be:
			Chars
			Tiles
			Sprites2
			Sprites
	Added some scaled sprites



* For APU validation when running @Demo6:
	Enable lines:
		And enable video display bus debug output
		And enable user port bus debug output
	Run: "C:\work\BombJack\output\_tidy old and new.bat"
	Then run @Demo6
		In file: ..\C64\VideoHardware\target\debugData.txt
		Find and replace: d$9e0a010d -> ;d$9e0a010d
			>> Due to recent addition of:
			main6.a: UpdateScaledSprites lda #kBus24Bit_VideoLayer_LayersEnable_134
				Disable the below sta. This stops the char layer from being disabled by the sprites2 disable due to the slightly different layer order
			Look for: d$a2020160 and change to: d$a2020120 to force the vectors off for the second merge layer
	>> In Proteus open the main BombJack project
		Disable VSMDD2 (the default one)
		Root sheet 12 (Sprites2 scans) DSW7 switch EBS3 instead of EBS2
			Choose the faster clock with DSW10 (1 off / 2 on)
				Expect warnings about sub-minimum write pulses being ignored from the scan RAMs
		VSMDD1 append "old" to the output image filename
		Enable VSMDD9 can use: ..\C64\VideoHardware\target\debugData.txt
		Validate generated frames


	>> In Proteus open the APU project
	Then in APU data VSMDD2 use: ..\C64\VideoHardware\target\debugDataJustUserPort.txt
		This file just has data sent from the C64 via the user port, not any graphics/sound data from the feature file during hardware setup
		Execute for several simulated seconds, watch for RV not updating which would indicate the recorded HV data file doesn't have enough data
	This generates the file, open it: BombJack\output\DebugAPUOutput.txt
		Search for: d$9e000130
		Delete all lines above that
	Open file: c64\VideoHardware\target\debugData.txt
		Search for: d$9e000130
		Copy all lines above that, paste to top of DebugAPUOutput.txt
	Find and replace: d$9e0a010d -> ;d$9e0a010d
	Automatic data reconcile process: python C:\Work\BombJack\ReconcileData\ReconcileData.py C:\work\C64\VideoHardware\target\debugData.txt C:\work\BombJack\output\DebugAPUOutput.txt
		Should not have any differences

	In Proteus open the main BombJack project
		VSMDD1 output name minus "old"
	>> Enable VSMDD9 which uses output\DebugAPUOutput.txt
		Validate generated frames
			cd /d C:\work\BombJack\output
			compareimages.bat 180





* Demo9 some purple pixels background
	Might be the option to convert the chars without a transparent colour and then not have a background colour?
	>> Added Video_PalettesColour0ClearTo
	>> Added: "; Clear the last transparent background colour to black"




* Demo9: Use the extra chars layer to display an extra layer of metal/grid work over the background. From the demo7 assets, but very sparse.
	Current EBBS memory map:
		01	Video
		02	APU
		04	Audio
		08	Sprites2
		10	Sprites
		20	Chars planes
		40	Tiles planes
		80	Chars screens
		80	Tiles screen
	* This will need more precise memory decoding for the hardware and emulation
	>> "C:\Downloads\tiled-windows-64bit-snapshot\tiled.exe"




* Double check that the last layer, without background transparency enabled, can display the full 16 colours from all 16 palettes.
	Create a palette and create the blocks?
	Or convert a suitable image? Colour wheel?
		>> "C:\Users\marti\Pictures\ColourWheel1.png"
	Passed. convert13.bar @Demo13




* Demo11
	Syntax to enable reading the keyboard from the C64 window context and insert the keys into the C64 standard keyboard buffer, or fake them into the CIA like the joystick code does.
		@TC-12 has an example of text entry via syntax...
			Then I write memory at $c6 with 1
			Then I write memory at $277 with $52
		Given add C64 display window to C64 keyboard buffer hook
		Given add C64 regular IRQ trigger of "100000" cycles




* There may be a bug when including the ShadowBeast/beast_attract_playfield_1_1024.png
	The palettes seem to go wrong. May be better to create a separate char palette and include that
	>> ImageToBitplane fixed




* Demo9: Space Harrier music choice: https://twitter.com/MartinPiper/status/1546801837755355141
	https://www.youtube.com/watch?v=Hzgrb-mjLaM
	* This one: https://modarchive.org/index.php?request=view_player&query=57939
	* Done: Scroll background for movement...
	* Score panel etc...
	* Explosions
	* Tile screen animation for the perspective background?
		Without APU
	** Code in Demo9\RenderFloor currently generates a tile/chars screen that uses quite a lot of chars.
		Really this needs the APU to set the horizontal scroll plus palette to animate the floor.
		** The code can generate the palette change animation table though :)
		Code can generate a 256 row image, each row corresponds to that particular distance.
		The screen position of each row is a function of the height.
		It would be possible to generate tables for each Y height (byte) to select screen rows (byte) to draw.
			For around 128 screen lines
			>> Generated assets\Demo9\RenderFloor\out\floor.png and HeightToRowsX
		The APU can then render each Y position
		>> First test mostly works, once the rows table included the position minus the expected screen draw vertical offset
			Note the word values in APULineScrolls all seem to have > = $300 so optimise this to a byte
			* Done: The far rows need to select a suitable transparent line instead of repeating the same value...
			* Done: The Z rows table could use double the resolution to remove some of the jagged lines?
				>> The jagged lines near the front are due to the several pixel steps from from row 10 to row 11.
					This is due to the image output being non-linear.
					It would be better to have more lines options near the player and fewer further away
					>> Also a problem is that the current tiles conversion of Demo9Tiles.png uses 251 tiles. Which is right on the limit.
					>> The "for (double z = nearPoint; z < farPoint; z += farPoint / kZEntries) {" could use a non-linear addition
						e.g. "for (double z = nearPoint; z < farPoint; z += (z / kMultiplier / 5)) {" ** better distribution **
							Which results in something like ~214 tiles and potentially better distribution of lines
						However the zTab ("int nextZ = (int)z;") lacks the close to camera accuracy to use these new lines...
						So the conversion from z double to z int would need some multiplies, and where zTab is accessed in the y height lookup
							Note the last few entries of HeightToRows127, they should be accessing pixel rows that have smaller horizontal gap... Their index value changes should be smoother, not accessing the pixel rows in chunks of several pixels
							>> e.g. the last few values of HeightToRows127: ... 40 , 40 , 40 , 40 , 38 , 38 , 38 , 38 , 38 , 36 , 36 , 36 , 36 , 36 , 33 , 33 , 33 , 33 , 33 , 33 , 33 , 33 , 33 , 33 , 33
								Note the change from 33 to 36 to 38 to 40 going through 34 35 37 39
							> Add zTabIndexScale
								> Although this didn't help... Keep it in, for tweaks later
								>> What really helped was using the "(z / kMultiplier / 5))" better distribution for both loops
								> Also adjusted yAdjust so the floor isn't so close with HeightToRows0
			* Done: The current screen pixel row also needs to know its accurate Z position, to allow for the X swing lookup to be applied and also a horizontal pattern to be applied, probably via the combination board EOR or a  palette update
				>> Added ZedToRowsRebased for the Z swing table lookup
				>> Added SendAPUAPULineScrolls which does swing the display almost properly. But could do with more closer to the camera rows and therefore better Z resolution
					> Also it is quite slow so had to adjust: Given video display processes 8 pixels per instruction
						See: # Different because SendAPUAPULineScrolls takes a lot of time
				>> See second merge dither control kBus24Bit_MergeLayer_Register_XORMask1: ; Toggling between 0/1 this will swap the floor colours...
				** Need to reduce APU code size: !for .i , kAPUNumFloorRows {
					With extra two instructions in "!for .i , kAPUNumFloorRows {" the APU code size limit is hit...
					Done: Need to optimise APU code for size
						> Loop instead of unroll?
							>> Added APUFloorLoop
						> Reduce the wait value to just the Y position?
			* Since the APU knows what line it just waited for, can it subtract the line from the table value itself? This would potentially reduce the data needed for the X scroll lookup table entry.
				Although if the table is expanded, then this wouldn't be possible with only an 8 bit subtract without any carry as the current design has limited ALU capability
				>> The last HeightToRowsInv127 is used in the Demo9 code as a placeholder, which includes this 8 bit subtract
			* Reduce chars usage further:
				No safeDistance = 214 tiles
				iSafeDistance = 188 tiles
				safeDistance = 196 tiles
				iSafeDistance best
				Far horizon has 27 (for half width) tiles. Adjust threshold...
				Adjust mid-point for perspective, the center line should be at x=182 (based on borders)
					>> safeDistance = 0.75f *
					>> iSafeDistance = 201 tiles
					>> Game screen coordinates adjusted
			* Need to move all HeightToRowsInv and ZedToRowsRebased to cartridge data and bank them in as needed
				Code and some data needs to avoid this area while doing the update...
				* RenderFloor to output raw binary data with correct swizzle to a directory
					One chunk per height
						Linearly arranged
						Use adds into the block to get the right pointer, to save on cartridge data offset lookups
				* Create cartridge using data, doesn't have to boot yet.
				* Use cartridge output mapping file
				* Ensure code and Sprite2Tab_PerspectiveTabLo , Sprite2Tab_PerspectiveTabHi , Sprite2Tab_Perspective is not in cartridge space
				* Self modify addresses in SendAPUAPULineScrolls as needed
				** Mostly works, but Sprite2Tab_PerspectiveTabStart and Sprite2Tab_PerspectiveTabEnd need to be out of the cart/ROM area
					Done: Can MusicDataStart be moved after this table?
				** Done: Cache the result of the SendAPUAPULineScrolls calculation, don't update if it's not needed



* Demo6c adds the C64 display, which shows the C64 side boot message.




* Demo1 adding Mode7 data init, in preparation for testing real mode7 hardware.



* Demo7 computed palette fade needs to be converted to fade RGB565 colours
	It was using a fast byte aligned lookup since the old RGB444 format was aligned to a byte.
	> It would be possible to use pre-computed palette banks instead, which will result in a faster update during the render!




* Demo9 palettes
	Perhaps convert the chars with RGB565 and palette quantize to 5 without any transparency as a separate pass
		Remember, if there is no transparency then there must not be any forcergb in the graphics conversion.
	Convert the rest of the graphics with RGB565 as another palette chunk and palette quantize to 11 palettes
		Then merge the palettes
		This is complicated by the fact that the forceRGB is different...



* Demo12 fixed VectorHardwareInitPalette



* Demo13: Need code to run the APU setup, could copy from main12.a
	Configure the layers to be the same as Demo6
	Also upload compressed data
	> +MAPUEmitChangePaletteBank




* Demo6: Used the 16MHz sprite timing in the feature file.
	    Given add a Sprites V9.5 layer with registers at '0x9800' and addressEx '0x10' and running at 16MHz




* Demo6: SotB better sky gradient colours
	Look for MAPUEmitChangePaletteIndex
	Use the source debugger to locate the correct APU code point. The data is relatively easy since it has the wait Y positions...
	Added Y positions: Note: "; New sky 1234..." comments
		51 105 127 140 155 161 173 179 189
	>> Note the "; Should be " comments, perhaps the tree sprite updates could be moved around a bit to give these a better colour change placement?
	>> Also note the "; Did not add extra sky here, too tight", perhaps there could be some space opened up in the tree sprite updates?
		* Try moving the sprite splits down to make room
			> Check before and after the changes:
				Debug output frame 17, when the scaled sprites first appear, with the tree on the right of the screen
				and frame 194 with the tree on the left of the screen
			> Sprite_TreeY = 91
				APUData_Tree3dData is the problem. Don't forget that EmitSpriteWithAdd inverts the sprite Y coordinate
					Sprite_TreeY + 64
				>> With APUData_Tree3dData moved down two lines, the sprites display but with one blank line, indicating...
					Hmm, the first "; Next tree segment" are all just-in-time, i.e. they update the sprites just before they're needed...
					Undoing the change and moving Sprite_TreeY up two "Sprite_TreeY = 89" also shows this...
				>> Moving the first "; Next tree segment" up one line, allows enough time for the "; New sky 4" to be at 139 -1
				> Second "; Next tree segment" , sky split should be at 147 -1
					APUData_Tree4aData uses Sprite_TreeY + 80 = 171
					Moving APUData_Tree4aData APUData_Tree4bData APUData_Tree4cData up two lines opens enough space just before kAPUData_Tree4dNum? For "; New sky 4b"
				> APUData_Tree5aData is at 165 and uses Sprite_TreeY + 96 = 187




* In theory, it would be possible to save notes/volumes/samples from MAME audio hardware in the same format expected by the video hardware tools, compress them, and then play back the music.
	Or save them as MOD files...
		Tracing through the code in segam1audio_device
			Got to: src\devices\sound\multipcm.cpp
				multipcm_device::init_sample
			or maybe: multipcm_device::write_slot
			Note 28 voices indicated: gew_pcm_device(mconfig, MULTIPCM, tag, owner, clock, 28, 224),
	>> This point seem better: multipcm_device::write_slot
		Can read details after init_sample is used
		> Note how slot.m_sample could be used to identify each sample, it is probably better to use sample.m_start, sample.m_loop, sample.m_end to identify max ranges of used sample bytes and save the minimal ranges for detected notes
		>> Ranges in sample data could overlap (partially) inside notes, then used notes can be merged together etc.
	* There are two audio devices, identical sample data? or not?
		mpr-16491.32 and mpr-16492.33
		mpr-16493.4 and mpr-16494.5
		>> Sample data is very different
	>> https://en.wikipedia.org/wiki/Yamaha_YM2612
	> To play:
		"C:\Users\Marti\Downloads\ffmpeg-20200422-2e38c63-win64-static\ffmpeg-20200422-2e38c63-win64-static\bin\ffplay.exe" -f s8 -ar 48000 "C:\Downloads\MAME\roms\daytona\mpr-16491.32"
		"C:\Users\Marti\Downloads\ffmpeg-20200422-2e38c63-win64-static\ffmpeg-20200422-2e38c63-win64-static\bin\ffplay.exe" -f s8 -ar 48000 "C:\Downloads\MAME\roms\daytona\mpr-16492.33"
		"C:\Users\Marti\Downloads\ffmpeg-20200422-2e38c63-win64-static\ffmpeg-20200422-2e38c63-win64-static\bin\ffplay.exe" -f s8 -ar 16000 "C:\Downloads\MAME\roms\daytona\mpr-16493.4"
		"C:\Users\Marti\Downloads\ffmpeg-20200422-2e38c63-win64-static\ffmpeg-20200422-2e38c63-win64-static\bin\ffplay.exe" -f s8 -ar 16000 "C:\Downloads\MAME\roms\daytona\mpr-16494.5"
		"C:\Users\Marti\Downloads\ffmpeg-20200422-2e38c63-win64-static\ffmpeg-20200422-2e38c63-win64-static\bin\ffplay.exe" -f s8 -ar 16000 c:\temp\SamplesUsed.bin
	>> The constructor multipcm_device::multipcm_device seems to be called a lot even before the target machine is started?
		This is a problem because we need to find a good spot to initialise all the potentially used samples across all instances actually used in a game.
	>> multipcm_device is used for Daytona and other model2 games, it isn't used for After Burner and other X-board games
		After burner does use: m_soundcpu m_soundcpu2
			With device_sound_interface, but it is via >	mytestd.exe!ymfm_device_base<ymfm::ym2151>::device_start() Line 196	C++
				>> ym2151_device and segapcm_device
				segaxbd_state::xboard_base_mconfig
				Look for: ROM_START( aburner2 )
							GAME( 1987, aburner2
							segaxbd_new_state::init_aburner2
								ROM_REGION( 0x80000, "mainpcb:pcm", ROMREGION_ERASEFF ) // Sega PCM sound data
			>> device_sound_interface::stream_alloc is used
			>> Is used: segapcm_device::write
				segapcm_device::sound_stream_update and ym2151::generate
			>> Hmm commenting out ym2151::generate stops samples from being heard?
				Using that function but commenting out "m_fm.output" results in some music samples being heard, but missing some voices.
				Using only output->roundtrip_fp() seems to cause samples to be heard?!
			>> Commenting out the outputs[..] lines in segapcm_device::sound_stream_update results in muting the samples and just hearing the ym2151 output
			* In conclusion, it shows that the music in after burner uses both the ym2151_device and segapcm_device which would make a purely mod/xm based output a bit harder :)
				So for now, concentrate on multipcm_device output
	* Daytona audio plan in more detail:
		>> Hook into multipcm_device::write_slot to get specific events
		Looking for "ROM_START( daytona )" and looking for "ROM_LOAD("mpr-16491.32""
			The line above specifies: ROM_REGION( 0x400000, M1AUDIO_MPCM1_REGION, 0 ) // Samples
				M1AUDIO_MPCM1_REGION = "m1audio:pcm1"
				M1AUDIO_TAG = "m1audio"
				m_m1audio(*this, M1AUDIO_TAG),
				optional_device<segam1audio_device> m_m1audio
			segam1audio_device::segam1audio_device
				Hmm:::
				required_device<multipcm_device> m_multipcm_1;
				required_device<multipcm_device> m_multipcm_2;
				Hmm:::>>>>> required_device<ym3438_device> m_ym;
					Commenting out ym3438::generate stops all samples and all music
						m_fm.output seems important for sample output
						Setting all samples to 0 in gew_pcm_device::sound_stream_update results in no sound, indicating there are no FM sounds generated
			> ROMs?
					m_mpcmbank1(*this, "m1pcm1_bank"),
					m_mpcmbank2(*this, "m1pcm2_bank"),
			> multipcm_device uses gew_pcm_device::sound_stream_update
				Which accesses its device_rom_interface<22, 0, 0, ENDIANNESS_BIG>
					This does a read_byte to get sample ROM contents
						Note: -		device_rom_interface<22,0,0,1>	{m_rom_region={...} m_rom_space={m_spacenum=0xffffffff m_data_width=0x00 '\0' } m_rom_config={m_name=...} ...}	device_rom_interface<22,0,0,1>
								+		m_tag	":m1audio:pcm1:bank"	std::string
		>> This can be used to get the ROM info: const address_space_config *memConfig = memory_space_config().front().second;
			read_byte() can also be used
		> Consider, gew_pcm_device could be expanded to return a signed16 sample for an address, which can then be converted appropriately...
			>> There can be a method to one time init appropriate sample data taking into account the instance and ROM size...
		>> Sample rate m_stream: 		m_sample_rate	44642	unsigned int
		>> Can be used to get the curent time, going to be useful for event timing insertion into the output song pattern data:
			m_stream->sample_time().as_double();
	>> XM format: https://github.com/milkytracker/MilkyTracker/blob/master/resources/reference/xm-form.txt
		https://www.celersms.com/doc/XM_file_format.pdf
			C:\Backups\OldMachines\OldMachineBackup\D\Downloads\aceman_-_mortal_combat.xm
				$ba4a7 seems to be the start of a sample header $28 in size...
			"C:\Users\marti\Downloads\milkytracker-1.04.00-win64\milkytracker-1.04.00-win64\MilkyTracker.exe"
			"C:\Users\marti\Downloads\milkytracker-1.04.00-win64\milkytracker-1.04.00-win64\MilkyTracker.exe" "C:\Backups\OldMachines\OldMachineBackup\D\Downloads\aceman_-_mortal_combat.xm"
			"C:\Users\marti\Downloads\milkytracker-1.04.00-win64\milkytracker-1.04.00-win64\MilkyTracker.exe" c:\temp\t.xm
	Note:
		// Model 2 (TGPs, Model 1 sound board)
			GAME( 1994, daytona
		// Model 2A-CRX (TGPs, SCSP sound board)
			GAME( 1994, vf2
	>> Interesting to note that when in test mode playing music only up to 32 channels are used (sAnyNotesinChannel) but in the game nearly all 64 channels are used.

	>> note values... https://newt.phys.unsw.edu.au/jw/notes.html

			slot.m_pitchForStep	1002.7203979492188	double
		slot.m_pitchForStep	2790.1784667968750	double

		m_start	0x001e1894	unsigned int
		m_loop	0x00008e92	unsigned int
		m_end	0x00008e93	unsigned int
		read_byte(0x001e1894+...)
			fd000504f8fd


+		this	0x00000154adda4d20 {m_cur_slot=0x00000000 m_address=0x00000000 mInstanceInit=false ...}	gew_pcm_device * {multipcm_device}

* MAME diffs: https://github.com/mamedev/mame/compare/master...martinpiper:mame:savesprites




* MAME sprite debugger
	https://docs.mamedev.org/usingmame/defaultkeys.html
	F4 Shows the game palette, decoded graphics tiles/characters and any tilemaps.
		Note the keys for palettes, tiles, etc
	"C:\Downloads\MAME\roms\thndrbld.zip"
	C:\Downloads\MAME\mame.exe -debug -console
	Sprite list processing: https://github.com/mamedev/mame/blob/5f54fda4daab98fd0e3ba8958b3e582e5ab67dd1/src/mame/sega/sega16sp.cpp#L1059
	Memory: Sega X-Board Sprites/:mainpcb:sprites/0/m_buffer
	Memory mapping: https://github.com/mamedev/mame/blob/5f54fda4daab98fd0e3ba8958b3e582e5ab67dd1/src/mame/sega/segaxbd.cpp#L925
	memdump
		110000 - 11ffff: sega_xboard_sprite_device::draw_write
	Doesn't work?: dump sprites.txt,0:mainpcb:sprites,32
		Specifying devices and address spaces: https://docs.mamedev.org/debugger/index.html#debugger-devicespec
	Not working: dump sprites.txt,0:mainpcb:sprites/0/m_buffer,32
	saver sprites.bin,0,1000,:mainpcb:sprites
		But doesn't seem to save the data visible in the memory debug view

	for k,v in pairs(manager.machine.memory.shares) do; print(k,v); end
	for k,v in pairs(manager.machine.memory.regions) do; print(k,v); end
	for k,v in pairs(getmetatable(manager.machine.memory.shares)) do; print(k,v); end
	for k,v in pairs(getmetatable(manager.machine.memory.shares[":mainpcb:sprites"])) do ;print(k,v); end

	manager.machine.memory.shares[":mainpcb:sprites"].read_i8(0)

	-----------------------------------------------------
	Exception at EIP=00007ff766c4b3f3 (sol::stack::unqualified_getter<sol::detail::as_value_tag<memory_share>, void>::get_no_lua_nil(lua_State*, int, sol::stack::record&)+0x0033): ACCESS VIOLATION
	While attempting to read memory at 0000000000000000

	Devices route: https://docs.mamedev.org/luascript/ref-devices.html
	for k,v in pairs(manager.machine.devices) do ;print(k,v); end
	for k,v in pairs(getmetatable(manager.machine.devices[":mainpcb:sprites"])) do ;print(k,v); end
	print(manager.machine.devices[":mainpcb:sprites"])	
	This saves a dump of the sprites mirror memory: dump sprites.txt,100000,fff
		https://github.com/mamedev/mame/blob/master/src/mame/sega/segaxbd.cpp#L924C8-L924C14
	$0b0 seems to be the helicopter body sprite
		At the VBlank break (F8), alter memory 0bc (second to last word)  for the palette, then press F10 to step one cycle, and it should render with a different palette
		0B0   0186  39E8  0952  3200  E200  005E  0000  3B4E   ..9 R2...^..;N
	Perhaps this has been done already?
		https://reassembler.blogspot.com/2021/04/ripping-sega-system-16-sprites-palettes.html
		https://github.com/djyt/system16_sprite_viewer/tree/main
		https://github.com/djyt/system16_sprite_viewer/releases
		cd /d C:\Users\marti\Downloads\s16_viewer_win64_v031
		s16_viewer.exe config\outrun.xml
			Palettes in the config directory to be copied to the relevant roms\directory.
	cd /d C:\Work\mame
	C:\Users\marti\Downloads\msys64-2022-01-12-mame\msys64\autorebase.bat
	https://docs.mamedev.org/initialsetup/compilingmame.html#building-with-microsoft-visual-studio
	make vs2019
		^^ Problems...
	Use WSL: https://docs.mamedev.org/initialsetup/compilingmame.html#overall-build-options
		sudo apt update
		sudo apt install gcc
		sudo apt install build-essential
		sudo apt install python3
		sudo apt-get install git build-essential python3 libsdl2-dev libsdl2-ttf-dev libfontconfig-dev libpulse-dev qtbase5-dev qtbase5-dev-tools qtchooser qt5-qmake
		cd /mnt/c/Work/mame
		make IGNORE_GIT=1 vs2019
			Lots of debug: make -d IGNORE_GIT=1 vs2019
	Project warnings as errors->No
	Add compiler options: /utf-8
	>> "C:\Users\marti\Downloads\msys64-2022-01-12-mame\msys64\msys2_shell.cmd"
	cd /c/Work/mame/
	>> https://docs.mamedev.org/initialsetup/compilingmame.html#id3
	>> Then: "C:\Users\marti\Downloads\msys64-2022-01-12-mame\msys64\win32env.bat"
	cd c:\work\mame
	make vs2019
		Still compile probolems...
	make SUBTARGET=mytest SOURCES=src/mame/sega/segaxbd.cpp
	Parallel build: make -j 16 SUBTARGET=mytest SOURCES=src/mame/sega/segaxbd.cpp
	mytest.exe -debug thndrbld
	mytest.exe -window thndrbld
	make -j 16 SUBTARGET=mytest SOURCES=src/mame/sega/segaxbd.cpp SYMBOLS=0 ARCHOPTS=/utf-8 MODERN_WIN_API=1 NOWERROR=1 vs2019
	make -j 16 SUBTARGET=mytest SOURCES=src/mame/sega/segaxbd.cpp,src/mame/sega/segaorun.cpp,src/mame/sega/model2.cpp SYMBOLS=0 ARCHOPTS=/utf-8 MODERN_WIN_API=1 NOWERROR=1 vs2019
	Then open: "C:\work\mame\build\projects\windows\mamemytest\vs2019\mamemytest.sln"
	>> https://github.com/martinpiper/mame/tree/savesprites
	Debugging:
		C:\Work\mame\src\mame\sega\sega16sp.cpp
			sega_outrun_sprite_device::draw
			>> Need the palette
			Stepping out of this a couple of levels gets to: C:\Work\mame\src\mame\sega\segaxbd_v.cpp
				segaxbd_state::screen_update
				+		m_paletteram	{m_bytes=0x0000000000004000 }	shared_ptr_finder<unsigned short,1>
				-		m_palette	{...}	device_finder<palette_device,1>
		From context: sega_outrun_sprite_device::draw
			Locals label search: m_paletteram and m_paletteram
-		(*((segaxbd_state*)&(*((segaxbd_fd1094_state*)(*((device_t*)&(*((sprite_device<unsigned short,bitmap_ind16>*)&(*((sega_16bit_sprite_device*)this)))))).m_owner)))).m_paletteram	{m_bytes=0x0000000000004000 }	shared_ptr_finder<unsigned short,1>
-		(*((segaxbd_state*)&(*((segaxbd_fd1094_state*)(*((device_t*)&(*((sprite_device<unsigned short,bitmap_ind16>*)&(*((sega_16bit_sprite_device*)this)))))).m_owner)))).m_palette	{...}	device_finder<palette_device,1>	
		C:\Work\mame\src\mame\sega\segaxbd.cpp
			segaxbd_state::paletteram_w
		C:\Work\mame\src\lib\util\palette.cpp
			palette_t::entry_set_color
				m_entry_color
	"C:\work\mame\mytest.exe" -window aburner2
	Converts raw data:
		del "C:\temp\thunderblade arcade\*.png" &&  C:\Downloads\ImageMagick-7.0.7-4-portable-Q16-x64\convert.exe -verbose -size "512x256" -depth 8 rgb:c:\temp\t.raw "C:\temp\thunderblade arcade\t.png"
		del "C:\temp\afterburnerarcade\*.png" &&  C:\Downloads\ImageMagick-7.0.7-4-portable-Q16-x64\convert.exe -verbose -size "512x256" -depth 8 rgb:c:\temp\t.raw "C:\temp\afterburnerarcade\t.png"
		del "C:\temp\outrun arcade\*.png" &&  C:\Downloads\ImageMagick-7.0.7-4-portable-Q16-x64\convert.exe -verbose -size "512x256" -depth 8 rgb:c:\temp\t.raw "C:\temp\outrun arcade\t.png"
	Works really well!
	* To help extraction, make the palette change code optional. Also have the option of filtering out any flips and only saving unflipped data.

	>> How to spot and remove pulsating or flashing dynamic palette colours, especially those in After Burner
		Use convert.exe (as above) to extract all sprite frames from a playthrough in mame
			"C:\work\mame\mytest.exe"
				DIP Switches -> Easy
				The mame analogue controls X/Y speed can be set to 64 each which will help cause barrel rolls and extract more sprite frames
			Insert coin: 5
			Throttle down: A
			Every second alternate left/right to roll and use as many rotations as possible
			It is safe to use "DIP Switches -> Reset System" to capture several passes through the opening of the game
		
		Examine output sprites, look for sprites with changing engine colours, not the sprite number. For example sprite t-7 or t-10
		In "C:\temp\t.pal" look for :s00000006 or :s00000010 for sprite index 6 or 10 respectively.
		Note their palette number: p00000f20
			Notepad++->Edit->Line operation->sort...
			Look for p00000f20 again
			Note the palette colour index entries that change, in this case they are 1,2,4 (0 based)
		In C:\Work\mame\src\mame\sega\sega16sp.cpp update CheckPaleteAndForceColour() and update with RGB mask colours like 200,0,200, 150,0,150 , 100,0,100 etc

	>> Processing image files:
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --transparentRGB 255 0 255 --shiftTopLeft --minimiseArea --processNow C:\Work\C64\VideoHardware\assets\Demo14\ToUse\*.png
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --removeDuplicates C:\Work\C64\VideoHardware\assets\Demo14\ToUse\*.png
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --transparentRGB 255 0 255 --shiftTopLeft --minimiseArea --processNow C:\temp\afterburnerarcade\*.png
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --removeDuplicates C:\temp\afterburnerarcade\*.png
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --removeDuplicates C:\Work\C64\VideoHardware\assets\Demo14\*.png
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --removeDuplicates C:\work\c64\VideoHardware\assets\Demo14\PlayerAirplane\*.png
		java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --removeDuplicates C:\work\c64\VideoHardware\assets\Demo14\EnemyPlaneGreen\*.png

	>> For the new scaled sprites, since they are variable in size, will need image conversion changes to take entire batches of sprite files and convert them for best fit palettes
		For example this needs batch processing: java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --palettesize 16 --forcergb 255 0 255 --forcergb 200 0 200 --forcergb 150 0 150 --forcergb 100 0 100 --image "C:\Work\C64\VideoHardware\assets\Demo14\t-6.png" --imagequantize 16 --outputpalettes c:\temp\t.pal --convertwritepass
		New batch format for palettes: --rgbshift 5 6 5 --newpalettes --palettesize 16 --forcergb 255 0 255 --forcergb 200 0 200 --forcergb 150 0 150 --forcergb 100 0 100 --batchimagequantize 16 --batchimages "C:\Work\C64\VideoHardware\assets\Demo14\t-6.png" "C:\Work\C64\VideoHardware\assets\Demo14\t-10.png" "C:\Work\C64\VideoHardware\assets\Demo14\t-787.png" --outputpalettes c:\temp\t.pal --writepass
			Note: preserveData = true is implied during --batchimages
		This calculates palettes and writes data: java -jar c:\work\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --palettesize 16 --forcergb 255 0 255 --forcergb 200 0 200 --forcergb 150 0 150 --forcergb 100 0 100 --nostacking --outputscaled4 c:\temp\TScaledSprites4 --outputsprites c:\temp\TScaledSprites4Sheet.txt --outputpalettes c:\temp\t.pal --batchimagequantize 16 --batchimages "C:\Work\C64\VideoHardware\assets\Demo14\t-6.png" "C:\Work\C64\VideoHardware\assets\Demo14\t-10.png" --resetforcergb --forcergb 255 0 255 --batchimages "C:\Work\C64\VideoHardware\assets\Demo14\t-787.png" --writepass

	>> Analysis of "C:\Users\marti\Videos\Captures\After Burner II [aburner2] - MAME 0.270 (LLP64) 2025-01-19 11-08-34.mp4"
		>> "D:\Video files\old\After Burner II [aburner2] - MAME 0.270 (LLP64) 2025-01-19 11-08-34.mp4"
		>> "C:\Users\marti\Videos\Captures\After Burner II [aburner2] - MAME 0.270 (LLP64) 2025-04-11 09-44-55.mp4"
		At 30 fps, and the slowest speed, it takes 5 frames for an object to approximately move "a row" towards the camera.
		At 60 fps that gives approximately 8-10 smooth steps for each row.
		The closest row is 3.5 objects wide (a bush)
		The farthest row is approximately 14 objects wide
		There are approximately 8 rows
		This could be represetned by a 14x8 table of entries: sprite frame index (into a 16x8 grid that contains "scrolled" map data), X and Y screen position (0-255 that can be multiplied by 2 for a full screen), Z scale/position for table lookup for sprite sizes.
		Might also need a delta X/Y per sprite (or Z table based)
	>> Landscape is on average 85 sprites, 4 bytes per sprite, 24 rotation steps, each 8 frames for Z movement
		> For X movement, it does not have to be independant of the Z movement, there could be an optional "X and Y position addition" bytes for each sprite that gets ignroed or or added/subbed depending on if needed
		> Then each 8 steps, like the existing LandscapeMapRowOffset update, it steps +1 or -1
		Done: >> Perhaps only certain rotations have X movement baked into the landscape data? Then a separate landscape rotation table can contain the required add value (15/16/17) for LandscapeMapRowOffset
	>> Done: It should be possible to store these landscape rotation tables into either cartridge banks, or external RAM car data.
		>> External RAM would theoretically allow faster sequential access since it can automatically increment the address pointer without the CPU
		> See C64\VideoHardware\asm\AfterBurner\LargeTables.a
			And the comments at the top of the file for label extraction
		> If the number of rotations is to be increased, there doesnt need to be any padding and instead a table of pointers produced
		> Perhaps landscapeRotations can be in RAM
		> As well as mode7 rotation addresses
			To avoid too much external RAM double lookups
		>> Bus20To32Bit1_Init added
		>> Updated code to read from the external RAM
	>> Done: Horizon (sky/land) that rotates can use the mode7 layer
		> Done: The only issue is that the mode7 rotation is updated on the vsync, and the scales sprites need a full frame to actually show the new position, so the mode7 is one frame ahead of the scaled sprites.
			To fix this, the mode7 update would need to update in the vsync area a frame *after* during the processing of the next frame of scaled sprite data
			This is problematic, since the 24bit address bus would need to handle the restart since there would be two separate sources accessing the 24 bit address bus.
			* The APU could handle this, the simplest solution would be to disable the APU, have a very simple wait for a frame, then write the stored mode7 data, then stop (or loop).
				This is because the APU has its own internal 24 bit address independant of the userport 24 bit address bus.
	>> Done: If I want rotations in more detail than 15 degree steps, or more frames, then using source files and acme will not work since Demo14LargeTables.bin has already reached the 64K limit
		The binary file will need to be output by the python tool directly. Which is doable.
		See: binaryDataFile and dataOffsetsFile
			Worked first time! :)
		> Used 24 bit values in the binary file
		> Added the text at the start, for later data checking: MW2000-AfterBurner
		> ScreenLandscapeNumRollSteps now equals 72
	>> The large intro aircraft carrier can be sprites, as long as the sea sprites behind are not rendered. Special case empty sprite draw will skip the landscape table entry.
	>> Animated intro balls could be pre-sorted sprite animations, stored in RAM/cart bank
	>> For enemy movement, each rotation angle could have a position up and to the left/right at several Z positions. This could be accumulated with other position, as vectors, to provide variation in position.
		>> Done: Works, but the rotation tables need moving to external RAM because the current range limits in C64 RAM (0-15) are too small
			The "+MAddU8ToAddr16 32" can be replaced with a latch add, or perhaps it is more optimal to store the values as pairs and asl landscapeRotationsFrame and handle the hi bit?
		>> ; Quick 3D position rotation test
		> ; Individual tests
		> ; Combined transform
		>> EntityUpdateObjects
		> Done: rotationVectorTableAddrs and rotationVectorTableAddrsNext can be 16 bit because they are always $100 bytes aligned
		> ; TODO: Hack scale, will probably need a Z pos to scale table
			>> realZToHardwareScale
			>> defaultNeutralScaleIs is technically the Z position of the player
			Returned scale of 0 in the width/height ScaleTab means the sprite is too large, so skip it
				>> MGenerateSprite4ScaleTable updated
			> return partial X/Y perspective for the rotation stage, around 0,0 origin still
				> 128 in X or Y means the point clipped outside the visible range, so reject it
				> This could be a large 256 x 256 table in external RAM
	> When selecting player airplaner graphics keep the ones with more engine colours. There appear to be some "dark" versions.
	>> Done: Need to use playerYPositionOffsetForHorizon in the horizon lookup...
		Adjust MMode7RotationOffset
	>> Done: Adjust the sprite4 extents so that the left hand and top part of the screen are on the border edges, this should allow the hardware sprite culling to work better
	>> Done: While there seems to be Demo14\PlayerAirplane\Left3 with one "up" frame missing, there also seem to be all the "up" frames missing from "Left4" starting with t-149.png
		> See missing frame for RenderSpritePlayerRL3YU1 and RenderSpritePlayerRL3YU2
			Found new frame: bt-823.png
	>> Done: Change to introduce a roll check...
	>> Done: Improve bcs .noMSBX2 kBus24Bit_Sprites2_MSBX and kBus24Bit_Sprites2_MSBY checks by incrementing a zeropage location and testing the result without stacking etc
		No need for this. The entire screen is 0-255 X and Y coordinate base, until the final shift left
	>> Done: ; TODO: Bake in this adjustment
	>> Done: With improved Y clipping, playerYPositionOffsetForLandscape could be twice as large now.
	>> Done: Check (and wait for with on screen display) the external RAM for expected binary header: MW2000-AfterBurner
		> ; TODO: Check for RAM contents
			> GameExpectedIdentifier
	>> Done: Write out MSBX for the sprite and include full resolution position, avoid extra shifts.
		> Due to "sbc zeroPage_Temp7" which uses TweakScaleTab and relies on LandscapeMapXTweak, this means it is tricky...
			It might be better instead to store out two X+MSBX for each entry...
		> .someTweakX
	>> Done: Move landscapeRotationHorizonOffsetTab referenced data into external RAM
		> landscapeRotationHorizonOffsetTab swizzled
		Currently: Saving 35244 ($89ac) bytes ($200 - $8bac exclusive).
		Now: Saving 24019 ($5dd3) bytes ($200 - $5fd3 exclusive).
	>> Done: Automate ScaleTab output
		> maxHardwareScaleTabValue and Demo14ScaledSprites4Sheet.txtTables.a
	>> Done: Use macros for latch setting, not jsr
		Improved framerate and code size
	>> Done: Enemy airplane rotation frames, for its own roll and also landscape rotation
		; Done: Plane animation frames are not equally spaced out across the range of angles
			; Expanding this table would allow the angles to be placed closer to their desired angles. Perhaps measure the angle of the wings?
			>> Handling each 90 degrees quadrant seems to be a good option
		> Done: The animation angles for the green plane look a bit wrong, the nose points in the wrong direction probably due to flips, consider the EnemyPlaneHarrier instead
			> Or capture many more frames and extract
	>> EnemyPlaneWhite
		EnemyPlaneGreen_landscapeRotationsFrame_to_animation
		Render_EnemyPlaneGreen_Table
		; Done: No: TODO: Better table layout? Swizzle?
			Done: Combine both of these into one table, less indirection
				> EnemyPlaneGreen_landscapeRotationsFrame_to_animation is not swizzled, one pointer to update for different types, not clc/adc #ScreenLandscapeNumRollSteps/etc
					Removed Render_EnemyPlaneGreen_Table
		> EnemyPlaneWhite_landscapeRotationsFrame_to_animation
		>> Done: Add EnemyTypeLo/Hi that points to EnemyPlaneGreen_landscapeRotationsFrame_to_animation (or similar), 0 can be for the player render
			See: enemyTypeLo/enemyTypeHo and associated code
	>> Done: EnemyPlaneHarrier
	>> Done: Empty entity slot can be EntityZPos=255, which causes a skip. Z = 0 can be useful for rendered enemies behind the player.
		> See: EntityZPos_Inactive
		>> Removed, the hi type is now used
	>> Add more _UsingState macros in enemy draw
	>> Add Entity Z rotation offset that will wrap around and accumulate with the landscape rotation
	>> Done: Animate and draw multiple enemy objects
	>> Done: Make player and enemy objects sort with Z value
		> EntityZPos
	>> Done: Smoke trails from missiles in title screen
		>> Hit the title animation grid, explode...
		>> Tricky... Cannot alter the animation read position...
			> Added next frame address, instead of just streaming data from the external RAM
	>> Animation editor
		Display sprite frames and test sync with rotation table order. Hand editing the tables is prone to erros and time consuming.
			> Test with EnemyPlaneGreen graphics as this is the most troublesome so far
		Display the horizon rotation
		Support flips for each sprite
		Also test global flips for the whole animation, to see if the animation can be used for up/down/left/right parts of the screen area
		Export code that can be !source included
			See how EnemyPlaneWhite_landscapeRotationsFrame_to_animation references Render_EnemyPlaneWhiteXXX labels
		>> Tkinter https://coderslegacy.com/python/python-gui/
	>> Animated takeoff and landing sequence can be added as extra landscape frames, while horizontal (like the arcade)
	>> The lower down canyon left/right movement can also be added as extra horizontal frames
	>> Rotated landscape frames
	>> Update landscape map data when "scrolled". The game access a specific grid inside the map while "scroling", the map is not itself scrolled, the map grid wraps around. The "horizontal or vertical" edges not being rendered can be updated.
	>> Landscape render skips empty landscape slot
	>> Aircraft carrier, renders with bandwidth saved from empty slots
		> RenderSpritesCarrier
			MObjectDrawWithScaleSizeCheck with suffix Accurate could use 16 bit X/Y coords and include the relevant MSB calculations
		> LandscapeMap needs empty objects
		Improved algorithmic generation with LandscapeMapRowsData and LandscapeMapRowsDataOffset
	>> Done: Code tidy, move bits to separate files
	>> Enemy rotation animation seems to be a bit jerky as they move towards the camera. Is this due to the scaled sprite rotation point adjustment or due to the perspective calculation?
	>> Done: Algorithmic landscape to include ground RGB changes.
		Done: The horizon and ground palette will need to be fixed in place at the start of the palette.
		Done: The mode7 palette entries do not need a transparent forced rgb 255,0,255 bright purple.
		Done: The ground entries could probably be first in the forced list
		Done: The algorithmic landscape can then include the palette bank to change to, which contains pre-computed colour changes
			> LandscapeMapRowsData expanded 1 byte
	>> Done: Intro smoke from engines
		Note: No entity system active here...
		> Tidy RenderSpritesCarrier, separate player draw and also generify the position MSB check for kVarsEmitSpriteFrame_t_241 for the smoke
	* Done: Intro smoke trails can use the entity system, start with empty entity list
		Allocate entity in empty slot, when it moves behind the camera, remove the entity and push the Z to the back
			>> EntityFindFreeSlot EntityUpdateObjects
		Game will need to allocate new enemies
			>> CheckSpawnEnemy
	* Done: Entity list can have rotation tweak, will need a range clamp of course...
		>> EntityRotationTweak
	* Done: Player takeoff, alter smoke spawn height
	* Done: Entity handler code. Optional. Will allow more complex behaviour.
		>> EntityStateLo/EntityStateHi
	* Done: Ball explosion, should move away from the central point, which means the vectors need to be normalised etc.
	* Done: Player missle
	* Done: Title sequence enemy plane and missle, using the state machine
		> EntityState_EnemyPlaneGreenForward
	* Done: Game audio: "c64\VideoHardware\assets\AfterBurner sound effects.xm"
		>> "C:\work\c64\VideoHardware\assets\AfterBurner sound effects reduced.xm"
		Save notes/start/end/repeat as assembler include during conversion. Using macro.
		>> --exportmod "C:\work\c64\VideoHardware\assets\AfterBurner sound effects reduced.xm" "target/exportedAfterBurnerSoundEffects" 65535 168864
		>> kMusicCommandSetSampleData and kMusicCommandPlayNote and setDebugMusicData
		> ASSEMBLY_DEFINES_TXT, debugAssembly, setDebugAssembly(), writtenSampleFrequencyForAssembly
		> Player_EngineVolumeChange MPlaySample MPlaySampleLoop MSampleSetVolumeFrequency MSampleSetVolume_fromAddr8 MSampleSetFrequency_fromAddr16
	* Done: Enemy spawn alert
	* MPlaySample is quite large, table and subroutine instead?
		; Explosion 1
		+MPlaySample 0 , 255 , kSampleInfo0_start , kSampleInfo0_length , kSampleInfo0_frequency
		; Explosion 2
		+MPlaySample 0 , 255 , kSampleInfo1_start , kSampleInfo1_length , kSampleInfo1_frequency
		; Explosion 3
		+MPlaySample 0 , 255 , kSampleInfo2_start , kSampleInfo2_length , kSampleInfo2_frequency
		; ??
		+MPlaySample 0 , 255 , kSampleInfo3_start , kSampleInfo3_length , kSampleInfo3_frequency
		; Hit
		+MPlaySample 0 , 255 , kSampleInfo4_start , kSampleInfo4_length , kSampleInfo4_frequency
		; Fire
		+MPlaySample 0 , 255 , kSampleInfo5_start , kSampleInfo5_length , kSampleInfo5_frequency
		; Be careful
		+MPlaySample 0 , 255 , kSampleInfo6_start , kSampleInfo6_length , kSampleInfo6_frequency
		; The enemy
		+MPlaySample 0 , 255 , kSampleInfo7_start , kSampleInfo7_length , kSampleInfo7_frequency
		; Get ready
		+MPlaySample 0 , 255 , kSampleInfo8_start , kSampleInfo8_length , kSampleInfo8_frequency
		; Break right
		+MPlaySample 0 , 255 , kSampleInfo9_start , kSampleInfo9_length , kSampleInfo9_frequency
		; Wow
		+MPlaySample 0 , 255 , kSampleInfo10_start , kSampleInfo10_length , kSampleInfo10_frequency
		; Engine
		+MPlaySampleLoop 0 , 255 , kSampleInfo11_start , kSampleInfo11_length , kSampleInfo11_loopStart , kSampleInfo11_looplength , kSampleInfo11_frequency
	* Need a resource packing tool, probably using a variation on RLE, that will enable the C64 to send large streams of data for the hardware from the external RAM
		>> ResourceGenerator\main.py
		* Or just DMA everything from external RAM without compression as it's currently 318,475 bytes
		>> SendResourceData
	* Need to add HardwareTest_VideoPattern0 to Demo14 and also pass in an option to init Sprites4
		>> kHardwareTest_UsingSprites4 = 1
	* Done: kBus24Bit_Sprites4Planes_EBBS		= $04	; Note: Conflict with default Audio
		Could make this $05 since video now has exact address separation
		Update code to use kBus24Bit_Sprites4_MSBX and kBus24Bit_Sprites4_MSBY etc
		>> Schematic and layout updated
	* Need kHardwareTest_UsingMode7 = 1 support
		Like kHardwareTest_UsingSprites4
	* Done: Sea sprites to rotate with the landscape
		ObjectDraw6
		> Like the Render_EnemyPlaneHarrier generation, just create all the angle labels
		> Using landscapeRotationsFrame
	* Resource packer needs an option to include checksums of chunks of data at certain positions
		Variable length chunks, probably 64K default
		Start and end chunks checksums
		Full chunk checksum
		Variable length checksum
		>> To be included at a specific offset, or appended onto the end of the data?
			>> Appended
		>> python ResourceGenerator\main.py tmp/Demo14FinalData.bin checksum 0x10000 0x100 2 tmp/Demo14FinalData_Checksums.a
		> Add checks in the memory check stage
		>> This sent and verified checksums OK. Also the DMA chunk sending now works.
			cd /d C:\Work\C64\VideoHardware
			C:\Users\marti\Desktop\EF3\easytransfer-win32-1.2.0\easytransfer\ef3xfer.exe -x bin\main.cmp.prg
			python C:\Work\BombJack\UserPort20To32Bit2_DataSend.py tmp\Demo14FinalData.bin
	>> "C:\work\mame\mytest.exe" -window aburner2



* Demo14 : Separate the title screen palette (and its unique asstes) compared to the game and its unique assets.



* Demo14 : Update engine exhaust colours
	>> VBlankUpdateEngineColours




* Demo14: Landing on the runway and taking off from the runway sequence thoughts
	>> "C:\Users\marti\Videos\Captures\After Burner II [aburner2] - MAME 0.270 (LLP64) 2025-04-11 09-44-55.mp4"
		Time: 3:35 ...
	In the arcade the horizon is forced to be level, this means the runway (road) does not need to rotate
	The runway (road) has some horizontal colour stripes, plus some ground stripes that coincide with the ground
		Notice how the ground stripes immediately appear at 3:37 but the runway (road) comes in from the distance
		The near part of the runway as some ground sprites covering the start
	The top sky+cloud+ground layer can still be mode7 while below the level horizon the runway (road) can be a tile/chars layer that has priority behind the sprites but infront of the mode7 background
	The runway (road) lines and the width and start/end position can all be controlled by the APU a lot like the chequerboard ground in Demo9
	This can all be table driven updates (from python) to choose exactly the desired APU coordinates to pick from the chars/tile screen
	While landing the camera points down more and the horizon is very near (but not quite) the top of the screen
	Since there is no rotation, the entire sequence could be a table and the landscape draw can use a special case
	I think for each desired height the full landscape move sequence can be included, because there is no rotation.
	>> Look for landscape175Frames and how it is created by C:\Work\C64\VideoHardware\assets\Demo14\PerspectiveGen\main.py
		Note how it is referenced by landscapeRotations and how that table is referenced by LandscapeRender
		Expand this data creation to labels named landscapeHeight175Frames and redirect the offset into the hteight table then continue to call into near the start of LandscapeRender
			>> Note that because the horizon could move further up, potentially make the bottom vertical clip check larger
				playerYPositionOffset and PlayerPositionToForHorizonAndLandscape
				>> #50 and #-50 remove these magic numbers, the mid-point could definitely be altered by 100 inetad of 50
				When "diving" during normal game play the horizon reaches just below the top right screen box artificial horizon "radar"
				But when landing the horizon is above this nearer the top of the screen
		Create LandscapeRenderHeight to do this
	>> Consider the road could be scaled sprites instead of a char screen effect... Like Power Drift arcade. This would be easier than a raster line based APU effect
		>> Does not look good
			However "; Force runway area details into the landscape" can be used to add blank area for the runway and also runway related objects, like buildings trucks etc
	>> Before size: 1,225,254 Demo14FinalData.bin
		After size (64 to 128 height step 2 adjustment): 1,389,356 Demo14FinalData.bin
	>> Added this which recovers from any roll input and player X offset and lands the airplane:
		jsr InitGameLanding
		jsr RunGameLanding
	>> Note: ;	beq .gameToLanding
	* When the airplane is nearly landing and centered to the bottom of the screen, switch to special case rendering (like the carrier takeoff sequence) and scale down the airplane (and move it slightly up)?
		* Done: Add landing smoke?
			** ; TODO: Why does this allocation cause the special case rendered sprite to fail when the smoke gets large?
			>> Because the interface was not in direct write mode at all times after exiting the entity draw
		* Done: The takeoff can then reverse this special case sequence and then switch to real rendering
		* Done: Takeoff add slowly moving camera, the reverse of the landing slow moving camera.
	* For the runway check code: APUFloorLoop APULineScrolls in main9.a
		>> Note: APULineScrolls in APU.a
			>> And the maths needed to select specific rows: ;	!by <(-((.i-1)+15) + 0)	; Selects row 0, the empty line
		> APULineScrolls needs to be 16 bit values to account for the full range of selectable rows in the runway source screen
		>> ; Test for maths involved in processing the runway tables
	>> Coordinates need adjusting, see: PlayerPositionToForHorizonAndLandscape
	>> Added RunGameLanding_CalculateRunway which is nicely syncronised with the landscape and horizon
	* Need a way to synchronise the start and end of the runway to the landscape
		Proably by logging the Y screen position of a landscape object for the landing, and then the take-off
		>> ObjectDraw9 and ObjectDraw10 updates runwayMaxScreenRow and runwayMinScreenRow




* Demo14: Game palettes have reached the 16 limit
	> If each layer had the option of toggling the upper two bits of the output palette bank, by using a register similar to the priority register that uses two bits per layer
		it would be possible to have palettes for each layer, this would have one palette for the cloud, one for the tiles, one for the chars, and one for the sprites
		This would free up 2 palettes in the sprites layer
		It would also remove the dependency of the clouds/chars layer and make their conversion more stable
	> Different stages of the game could use different palettes with different enemies and different landscape
		There could be a small number of common enemies and landscapes (EnemyPlaneGreen and t-787 (water))
		>> e.g. Using: java -jar ..\..\..\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --palettesize 16 --onlyloadwholepalettes ..\tmp\Demo14ScaledSprites4Clouds.pal --forcergb 255 0 255 --forcergb 200 0 200 --forcergb 150 0 150 --forcergb 100 0 100 --nostacking --outputscaled4 ..\tmp\ScaledSprites4 --outputsprites ..\tmp\Demo14ScaledSprites4Sheet.txt --outputpalettes ..\tmp\Demo14ScaledSprites4.pal --batchimagequantize 16 --batchimages Demo14\PlayerAirplane\Level\*.png Demo14\PlayerAirplane\Left1\*.png Demo14\PlayerAirplane\Left2\*.png Demo14\PlayerAirplane\Left3\*.png Demo14\PlayerAirplane\*.png --resetforcergb --forcergb 255 0 255 --loadpaletteraw ..\tmp\Demo14TitleChars.pal --batchimages Demo14\EnemyPlaneGreen\*.png Demo14\EnemyPlaneGreen\Roll2\*.png Demo14\t-241.png Demo14\t-90.png --loadpalettebestfit ..\tmp\Demo14ScaledSprites4Clouds.pal --batchimages "Demo14\t-787.png" --writepass
			>> Gives 7 palettes
		>> Or using: java -jar ..\..\..\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --palettesize 16 --onlyloadwholepalettes ..\tmp\Demo14ScaledSprites4Clouds.pal --forcergb 255 0 255 --forcergb 200 0 200 --forcergb 150 0 150 --forcergb 100 0 100 --nostacking --outputscaled4 ..\tmp\ScaledSprites4 --outputsprites ..\tmp\Demo14ScaledSprites4Sheet.txt --outputpalettes ..\tmp\Demo14ScaledSprites4.pal --batchimagequantize 16 --batchimages Demo14\PlayerAirplane\Level\*.png Demo14\PlayerAirplane\Left1\*.png Demo14\PlayerAirplane\Left2\*.png Demo14\PlayerAirplane\Left3\*.png Demo14\PlayerAirplane\*.png --resetforcergb --forcergb 255 0 255 --loadpaletteraw ..\tmp\Demo14TitleChars.pal --batchimages Demo14\EnemyPlaneGreen\*.png Demo14\EnemyPlaneGreen\Roll2\*.png Demo14\t-241.png Demo14\t-90.png --loadpalettebestfit ..\tmp\Demo14ScaledSprites4Clouds.pal --batchimages "Demo14\t-787.png" "Demo14\t-576.png" "Demo14\t-934.png" --writepass
			>> Gives 9 palettes
		>> The second uses common enemy sprites, plus water plus brown and green bushes
		>> Would need to add some explosions as common game sprites
			>> Also perhaps the clouds landscape objects?
		>> Then map out landscape types and enemy types that can be used (there are 32 palette banks giving quite a lot of variation)
		>> Done: Instead of using palette banks for the ground colour change, the ground colour change can be applied to the active palette bank
			>> The LandscapeMapRowsData "palette bank" can be changed to update the palette directly from the ground palette
				>> Done: GamePaletteBank is renamed to be GroundColours and when changed from -1 will store the ground colours into the palette during the vsync then will reset it to be -1
			>> The landscape data can include a few enemy types that can be spawned during this section
			>> Done: The landscape data will need an extra real palette bank to use, which shares the landscape and the enemy palettes
				>> Can use: GamePaletteBank
				>> See: Demo14ScaledSprites4Game0.pal and Demo14ScaledSprites4Game1.pal
		>> This would provide even more variation in palettes
			> Title screen now uses palette $0f
		>> Note in some arcade game transitions between sections the horizon will be force moved off the bottom of the screen so the landscape is not visible
		>> If I was extra fancy, I could reserve palettes (zero based) 10-12 for the landscape and 13-15 for the enemies, given that 0-8 are common game + title + clouds palettes
			But that is quite complex conversion scripting work as specific palettes would need to be forced for specific objects/enemies and to avoid the enemy/landscape object palettes
		>> The landscape code that transitions between sections can delay the landscape transition while there are any "non-common" enemies active
			The common landscape objects, probably water and the two bushes, can then spawn common enemies and switch palettes at the end of the landscape section.
				The transition landscape section could also be shorter...
		>> It would be possible to make all palettes within the bank dynamic and cover them in, but this would make the sprite palette entry lookup much more expensive.
			Probably don't do this.
		>> The LandscapeMapRowsData should contain flags to trigger the landing etc
	* Done: Add cloud landscape sprite objects: "Demo14\t-14.png" "Demo14\t-14rot.png" "Demo14\t-42.png"
		>> ObjectDraw11




* Demo14: The canyon sprites, to shift the camera view part of the landing sequence could be used, the canyon does not rotate
	Like the rotation or height encoding (instead of height or rotation) there can be a more accurate shift lefts or right (8 frames) along with the 8 frames for the forward movement
	"C:\work\mame\mytest.exe" -window aburner2
	Stage 8 is canyon
	Then ImageMagick convert
	Then --shiftTopLeft --minimiseArea
	Then --removeDuplicates
	>> C:\work\c64\VideoHardware\assets\Demo14\Canyon
	>> ObjectDraw12 ObjectDraw13 ObjectDraw14 ObjectDraw15
	>> InitGameCanyon RunGameCanyon




* Demo14: Tidy resource code
	>> ExternalMemory.a




* Demo14: Landing and canyon triggered by landscape flag, not time
	* Done: LandscapeMapRowsDataOffset to become an address -> LandscapeMapRowsDataAddress
		>> LandscapeMapRowsDataSize changed to LandscapeMapRowsDataEnd
	* Done: LandscapeMapRowsData will need the flags
		>> See: kLandscapeMapRowsData_flags_*
	* LandscapeMapRowsData structure size and data offsets, probably from macro(s)
		Done: Remove magic numbers when referencing LandscapeMapRowsDataOffset and LandscapeMapRowsData
			See: kLandscapeMapRowsData_*




* Demo14: Player bullets
	The question is, to render them with scaled sprites
		And/or sort them with other game objects
	Or render them with normal sprites
	>> BulletsExplosions
		>> Demo14\BulletsExplosions\t-208.png Demo14\BulletsExplosions\t-793.png "Demo14\BulletsExplosions\t-231 - Copy.png" "Demo14\BulletsExplosions\t-231.png" "Demo14\BulletsExplosions\t-232 - Copy.png" "Demo14\BulletsExplosions\t-232.png" "Demo14\BulletsExplosions\t-258.png" "Demo14\BulletsExplosions\t-259.png"
		>> Bullets, reticle, bullet hit ground
	>> Bullets_landscapeRotationsFrame_to_animation EntityState_Bullets
	* Done: Move bullet start left/right/up/down depending on the player sprite screen position?
		Especially noticable when moving slowly and in the canyon
	* Done: Bullet horizontal and vertical velocity based on player bank/pitch
	* Done: Bullet collide with ground, remove entity
	* Done: Bullet ground explosion by changing the landscape ground to be an explosion frame, this is basically a new landscape object type, probably two for the frames
		>> ObjectDraw16
		* Which need to get removed
			>> Use EntityState_Bullets_HitGround
	* Done: Targeting reticle
		>> 	jsr RenderSpritePlayerReticle
	* Done: Limit the number of bullets currently active to 4/5



* Demo14: When diving the fire direction should impact the ground, to follow the reticle, at the moment it doesn't




* Animate: ObjectDraw16 with ObjectDraw17 and then removes the frame?
	Or maybe just alternate?



* Demo14: Landscape data can be under the IO space, since none of the landscape calculation code needs IO.
	Code as well since it does not access IO.
	>> UpdateLandscapeFrame and UpdateLandscapeFrameInternal




* Demo14: Sprite scale up values are a little off still. Note the large canyon rocks have spurious pixels at the bottom.
	Is it because the pixel start coordinate is half the scale?
	Check the maths, perhaps clamp the extent?
	>> !macro MGenerateSprite4ScaleTable



* Demo14: Frame rate compensation
	* This would need accurate NMI emulation, since Video_WaitVBlank uses CIA2InterruptControl = $dd0d
		>> com.loomcom.symon.Cpu#step()
		>> state.nmiAsserted
		>> com.loomcom.symon.Cpu#assertNmi
		>> case 0x10d:
			>> See main14.a : "; Test NMI Generated by video hardware"
				This disables the display, waits for fire, then shows the hardware test screen.
				On real harsware the NMI C64 border colour is visible only after the display shows an active display
				> Need to get this to work in emulation
				>> Only when com.loomcom.symon.devices.UserPortTo24BitAddress#CIA2InterruptControl = bits %10010000
				> Test code seems to work OK and is validated with real hardware
		> extEXTWANTIRQFlag only set if enableDisplay
	* Run the game logic routines at a 60 fps rate. If two frames have gone by since the last render run the game logic twice, etc.
	* Use an interrupt generated from the VSYNC signal to count the frames and also signal to the mainline to start.
		* This will need emulation updates and need testing on real hardware
	* The title screen rotating ball grid could also use this
	>> !macro MFrameCompensate_30fps_Before ~.labelBefore , .labelOver {
		!macro MFrameCompensate_30fps_After .labelBefore , ~.labelOver {




* Demo14: The end of the runway during the takeoff could be delayed a bit, the end building object
	Also clear a few rows beyond the last building object, to remvoe any tall trees. Add some small bushes or blank space.




* Memory is getting tight for a single load, but there is still space under the IO area
	Perhaps move the title screen (and maybe the carrier game intro) to under the IO and copy them into CodeOverlayStart
	>> Or utilise the external RAM expansion and have the biit plus title screen as one load, and then the game as another load.
	>> Created main14Title.a and main14Game.a and these are loaded from the external memory



* Optimise CommonFileCopyAndRunCode etc
	>> Assume start address, skip first two bytes, remove length calculation
	>> Optimise the end of file check
	>> Only use the processor port when copying to under $dxxx
	>> Only check high address value on copy option
		>> kExternalMemoryFiles_OnlyCheckHighAddress



* Demo14: Extract out "; Better APU setup, clear" and tidy the entry points of the title and game code considering it has already run the boot code
	>> Using APU_ResetDisableClear



* jmp $fd00 >> "; TODO: Magic number"
	Make this a common define
	>> Extract the common bus24/bus32 routine addresses and remove them from the other game files
		> Probably assemble the blob first, extract the labels (sed), create an include label file, include the binary blob in the boot
		> This avoids assembling the entire boot twice
		>> !source "tmp\CommonBootDefines.a" replaces Bus24Bit.a and Bus20To32Bit1.a
		>> !source "AfterBurner/CommonBootDefinesPre.a"



* Demo14: Move common build options to a separate file
	!source "main14Options.a"



* Demo14: Refueling aircraft sequence
	Stage 3/9 in the debug menu
	Stage 9 is better since it is refueling during the daytime, not nighttime palette
	assets\Demo14\Refuel\
	>> Don't seem to be able to extract the top portion of the refueling aircraft (engines and tail), probably due to them being clipped off the top of the screen.
		* Probably just use the extracted graphics of the bottom, hose, and wings right at the top of the screen
		>> Added: C:\Work\mame\src\mame\sega\sega16sp.cpp "// Add in calcHeight" : savedIndex ^= ((uint64_t)calcHeight) << 32;
			> This causes more sprites to be written, but does include the whole airplane graphics now
			> Updated --removeDuplicates to remove the smaller image (any sub-image)
	>> Debug_RunGameRefueling asm\AfterBurner\GameRefueling.a
	>> Suspend landscape map calculation while refueling sequence is active
		LandscapeMapRowsFreezeUpdates



* Demo14: Refueling aircraft sequence
	* Move the player aicraft up and over to the hose and back to the middle
	* When the tanker is large, stop drawing the side wings



* Demo14: Memory usage with varying options
	UsingMaxHardwareScaleTabValue = 255
	$190-$1ff:$70
	$c5e4-$cfff:$a1c
	$d236-$dfff:$dca
	$fbf9-$ffff:$407

	UsingMaxHardwareScaleTabValue = 220
	$190-$1ff:$70
	$b87e-$cfff:$1782
	$d236-$dfff:$dca
	$fb90-$ffff:$470

	UsingMaxHardwareScaleTabValue = 230
	$190-$1ff:$70
	$bc52-$cfff:$13ae
	$d236-$dfff:$dca
	$fbae-$ffff:$452




* Demo14: The canyon rock walls landscape objects should really be created by an algorithm that creates a deviating path
	* When the player dies the path opens up wide, observed in the arcade version
	* The path gets narrower and wider for difficulty, also observed in the arcade version
	* This removes the landscape objects from the random placement algorithm
	* Randomly created radio towers and objects outside of the canyon rock walls can then be removed
	** Also remove ground based objects just before and after the canyon pieces (to remove rendering issues with lower objects)
	>> ; Calculate the canyon walls
	>> Added ObjectDraw18





* Demo14: Landscape
	* List of enemy types to spawn in the section
	* List of enemy types that are allowed to exit from the section
		When wanting to exit, no new spawns unless they are in the exit list
			>> When kLandscapeMapRowsData_size is added to LandscapeMapRowsDataAddress
			> The and #$f0 needs to compare with an advancing $10 $20 $30 $40 etc if the exit condition check fails, otherwise the whole current landscape chunk will loop around and take too long?
		Then remove at least one enemy type from the common palette to make room for the explosions palette(s)
		Enemies that are local to a landscape should probably be first in the palette, this will allow the same enemies to be used in multiple landscapes, as long as their position in the palettes are the same
		>> Enemies could use dynamic palettes based on what enemies are active, since they are quicker and easier to update compared to the optimised landscape draw.
			But that would need careful palette management in the conversion pipeline. For example by reserving several palette slots in the same range.
		>> .enemyTypes
			Need mapping to a byte type for faster matching
		>> EntityFindFreeSlot
		>> EntityTypeIndex default = -1
		>> SpawnList_enemyTypesIndex is a list of 8 types that can be spawned, probability distribution, like the landscape map definition.
		>> LandscapeMapRowsData_EntityObjects
		>> ; Check active entity types for exit criteria
			>> LandscapeMapRowsData_EntityObjectsExit




* Demo14: TotalAPU_Size = $61c which is quite a large chunk of memory
	Consider moving game SetupAPU into Title
	>> The only value that game needs is APULineScrolls and APUData_Start?
	>> Then game could remove APU.a and move SetupAPU from game into title?
	>> And remove jsr OneTimeInit?
	>> Before:
		$cf1a-$cfff:$e6
		$d4b9-$dfff:$b47
		$fb81-$ffff:$47f
	>> After:
		$0-$1ff:$200
		$c84a-$cfff:$7b6
		$d4b9-$dfff:$b47
		$fb81-$ffff:$47f



* Demo14: EntitySystem.a : jsr Bus20To32Bit1_SetLatch8 ??!! Why is this being used instead of the macros, with state??




* Demo14: Titles can use very cut down game includes, and a small map that only uses shared common sprites
	>> !ifdef BuildTitleScreen {
	>> LandscapeMapDataDemo.a



* Demo14: Shooting the landscape should cause explosions
	Bullets done, certains buildings could do with larger explosions. There are animation frames for this available in assets\Demo14\BulletsExplosions
		>> .largeExplosion ObjectDraw19 ObjectDraw20 ObjectDraw21
	The canyon large vertical explosions, for the radio towers, (Canyon\t-1850 etc) currently use an extra palette, this would need some enemies removed from the common palettes
		>> ObjectDraw22 - ObjectDraw26
			>> .noCanyonCheckRadioTower
	The player and other landscape explosions also cause extra palettes, these will need some common palette savings, as above.



* Demo14: Title screen self playing game demo




* Demo14: Added extra samples



* Demo14: When exiting the canyon, the speed increase should only happen after the last canyon edge. In other words, wait for the whole level to cycle around
	>> .framesForEndTimeoutBeforeTakeOff



* Demo14: Proper enemy formations
	Update CheckSpawnEnemy so that it will trigger consistent enemy formations from LandscapeMapRowsData
	Probably needs a storage area that contains information of what to spawn and when.
	Process one entry per frame?
	>> Created CheckSpawnEnemyFormation and SpawnEnemy_* which can be filled in by the landscape map calculation
	>> Created LandscapeMapRowsData_Formation_WhenTypePos
	; TODO: Magic numbers



* Demo14: Count spawned enemies, stop too many from being spawned
	Currently it is possible for enemies to fill the entity list and to stop bullets being spawned
	Perhaps have a "EntityFindFreeSlot" that will not search the whole list and one that will search the whole list for bullets, smoke etc
		>> EntityFindFreeSlotEnemy




* Demo14: EntityState_Bullets with enemies
	Explosion frames, reuse existing large explosions.
	>> For "; Accumulate landscape rotation for the entity"
		Have a flag that enables rotation or not. If there isn't rotation then there is no need to have a large array of identical pointers.
			> Entities that would benefit are:
				WhiteSmoke_landscapeRotationsFrame_to_animation => Render_WhiteSmoke
				MissileForward_landscapeRotationsFrame_to_animation => Render_MissileForward
				Bullets_landscapeRotationsFrame_to_animation => Render_Bullets
		Before:
			$0-$1ff:$200
			$cb68-$cfff:$498
			$d5d3-$dfff:$a2d
			$fb89-$ffff:$477
		> EntityTypeIsRotating = 0 not rotating, any other value is rotating
		After:
			$0-$1ff:$200
			$c9f0-$cfff:$610
			$d5d3-$dfff:$a2d
			$fba7-$ffff:$459
		>> EntityTypeHi != 0 and EntityTypeIndex != -1 when the entity is an enemy
	>> After Render_ExplodeFlames0-4 and Render_ExplodeBall0-3
		$cc1e-$cfff:$3e2
	>> Can use EntityStateValue1 to count and switch the rendering to the other frames
		When the enemy is hit, remember to set EntityScaleTweak and EntityTypeIndex=-1 EntityTypeIsRotating=0 and set EntityStateHi to a suitable explosion handler
		>> EntityState_ExplodeFlames and EntityState_ExplodeBall
		>> $ccbe-$cfff:$342
	> Done: ; TODO: Proper position check
		>> ; Position check with enemy



* Not needed after OptimiseSprite4ScaleTables\main.py: Demo14: Labels with DivideTab seem to be wasting some memory?
	And clampToTwoTab



* Demo14: Missile lock on mechanic
	* When enemies render, the screen position needs to be saved to the entity
	* When the player reticle screen position is close to an enemy then the entity ID is added to a list of a certain number of lockons
	* If the entity ID dies, is not longer an enemy, it is removed from the lock on list
	* The lock list is rendered with player reticles, but perhaps bigger
	* When a missile is fired, it removes the first available entity ID from that lock list, the missle flies towards the enemy entity 3D position, if the enemy is an active entity ID
		>> EntityState_MissileForward
	>> EntityLastScreenXPos and EntityLastScreenYPos
	> 328/2 should be ScreenLandscapeOriginXPos
	>> jsr Game_RenderLockReticles
	* Done: Need a way to suppress output of unused scale tables, unless they are used by other sprites.
		For example: kVarsEmitSpriteFrame_t_328_0_0_0_tileWidthScaleTab kVarsEmitSpriteFrame_t_328_0_0_0_tileHeightScaleTab
		Also most of the player frames do not need scale tables, since the player is mostly drawn without scaling
		* Probably a process of the entire tables file
			Search for each label in source files
			Remove entries for labels, including their +MGenerateSprite4ScaleTable, if they are all not used
			If at least one label is used then don't remove?
			* Have one include for title and one for game, the lists of used assets is different
			> Perhaps comment out
			>> Before: $ce6e-$cfff:$192
			>> Using: OptimiseSprite4ScaleTables\main.py tmp\Demo14ScaledSprites4Sheet.txtTables.a tmp\Demo14ScaledSprites4SheetOptimised.txtTables.a asm\AfterBurner\*.a
			>> removedMacros  20
			>> After: $bda2-$cfff:$125e
	* Done: Game_RenderLockReticles only renders entity IDs in the locked list
	* Done: Add entity IDs to the lock list, if the player reticle has moved over the same area on the screen
		>> PlayerReticle_lastXPos , PlayerReticle_lastYPos
	* Done: Remove entity IDs from the lock list if they are not enemies



* Demo14: TODO: Need "lock" sample



* Demo14: After player explosion, new life the player should scale in from large to the expected player screen position, no player input during this
	.isComingFromBehindCamera




* Demo14: SortIndexTable moved to zeropage, for speed




* Demo14: Score display
	Image convertor, could do with saving out debug labels that represent what tiles/colours (non-transparent ones) are where at certain coordinates.
	This would make it easier to include extra data
	>> ; Init the score routine
	>> VBlankUpdateScore
	>> .testScore / .testScoreSpeed



* Demo14: ProcessSamplePlayTriggers rotate the channel used around 1-3 (0 is used for the engine)



* Demo14: Canyon wall collide
	* Explode the player
		Yes: "Demo14\BulletsExplosions\t-731.png" "Demo14\BulletsExplosions\t-300.png" 
		No: "Demo14\BulletsExplosions\t-509.png"  "Demo14\BulletsExplosions\t-514.png" "Demo14\Bull "Demo14\BulletsExplosions\t-528.png"etsExplosions\t-523.png" "Demo14\BulletsExplosions\t-365.png"
			Palette 1 and 4 are problems
		* Maybe reduce colours in the mode7 sky?
		* Maybe upgrade the video board to have a palette or value per layer?
			This would allow 256 colours, per layer, without raster based effects
			* Last two bits of the palete bank as xor value using 74ls86
			Two bits per layer, 8 bits in a new register, probably after the palette bank register
			>> Two options, source layer pass through these bits via the layer priority selector, more logic updates...
			>> Or other option use the final layer priority after the priority selector and use the bits from the register, much less logic...
				> Given we know the layer priority select, do we get much benefit from adding more logic to pass through these bits?
			* This would allow the sprites4 layer to use the upper 16 palettes, and the chars/tiles/mode7 to use the lower 16 palettes, basically by toggling the upper bit for sprites4
				>> A test conversion with game palette 1 (16 entries), by removing the --onlyloadwholepalettes ..\tmp\Demo14ScaledSprites4Clouds.pal and --loadpaletteraw ..\tmp\Demo14TitleChars.pal  and --loadpalettebestfit ..\tmp\Demo14ScaledSprites4Clouds.pal results in 14 palettes. This would be enough to include extra explosions.
			* This is more complex than first thought
				* The background register, if active, would assume top two bits as always the palette bank, or have its own two-xor bits register (or values elsewhere)
				* The PALBANK register will need to be selected without modification when writing, but can use the selected value when reading
		* Done: @TC-14 would need updating to support Sprites4 and Sprites V9.5, it supports Sprites2 at the moment
			>> Perfect: c:\work\BombJack\output\compareimagesForTestCase.bat 42 TC-14
		* @TC-14  Needs some background register checks, changing colours
			>> Given the display has palette layer expansion
			>> Video: PALLAYERA0/1 PALLAYERB0/1 PALLAYERC0/1 PALLAYERD0/1 PALLAYERZ0/1 (for background)
			>> c:\work\BombJack\output\compareimagesForTestCase.bat 67 TC-14
				Looks good
			>> kBus24Bit_VideoLayer_ExpandedPaletteLayer kBus24Bit_VideoLayer_PaletteLayers
			>> Video_SetAddressVideoPaletteLayersRegister
			>> Updated VBlankUpdatePaletteColours
			>> Checked game emulation with simulation, seems OK, including the engine colour changes
		* Done: Need to remove the extra chars/mode7 palette loads from the sprites conversions and save separate palettes
			Before:
				01/06/2025  08:17 pm                48 Demo14ScaledSprites4Clouds.pal
				01/06/2025  08:17 pm               480 Demo14ScaledSprites4Game0.pal
				01/06/2025  08:17 pm               512 Demo14ScaledSprites4Game1.pal
				01/06/2025  08:17 pm               512 Demo14ScaledSprites4Game2.pal
				01/06/2025  08:17 pm               480 Demo14ScaledSprites4Game3.pal
				01/06/2025  08:17 pm               512 Demo14ScaledSprites4Game4.pal
				01/06/2025  08:17 pm               288 Demo14ScaledSprites4TitleScreen.pal
				01/06/2025  08:17 pm                20 Demo14TitleChars.pal
			After:
				03/06/2025  11:10 am                48 Demo14ScaledSprites4Clouds.pal
				03/06/2025  11:10 am               416 Demo14ScaledSprites4Game0.pal
				03/06/2025  11:11 am               448 Demo14ScaledSprites4Game1.pal
				03/06/2025  11:11 am               448 Demo14ScaledSprites4Game2.pal
				03/06/2025  11:11 am               416 Demo14ScaledSprites4Game3.pal
				03/06/2025  11:11 am               448 Demo14ScaledSprites4Game4.pal
				03/06/2025  11:10 am                96 Demo14ScaledSprites4TitleScreen.pal
				03/06/2025  11:10 am               480 Demo14ScaledSprites4TitleScreenSprites.pal
	>> Added all the other explosions, now UsingMaxHardwareScaleTabValue = 220
	* Done: Reset the canyon walls to make them wide while exploding the player, to avoid the player escaping the canyon
		+MByteValueToAddress_A 0 , CanyonOffset
		+MByteValueToAddress_A 10 , CanyonWidth
	* Done: Player next life sequence, scale in player from large to normal and flash the player
		Use Player_Invulnerable?
	* Done: Need animating explosion entities, for the player death sequence
		A bit like the smoke trails, but their rotation frames can render different frames
		> Non-scaled version instead, special case for the player
			RenderSpritePlayerExplode0/1/2/3 and RenderSpritePlayerOtherExplosions



* Demo14: Enemy shoots missles
	The enemy missiles remember where the player was when launched
	If the missle hits the player (i.e. the player has not moved out of the way) then: jsr InitGamePlayerExplode
	* Done: ; TODO: Player collision



* Demo14: Canyon, perhaps flag an output of two walls, if the offset or the offset+width change?
	>> CanyonDoubleWallRight CanyonDoubleWallLeft



* Demo14: Wall difference check only > or < depending on side




* Demo14: Enemies in the far distance (just after spawning) should probably stay there for a second or two, perhaps move them at the player landscape speed, to give time to react
	Then they can swoop in
	>> Using kEntity_MaxZPos instead, is slightly better
	> ; If the enemy is in the distance, then set it to approach slower



* Demo14: Enemy missiles can quickly dip down and left/right when fired (depending on X coord), then lock onto the player




* Demo14: Use two scaled sprite layers, each using their own palette layer
	Entities and landacape can be separated
	Some explosions might need to be made common by having them first in the sprite list, if the explosions are used in the landscape, for example if the player explodes into the ground
	Group mode7 and tiles into one combiner, since they share a palette layer. Chars have to be on a separate layer for sprite priority.
	Then the mode7 and chars would need scrolling one pixel to the left, verify with before/after screenshots of the landing sequence
	>> Currently the title screen is on palette 0x0f, this would need to be palette 0x07 to allow the second sprite layer to use 0x08 as well as the other sprite layer using 0x10
	>> Don't forget the other sprites4 layer bank select needs to be set when sending sprite data
	>> In theory both layers can have their own sprite data...
	* Palette tests with game palette 0: Normally 15 palettes
		Mostly just landscape, plus some common sprites: 10 palettes
			java -jar ..\..\..\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --palettesize 16 --nostacking --outputpalettes ..\tmp\Demo14ScaledSprites4Game0.pal --resetforcergb %FORCERGB_COMMON_2% %SPRITES_COMMON_3% %SPRITES_GAME_LANDSCAPE_PALETTE_0% --writepass
		Just player and enemies and common sprites: 6 palettes
			java -jar ..\..\..\ImageToBitplane\target\imagetobitplane-1.0-SNAPSHOT-jar-with-dependencies.jar --rgbshift 5 6 5 --newpalettes --palettesize 16 %FORCERGB_COMMON_1% --nostacking --outputpalettes ..\tmp\Demo14ScaledSprites4Game0.pal %SPRITES_COMMON_1% --resetforcergb %FORCERGB_COMMON_2% %SPRITES_COMMON_2% %SPRITES_ENEMY_1% %SPRITES_ENEMY_2% --writepass
		>> So splitting the sprite layers does generate quite a lot of possibilities, even if the player+enemies palettes are potentially merged into one constant palette and the landscape palettes are still variable
		>> It would allow, for example, different coloured smoke trails, more enemies that are shared across landscape types etc
	>> Code now uses both sprite layers, palettes in the conversion bat need optimising though. Also move the palette layer bat to the normal bat.
	>> Palette bank separation work, for sprites4 layers 1 and 2...
		> Before:
			 48 Demo14ScaledSprites4Clouds.pal
			480 Demo14ScaledSprites4Game0.pal
			512 Demo14ScaledSprites4Game1.pal
			512 Demo14ScaledSprites4Game2.pal
			480 Demo14ScaledSprites4Game3.pal
			512 Demo14ScaledSprites4Game4.pal
			160 Demo14ScaledSprites4TitleScreen.pal
			224 Demo14ScaledSprites4TitleScreenSprites.pal
	>> Moved common landscape graphics from SPRITES_COMMON_3 to SPRITES_GAME_LANDSCAPE_COMMON
	>> Created new Demo14ScaledSprites4GameEntity0.pal
		> After is a lot better!:
			 48 Demo14ScaledSprites4Clouds.pal
			256 Demo14ScaledSprites4Game0.pal
			288 Demo14ScaledSprites4Game1.pal
			352 Demo14ScaledSprites4Game2.pal
			256 Demo14ScaledSprites4Game3.pal
			288 Demo14ScaledSprites4Game4.pal
			256 Demo14ScaledSprites4GameEntity0.pal
			160 Demo14ScaledSprites4TitleScreen.pal
			224 Demo14ScaledSprites4TitleScreenSprites.pal



* Demo14: When invulnerable and the player sprite is flashing off, it stays off when landing/taking off, probably during refueling as well. It shouldn't.
	Also the player cannot be hit by missiles during refueling and landing :)



* Demo14: Try different colour smoke...
		t-279.png uses one extra palette, so no...
		Same with the other colour smokes.
	Demo14\t-241.png Demo14\t-104.png Demo14\t-113.png Demo14\t-279.png
	>> Render_WhiteSmoke2/3/4 and EntityState_RemoveAfterForSmoke




* Demo14: >> t-1145.png ObjectDraw7 Small buildings



* "C:\work\mame\mytest.exe" -wavwrite c:\temp\aburner.wav -window aburner2



* Demo14: Video test pattern needs to init the palette bank layers



* Demo14: Done: Now the palette usage is low again, use the real enemy missile sprite
		>> t-177.png
	Also add different coloured smoke
		Darker colour at the missile to lighter colour. Perhaps use the timeout value to change the colours.




* Demo14: Testing new sprites4 board with old video board
	c64vh
	C:\Users\marti\Desktop\EF3\easytransfer-win32-1.2.0\easytransfer\ef3xfer.exe -x bin\Demo14V10.0main.cmp.prg
	python C:\Work\BombJack\UserPort20To32Bit2_DataSend.py bin\Demo14V10.0Demo14FinalData.bin


* Demo14: memory saving.
	* Add option to remove self modifying code from the sort, this will reduce the self modifying tables and related code and allow thr sort to be under the IO easily.
	* Move sort code to under the IO space.
		>> Before:
			$cf1e-$cfff:$e2
			$d6bf-$dfff:$941
			$fa70-$ffff:$590
		>> After:
			$cc9a-$cfff:$366
			$d95b-$dfff:$6a5
			$fa70-$ffff:$590



* Demo14: GameIntro memory saving by reducing tables used?
	Also check the title screen tables are not included in the game build
	Before:
		$cdd2-$cfff:$22e
		$d95b-$dfff:$6a5
		$fa7a-$ffff:$586
	After:
		$c643-$cfff:$9bd
		$d95b-$dfff:$6a5
		$fa7a-$ffff:$586




* Demo14: Game over sprites can replace the player palette
	Since the player is not visible. This might mean uploading a new palette and restoring from a backup.
		Or using a new range of palette banks just for the game over part
	Fade the palettes to be darker?
		Can fade a smaller range of colours per frame...
	>> Moved sprites to assets GameOver directory and added to SPRITES_COMMON_3, one more palette used in the entity palette
	>> A bit like .gameToRefueling
	* Demo14: Game Over needs to handle the canyon render




* Demo14: Lives
	A couple of support routines to flag drawing a character, or two, at certain addresses
	>> VBlankUpdateCharAtFlag etc



* Demo14: Final carrier landing
	Game complete sequence
	>> InitGameComplete
	>> GameCompleteStageNumber



* Demo14: Player speed/throttle can use a sprite in the entity layer and just change the width, without scale
	Will need the precise graphic from the game when at full throttle
	>> SpeedDisplayRenderSpritesDirectMode




* Demo14: Radar
	>> RadarDisplayRenderSpritesDirectMode and calculateRadar in python code



* Demo14: Game complete, level out first, then do not alter the carrier Y offset from a large positive value...



* Demo14: Mission complete sprite
	>> MissionCompleteDisplayRenderSpritesDirectMode




* Demo14: Revisit the potential to round up sprites4 width and height during conversion to reduce the number of sprite width/height scale tables needed
	Gauge render performance versus memory saving.
	While C64 main RAM is very tight, sprite RAM is actually only currently half full.
	>> But just blindly rounding up sprite sizes if they don't have any neighbouring values is wasteful of drawing performance
	* A better way is to run the conversion passes, generate the optimised table list based on the code, and then generate an allowed list of sizes based on what is finally used
		If there are no adjacent sizes, then don't consider them.
		Then there would have to be a second conversion and build pass which uses those allowed sizes
		The best place for that allowed list generation is in OptimiseSprite4ScaleTables, which can prioritise references in the code
	>> ImageToBitplane: allowedSizes and altered setupInputImage()
	>> --allowedSizesClear --allowedSizesFileAdd "C:\Work\C64\VideoHardware\tmp\Demo14ScaledSprites4SheetOptimised.txtTables.allowed.txt"
	* Will need to add sizes for the UI elements, that rely on fixed sizes without scale table references...
		>> --allowedSizesClear --allowedSizesFileAdd "Demo14\more allowed sizes.txt" --allowedSizesFileAdd ..\tmp\Demo14ScaledSprites4SheetOptimised.txtTables.allowed.txt
	>> Before:
		$cd83-$cfff:$027d
		$da7b-$dfff:$0585
		$fbe7-$ffff:$0419
		62,545 ScaledSprites4.bin7
	>> After:
		$b37a-$cfff:$1c86
		$da7b-$dfff:$0585
		$fbe7-$ffff:$0419
		3,168 ScaledSprites4.bin8
	>> There are mostly minor expected differences in the output



* Demo14: Stage 4 bomber aircraft
	del "C:\temp\afterburnerarcade\*.png" &&  C:\Downloads\ImageMagick-7.0.7-4-portable-Q16-x64\convert.exe -verbose -size "512x256" -depth 8 rgb:c:\temp\t.raw "C:\temp\afterburnerarcade\bomber.png"
	>> $b9f7-$cfff:$1609




* Demo14: As RadarDisplayRender_radarSprite* start to enter the range $dd00 (CIA2) the radar start to display bad frames.
	This is worrying because the ZPProcessorPort setting should not be allowing writes to the RAM underneath the IO...
	Is this because the copy to RAM is not working, or is this because the code is corrupting this data during the game?
	>> C1AF  AE 80 62 LDX $6280 >(2B 00 0A 05)<          56: 	ldx landscapeRotationsFrame
		DBF0 :  C0 80 C0 80 80 00 00 80   00 C0 40 40 C0 C0 C0 C0
		>> DC00 :  1F 10 C0 C0 C0 C0 C0 C0   C0 80 00 00 40 40 40 40
		DC10 :  00 40 00 00 00 40 00 40   40 C0 C0 40 00 5F 79 65	
	>> The two bytes at $dc00 $dc01 are wrong, when did they get corrupted?
	>> I suspect machine.getBus().write(0xdc00, joystickBits); and the other more general cases "machine.getBus().write(0xdc"
		> It was this, needed to add processor port handling and explicit writes to the IO



* Demo14: River, like the hills special case flag, the river can have a similar update but adds water tiles...
	Vary the width a bit and wiggle it, perhaps have two paths that wiggle
	>> LandscapeMapAddRiver



* Demo14: Enemies that are facing forward should really come from behind the player, zoom forward for a bit ignoring player speed, roll left/right, then fall back to the regular handler
	EntityInit_EnemyFromBehind




* Demo14: Smaller sprite timeout graphics




* Demo14: Music_Play2 Music_Play3 Music_Play6 Music_GameChoice




* Demo14: Track the current music time, initiate a fade out just before the end, then start a new piece of music when the stage changes using Music_GameChoice
	>> Music_CheckTime



* Demo14: Stage 4 bomber aircraft
	Optional roll left or right, or fly straight, needed for formation
	> Maybe the upper bits of th enemy type can index (shifted down) into a tick function to assign to the entity?
	> I think just expand the types because some enemy types don't make sense with roll left/right, some will need animation (helicopters)



* Demo14: Reduce size of MExternalMemoryFiles_CopyRunFileFromExternalMemory
	* And remove the need for "-$100 because of kExternalMemoryFiles_OnlyCheckHighAddress"
		$cd41-$cfff:$02bf
		$dfdc-$dfff:$0024
		$fcab-$ffff:$0355



* Demo14: Exponential score related to speed
	0 <= landscapeFrameSpeed <= 7
	ScoreAdd_Units rename ScoreAdd_Speed



* Demo14: Start of game, first stages, should be quite easy, very few enemy missiles. Not that rapidly firing, etc.
	Each stage gets a bit harder, more enemy missles, faster firing etc.
	More spawned enemies etc
	Need to count active enemy missiles
		>> EntityState_EnemyShootMissleAfter
			>> Render_MissileFacing
		EnemyMissileCount !by 0
		MaxEnemyMissiles !by 0
		>> EnemyMissilesRecycleSpeed
	Note: SpawnList_enemyTypesIndex used by CheckSpawnEnemy indexing into EntityType_DrawAddress
	Note: jsr EntityInit_EnemyShootMissleAfter is currently being used as a common entity init function
		>> EntityType_InitAddressLo/EntityType_InitAddressHi
	* There is quite a lot of duplicate common code for .gotFreeSlot1 and .gotFreeSlot2, the init function can set much of this with a common utility function...
		>> SpawnEnemyCommonInit
	>> EntityInit_EnemyChoose and EntityInit_EnemyChooseOnlyRoll
	* Choose near or far, part of the init routine



* Demo14: Normalise speed to 3 when not in canyon
	>> PlayerSpeedDecrease PlayerSpeedIncrease
	>> PlayerSpeedNormaliseCheck



* Demo14: memory saving.
	* Entity update code, move to under the IO
		> This will need all entity updates to avoid IO access, for example sample playing
	>> Entity sort instead




* Demo14: Stage should not advance if it is "game over", or if the player is exploding.
	RunGameLanding_CommonFrame_GameOver check



* Demo14: Sometimes choose the "Fire!" sample



* Demo14: Mission complete uses char screen scrolls to show pictures, perhaps these could smooth scroll? With acceleration?
	>> Debug_RunMissionCompletePictures
		.targetXPosNext* .targetYPosNext* .targetTimeNext



* Demo14: Hand lag...
	Perhaps maintain a hand X/Y position from the hoystick input direction
	This could be a X/Y accumulated and clamped pos/neg range so that the hand displays left/middle/right between -4 to 4 ro something similar
	This would probably be better than following the plane...




* Demo14: Music assets into build release bat, then release a new SDK




* Demo14: Hiscore display and entry
	* Note how the "insert coin!" message flashes over the hiscore table as it scrolls up behind
		>> The "Best fighters" and the "score name hit rank" headers scroll up without horizontal movement
		>> Each row of the table has alternate horizontal movement
			This could be APU updated
		>> The radar/score/ammo/credit display is removed for this part
		>> If the flashing "insert coin!" was a sprite this would mean the hiscore table can just be in the chars layer
			There is an spare chars screen (top right) that could be used for these hiscore table assets
			>> Don't make the "insert coin" message a sprite since the game sprite priority cannot be behind and infront of the score table
				Instead just don't flash the insert coin message until after the score table finishes scrolling.
		>> What is the maximum score? With cheats enabled? Auto kill all enemy? Maximum speed?
		>> The score table would be easier with two chars layers, but it is possible with one layer and APU splits.
	>> To aid the left/right scroll of the score table entries, the screen data for the entries has been shifted to the left. To give extra empty space to the left and right.
	>> Also had to move the score table entries down one row, to aid in the software raster split. This avoids having to use complicated APU updates.
	>> C64\VideoHardware\asm\AfterBurner\ScoreTable.a	InitScoreTable RunScoreTable



* Demo14: Hiscore entry
	* Done: Move score and total hits into lower stack, which should be safe from any game data
		>> GameScore_Value and GameTotalHits
		>> Also removed the jsr InitialiseMachine from title and game, it's really not needed since main14.a does this
		>> Also stopped the engine sound when landing for mission complete
	* Need to restore the correct characters and screens after mission complete
	* Title screen start will need to check if hiscore entry is needed
		>> mainLoop_backToTitleScreen no longer disables layers, because any hiscore entry will need the game displayed in the background
		>> CheckAndRunHiScoreScoreTableEntry
		* Find the score position
			* Need default score table data in a suitable format, probably in the external RAM
				>> AfterBurner\ScoreTableData.a
				>> resourceFileOffset_ScoreTableData_bin resourceFileSize_ScoreTableData_bin
				>> kGameScore_Value_size GameName_size GameTotalHits_size
	; Done: Try to find a suitable position
	; Done: Shift entries down...
	; Done: Write new score and hit with '=' for the name...

	; In init...
	; Done: Render the current score table data into the screen
		>> Colour first, with highlight test
	* Done: Fade music
	* Done: Highlight the character to place
	* Not done: Flash to yellow in score table
	* Done: Place
	* Done: After last place, go to end
	* Done: or erase
	* Done: or end
	; At end...
	; Done: Write back score data to the external RAM



* Demo14: Animated hand and the mission complete screen could both use characters.
	There are two options, use one char layer and don't display the score/status etc. Or add the other chars layer with the spare combiner.
		The arcade has 17 tile map layers! :)
	>> Done: c64\VideoHardware\assets\Demo14\MissionComplete
		>> c:\work\mame\mytest.exe -window -debug aburner2
			Select last stage
		>> Note in the arcade when displaying the ending pictures the score/status/hud is actually not displayed
			This means it is not necessary to add a second chars layer for that
			>> c64\VideoHardware\assets\Demo14\MissionComplete
		>> Since these palettes are very empty, the screens can just be added 192 Demo14ScaledSprites4TitleScreen.pal 256 Demo14ScaledSprites4TitleScreenSprites.pal
			>> Specifically Demo14ScaledSprites4TitleScreen.pal and intermediate Demo14TitleChars.pal
		>> C:\Work\C64\VideoHardware\asm\main14MissionComplete.a
		>> Debug_RunMissionCompletePictures
	>> Done: Hand is displayed on a separate screen with the other chars screen active
		>> c64\VideoHardware\assets\Demo14\Hand
		>> Since the Demo14ScaledSprites4GameEntity0.pal is 448 bytes, and we are probably not going to add any more enemy sprites due to main RAM limits, the hand can be added to the entities, like the game over sprites
		>> RenderHand TitleFramesTimeout



* Demo14: Stages
	* Done: Add some more game map data
	* Done: Add a "start stage" flag, which triggers the stage increment
		>> kLandscapeMapRowsData_flags_doStage
	* Done: Stage text
		Adding 8x16 charset pushes the Demo14FinalData.bin file over 2MB, so Demo14FileResources.bin is not included for now
		TODO: Need to split the Demo14FileResources.bin resource sending in main14.a
	* Done: Ready text
		>> Observing: 01:09, After death and during the invulnerable player scale in, there is a rapidly flashing yellow "ready", the Y is one char to the left of the stage units number
	* Done: Stage bonus text, recording... Figure out mame monitor command to inject suitable text?
		>> Find "8x16 charset" in TODO/Done.txt
		"HIT COUNTS  2" Decreases the "hit" number display on a stage. The "1" aligns with the right hand score number
		"POINTS  20000" "C:\Users\marti\Pictures\Screenshots\Screenshot 2025-08-03 164534.png"
		* Done: Would need hit counter...
		>> MTextUpdatesDeltaProcess8x16
			>> Text_Hits_Pos TextAddHitNumber
			>> TextResetHits
	* Done: The refueling weapons indicator only happens during the landing or refueling state
		Observing: 01:39 light green text "reload weapons" flashing a bit rapidly just above the 8x16 "stage" text, starts two chars to the left.
			Will need extra light green colour
	* Refueling sound effect?
	* Done: Stage sound effect
		TriggerSamplePlay_Ping
		Note the ping sound in the arcade doesn't use samples, so mame with -wavwrite was needed so capture the sound.
		This was then imported into MilkyTracker, the wav imported, the sound effect highlighted and the crop function used
		The sample was then significantly downsampled to make it a similar byte size compared to the shorter sounds effects, so prefer more quality for the voices.
	* Done: 8x8 stage indicator
	* The game screen init can be in the title screen
	* IncludeVBlankUpdateTextColours moves the game screen init to the title screen code



* Demo14: Get Demo14 running on real hardware again:
	>> Will need to split the boot data into at least two chunks...
		> CheckForHWData CheckForGameData
			c64vh
			python C:\Work\BombJack\UserPort20To32Bit2_DataSend.py tmp\Demo14FileResources_ForHW1.bin
			C:\Users\marti\Desktop\EF3\easytransfer-win32-1.2.0\easytransfer\ef3xfer.exe -x bin\main.cmp.prg
			python C:\Work\BombJack\UserPort20To32Bit2_DataSend.py tmp\Demo14FinalData.bin
	>> The mission complete data DMA for resourceFileOffset_ResourcesMissionComplete works on real hardware, with the APU_ResetDisableClear and "; Only show the clouds, not the tiles"
	>> The hiscore table scroll with raster splits also works, MScoreTableEntryUpdate



* Demo14: Hiscore entry and display, perhaps fade or darken the palettes for the currently chosen palette bank for the two sprites layers and the sky?
	> This leaves the title screen tiles alone.
	> This would mean having all the palettes in the expansion RAM
	> Plus some quite complicated code to extract, darken, and merge back palettes...
	>> GamePaletteBank is now a preserved variable
	>> RunPaletteFade PaletteFade_Restore



* Demo14: Hiscore entry and display, perhaps fade or darken the palettes for the currently chosen palette bank for the two sprites layers and the sky?
	>> Sky and landscape palette, precise RGB values, will need to use whatever the current game data is...
	>> RunPaletteFade



* Demo14: Mission Complete needs to restore the correct characters...
	>> resourceFileOffset_ResourcesMissionCompleteRestore



* Demo14: Player clipped wing death, small explosion, smoke trail, hit ground, fireballs... No player input during this time.
	> Perhaps reuse the code in C64\VideoHardware\asm\AfterBurner\GamePlayerExplode.a
	> Don't increment GamePlayerExplode_ExplodeFrame (avoid large explosions and animating player explosion frames)
	> inc TriggerSamplePlay_Explosion1 at start
	> Spawn smoke often and sometimes explosion entities
	> Tile landscape camera down
	> Then push explosion landscape objects into the distance from the position
	> With TriggerSamplePlay_Explosion1/2/3
	> Maybe bank player left/right/up/down
	>> GamePlayerExplode_Winged
	>> CommonMissle_doSmokeForPlayerWinged
	>> Maybe GamePlayerExplode_Winged can be used to display different roll animations...
	>> Produces a nice trailing of explosions in the smoke.
	>> Adjust for explosion frame at start hit.
